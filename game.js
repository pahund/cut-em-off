!function(){"use strict";var e=new class{constructor(){this.subscribers=[]}subscribe(e,t){this.subscribers.push({message:e,callback:t})}reset(e,t=null){this.subscribers=this.subscribers.filter(({message:t})=>t!==e),t&&this.subscribe(e,t)}publish(e,t){this.subscribers.forEach(({message:r,callback:o})=>r===e&&o(t))}};const t=0,r=1,o=6,s=7,n=2,i=4;const a=new function(){let e,t,r,o,s,n,i,a,l,c,h,d;this._params=new function(){this.setSettings=function(e){for(let t=0;t<24;t++)this[String.fromCharCode(97+t)]=e[t]||0;this.c<.01&&(this.c=.01);const t=this.b+this.c+this.e;if(t<.18){const e=.18/t;this.b*=e,this.c*=e,this.e*=e}}},this.reset=function(){const e=this._params;o=100/(e.f*e.f+.001),s=100/(e.g*e.g+.001),n=1-e.h*e.h*e.h*.01,i=-e.i*e.i*e.i*1e-6,e.a||(h=.5-e.n/2,d=5e-5*-e.o),a=e.l>0?1-e.l*e.l*.9:1+e.l*e.l*10,l=0,c=1==e.m?0:(1-e.m)*(1-e.m)*2e4+32},this.totalReset=function(){this.reset();const o=this._params;return e=o.b*o.b*1e5,t=o.c*o.c*1e5,r=o.e*o.e*1e5+10,e+t+r|0},this.synthWave=function(p,u){const m=this._params,f=1!=m.s||m.v;let w=m.v*m.v*.1;const g=1+3e-4*m.w;let b=m.s*m.s*m.s*.1;const y=1+1e-4*m.t,x=1!=m.s,v=m.x*m.x,k=m.g,T=m.q||m.r,S=m.r*m.r*m.r*.2;let M=m.q*m.q*(m.q<0?-1020:1020);const Y=m.p?32+((1-m.p)*(1-m.p)*2e4|0):0,X=m.d,A=m.j/2,D=m.k*m.k*.01,E=m.a;let C=e;const L=1/e,P=1/t,R=1/r;let W=5/(1+m.u*m.u*20)*(.01+b);W>.8&&(W=.8),W=1-W;let B,O,I,G,$=!1,H=0,z=0,N=0,_=0,q=0,j=0,F=0,U=0,J=0;var K,Q;let V=0;const Z=new Array(1024),ee=new Array(32);for(var te=Z.length;te--;)Z[te]=0;for(te=ee.length;te--;)ee[te]=2*Math.random()-1;for(te=0;te<u;te++){if($)return te;if(Y&&++J>=Y&&(J=0,this.reset()),c&&++l>=c&&(c=0,o*=a),(o*=n+=i)>s&&(o=s,k>0&&($=!0)),O=o,A>0&&(V+=D,O*=1+Math.sin(V)*A),(O|=0)<8&&(O=8),E||((h+=d)<0?h=0:h>.5&&(h=.5)),++z>C)switch(z=0,++H){case 1:C=t;break;case 2:C=r}switch(H){case 0:N=z*L;break;case 1:N=1+2*(1-z*P)*X;break;case 2:N=1-z*R;break;case 3:N=0,$=!0}T&&((I=0|(M+=S))<0?I=-I:I>1023&&(I=1023)),f&&g&&((w*=g)<1e-5?w=1e-5:w>.1&&(w=.1)),Q=0;for(let e=8;e--;){if(++F>=O&&(F%=O,3==E))for(let e=ee.length;e--;)ee[e]=2*Math.random()-1;switch(E){case 0:K=F/O<h?.5:-.5;break;case 1:K=1-F/O*2;break;case 2:K=(K=(G=(G=F/O)>.5?6.28318531*(G-1):6.28318531*G)<0?1.27323954*G+.405284735*G*G:1.27323954*G-.405284735*G*G)<0?.225*(K*-K-K)+K:.225*(K*K-K)+K;break;case 3:K=ee[Math.abs(32*F/O|0)]}f&&(B=j,(b*=y)<0?b=0:b>.1&&(b=.1),x?(q+=(K-j)*b,q*=W):(j=K,q=0),_+=(j+=q)-B,K=_*=1-w),T&&(Z[U%1024]=K,K+=Z[(U-I+1024)%1024],U++),Q+=K}Q*=.125*N*v,p[te]=Q>=1?32767:Q<=-1?-32768:32767*Q|0}return u}};function l(e){a._params.setSettings(e);const t=a.totalReset(),r=new Uint8Array(4*((t+1)/2|0)+44);let o=2*a.synthWave(new Uint16Array(r.buffer,44),t);const s=new Uint32Array(r.buffer,0,44);s[0]=1179011410,s[1]=o+36,s[2]=1163280727,s[3]=544501094,s[4]=16,s[5]=65537,s[6]=44100,s[7]=88200,s[8]=1048578,s[9]=1635017060,s[10]=o,o+=44;let n=0;const i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";let l="data:audio/wav;base64,";for(;n<o;n+=3){const e=r[n]<<16|r[n+1]<<8|r[n+2];l+=i[e>>18]+i[e>>12&63]+i[e>>6&63]+i[63&e]}return n-=o,l.slice(0,l.length-n)+"==".slice(0,n)}function c(){var e;this.sounds={},(e=this).add("infected",3,[[2,,.2916,,.2587,.9356,.3909,-.2493,,,,,,.3583,.1617,,,,1,,,.1217,,.5]]),e.add("drop-bomb",3,[[0,,.0641,.5296,.1228,.4195,,,,,,.3029,.6261,,,,,,1,,,,,.5]]),e.add("drop-ship",1,[[0,,.57,,.1398,.61,,-.26,.1,,,.02,,.3325,,,,,.9793,,,,,.5]]),e.add("explode",3,[[3,,.1606,.5988,.2957,.1157,,-.3921,,,,,,,,,.3225,-.2522,1,,,,,.25]])}c.prototype.add=function(e,t,r){this.sounds[e]=[],r.forEach(function(r,o){this.sounds[e].push({tick:0,count:t,pool:[]});for(let s=0;s<t;s++){const t=new Audio;t.src=l(r),this.sounds[e][o].pool.push(t)}},this)},c.prototype.play=function(e){const t=this.sounds[e],r=t.length>1?t[Math.floor(Math.random()*t.length)]:t[0];r.pool[r.tick].play(),r.tick<r.count-1?r.tick++:r.tick=0};const h=new c;const d=1e3,p="#75a042";var u=(e,{row:t,col:r})=>{const{x:o,y:s}=e.getXAndY({row:t,col:r});return{context:kontra.context,x:o,y:s,collisionRadius:30,fuseLength:100,status:m,shrapnel:[],explosionDuration:0,map:e,mapX:100*r,mapY:100*t,row:t,col:r,update(){({status:this.status,fuseLength:this.fuseLength,explosionDuration:this.explosionDuration,x:this.x,y:this.y}=O(this))},render(){w(this)}}};const m=0,f=2;var w=e=>{const{status:t,shrapnel:r}=e;switch(t){case m:L(e);break;case 1:r.forEach(e=>e.render())}},g=({col:e,row:t})=>({sx:100*e-400+50,sy:100*t-300+50});const b="N",y="E",x="S",v="W";var k=(e,{x:t,y:r},o)=>{const s=e.tileAtLayer("main",{x:t,y:r});if(!C(s)||!S[s].allowed.includes(o))return!1;const n=Y(e,{x:t,y:r},o);return C(n)},T=(e,{x:t,y:r},o)=>{const s=e.tileAtLayer("main",{x:t,y:r});if(!C(s))throw new Error("dropped");const n=S[s].change[o]||o;if(k(e,{x:t,y:r},n))return n;const i=S[s].allowed.filter(o=>k(e,{x:t,y:r},o));switch(i.length){case 0:throw new Error("locked in");case 1:return i[0];default:return i[A(0,i.length-1)]}},S={1:{allowed:[x,y],change:{[b]:y,[v]:x}},2:{allowed:[v,x],change:{[b]:v,[y]:x}},3:{allowed:[b,x],change:{}},4:{allowed:[v,b,y],change:{[x]:b}},5:{allowed:[b,y,x],change:{[v]:y}},6:{allowed:[v,y,x],change:{[b]:x}},9:{allowed:[b,y],change:{[x]:y,[v]:b}},10:{allowed:[v,b],change:{[y]:b,[x]:v}},11:{allowed:[v,y],change:{}},12:{allowed:[b,y,x,v],change:{}},13:{allowed:[b,x,v],change:{[y]:v}},17:{allowed:[x],change:{[b]:x}},18:{allowed:[v],change:{[y]:v}},19:{allowed:[b],change:{[x]:b}},20:{allowed:[y],change:{[v]:y}}};const M=[];for(const[e,{allowed:t}]of Object.entries(S))t.length>2&&M.push(Number(e));var Y=(e,{x:t,y:r},o)=>e.tileAtLayer("main",{x:o===y?t+100:o===v?t-100:t,y:o===b?r-100:o===x?r+100:r}),X=e=>e*Math.PI/180,A=(e,t)=>{const r=Math.min(e,t),o=Math.max(e,t);return Math.floor(Math.random()*(o-r+1))+r},D=(e,t)=>{const r=[];for(let o=0;o<e.length;o++){const s=e[o];for(let e=0;e<t.length;e++){const o=t[e];E(s,o)&&r.push([s,o])}}return r},E=(e,t)=>{const r=e.x-t.x,o=e.y-t.y;return Math.sqrt(r*r+o*o)<e.collisionRadius+t.collisionRadius},C=e=>e>0&&e<25||e>30&&e<33||e>37&&e<41||e>44,L=e=>{const{context:t,x:r,y:o,fuseLength:s}=e;t.save(),t.translate(r,o),t.rotate(X(-45)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(23,-10),t.lineTo(40,-10),t.lineTo(40,10),t.lineTo(23,10),t.arc(0,0,25,X(19),X(341)),t.fill(),t.stroke();const n=s/100*90;t.beginPath(),t.moveTo(40,0),t.arc(40,25,25,X(270),X(270+n)),t.stroke();const i=25*Math.cos(X(n-90))+40,a=25*Math.sin(X(n-90))+25;t.fillStyle="#cd3926";for(let e=0;e<10;e++){const e=Math.cos(X(A(0,360)))*A(0,15)+i,r=Math.sin(X(A(0,360)))*A(0,15)+a;t.fillRect(e-1,r-1,3,3)}t.restore()};var P=new class{constructor(){this.servers=[]}init(e,t=[]){return this.map=e,t.forEach(({col:t,row:r})=>this.servers.push(R({map:e,row:r,col:t}))),this}update(){this.servers.forEach(e=>e.update())}render(){this.servers.forEach(e=>e.render())}destroy({col:e,row:t}){const r=this.find({col:e,row:t});r&&(r.broken=!0)}find({col:e,row:t}){return this.servers.find(r=>r.col===e&&r.row===t)}getRandom(){return this.servers.filter(e=>!e.broken)[0]}},R=({map:e,row:t,col:r})=>{const{x:o,y:s}=e.getXAndY({row:t,col:r});return{context:kontra.context,x:o,y:s,row:t,col:r,map:e,mapX:100*r,mapY:100*t,broken:!1,update(){({x:this.x,y:this.y}=e.getXAndY({mapX:this.mapX,mapY:this.mapY}))},render(){B(this)}}},W=(e,t)=>t.forEach(([t,r,o])=>e[t?"lineTo":"moveTo"](r,o)),B=e=>{const{context:t,x:r,y:o,broken:s}=e;t.save(),t.translate(r,o),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),W(t,[[0,30,-48],[1,48,-30],[1,48,30],[1,30,48],[1,-30,48],[1,-48,30],[1,-48,-30],[1,-30,-48],[1,30,-48]]),t.fill(),t.stroke(),s&&(t.lineWidth=2,W(t,[[0,10,-48],[1,0,-40],[0,24,-48],[1,20,-30],[0,48,-27],[1,20,-20],[0,-10,-30],[1,10,-30],[1,30,-10],[1,20,0],[1,10,0],[0,48,7],[1,30,10],[0,20,0],[1,30,10],[1,10,20],[0,30,48],[1,30,30],[1,10,30],[0,20,20],[1,20,30],[0,-10,48],[1,-10,20],[1,0,10],[0,-20,0],[1,-20,20],[1,-10,30],[0,-30,48],[1,-20,40],[1,-20,30],[0,-30,30],[1,-20,40],[0,-48,20],[1,-30,20],[0,-40,20],[1,-40,10],[0,-48,0],[1,-30,0],[1,-20,-10],[0,-40,0],[1,-30,10],[0,-48,-17],[1,-40,-30],[1,-30,-20],[0,-30,-48],[1,-10,-20],[1,-10,-10],[0,-20,-30],[1,-20,-20],[1,-30,-10]]),t.stroke()),t.restore()},O=t=>{let{status:r,fuseLength:s,explosionDuration:n,x:a,y:l}=t;const{shrapnel:c,map:h,mapX:d,mapY:p,row:u,col:w}=t;switch(({x:a,y:l}=h.getXAndY({mapX:d,mapY:p})),r){case m:if((s-=1)<0){r=1,e.publish(o);for(let e=0;e<50;e++)c.push(I({x:a,y:l}));if(P.find({row:u,col:w}))P.destroy({row:u,col:w});else{const t=h.tileAtLayer("main",{row:u,col:w});h.changeTile("main",{row:u,col:w},t+24),e.publish(3,h),e.publish(i)}}break;case 1:c.forEach(e=>e.update()),200===++n&&(r=f)}return{status:r,fuseLength:s,explosionDuration:n,x:a,y:l}},I=({x:e,y:t})=>{const r=A(0,360),o=A(5,15);return{context:kontra.context,x:e,y:t,dx:Math.cos(X(r))*o,dy:Math.sin(X(r))*o,rotation:A(0,360),rotationDir:[A(-10,-1),A(1,10)][A(0,1)],update(){this.x+=this.dx,this.y+=this.dy,this.rotation+=this.rotationDir},render(){(e=>{const{context:t,x:r,y:o,rotation:s}=e;t.save(),t.translate(r,o),t.rotate(X(s)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(0,-10),t.lineTo(10,5),t.lineTo(-10,5),t.closePath(),t.fill(),t.stroke(),t.restore()})(this)}}};class G{constructor(t){this.map=t,this.bombs=[],e.subscribe(r,e=>this.dropBomb(e))}dropBomb(e){this.bombs.length>0&&this.bombs.find(({col:t,row:r})=>t===e.col&&r===e.row)||this.bombs.push(u(this.map,e))}update(){this.bombs=this.bombs.filter(e=>(e.update(),e.status!==f))}render(){this.bombs.forEach(e=>e.render())}}var $=({map:t,player:r,virus:o,users:s,bombs:i})=>{let a=!0;return e.subscribe(n,()=>a=!1),kontra.gameLoop({update(){o.update(),r.update(),r.infect(o),r.teleport(),a&&(({map:e,direction:t,speed:r})=>{switch(t){case b:e.sy-=r;break;case y:e.sx+=r;break;case x:e.sy+=r;break;case v:e.sx-=r}})({map:t,...r}),s.update(),s.infect(o),i.update(),P.update()},render(){t.render(),s.render(),P.render(),i.render(),r.render(),o.render()}})};function H(e,t){return[Math.cos(X(e))*t+50,Math.sin(X(e))*t+50]}var z=({ctx:e,row:t,col:r,deg:o,broken:s=!1})=>{e.save(),e.translate(100*(r-1)+50,100*(t-1)+50),e.rotate(X(o)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),s?(e.moveTo(20,50),e.arc(50,50,30,X(180),X(190)),e.moveTo(...H(190,30)),e.lineTo(10,45),e.lineTo(10,35),e.lineTo(-10,40),e.lineTo(...H(190,70)),e.arc(50,50,70,X(190),X(180),!0),e.moveTo(50,20),e.arc(50,50,30,X(270),X(260),!0),e.moveTo(...H(260,30)),e.lineTo(40,10),e.lineTo(45,0),e.lineTo(35,0),e.lineTo(...H(260,70)),e.arc(50,50,70,X(260),X(270))):(e.moveTo(20,50),e.arc(50,50,30,X(180),X(270)),e.moveTo(-20,50),e.arc(50,50,70,X(180),X(270))),e.stroke(),e.restore()},N=({ctx:e,row:t,col:r,deg:o,broken:s=!1})=>{e.save(),e.translate(100*(r-1)+50,100*(t-1)+50),e.rotate(X(o)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),W(e,s?[[0,-20,50],[1,-20,30],[1,-10,40],[1,0,25],[1,10,35],[1,20,30],[1,20,50],[0,-20,-50],[1,-20,-40],[1,-10,-25],[1,0,-35],[1,10,-30],[1,20,-40],[1,20,-50]]:[[0,-20,-50],[1,-20,50],[0,20,-50],[1,20,50]]),e.stroke(),e.restore()},_=({ctx:e,row:t,col:r,deg:o,broken:s=!1})=>{e.save(),e.translate(100*(r-1)+50,100*(t-1)+50),e.rotate(X(o)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),W(e,s?[[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,50,20]]),e.stroke(),e.restore()},q=({ctx:e,row:t,col:r,broken:o=!1})=>{e.save(),e.translate(100*(r-1)+50,100*(t-1)+50),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),W(e,o?[[0,-20,50],[1,-20,45],[1,-10,40],[1,0,45],[1,10,35],[1,20,40],[1,20,50],[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,-20,20],[1,-20,50],[0,50,20],[1,20,20],[1,20,50]]),e.stroke(),e.restore()},j=({ctx:e,row:t,col:r,deg:o,broken:s=!1})=>{e.save(),e.translate(100*(r-1)+50,100*(t-1)+50),e.rotate(X(o)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),W(e,s?[[0,-20,50],[1,-20,40],[1,-10,45],[1,0,35],[1,10,45],[1,20,40],[1,20,50]]:[[0,-20,50],[1,-20,0],[1,20,0],[1,20,50]]),e.stroke(),e.restore()},F=(e={})=>{const t=e.width,r=e.height,o=e.tileWidth||32,s=e.tileHeight||32,n=t*o,i=r*s,a=e.context||kontra.context,l=a.canvas.width,c=a.canvas.height,h=document.createElement("canvas"),d=h.getContext("2d"),p=Math.max(0,n-l),u=Math.max(0,i-c);let m,f;const w=[],g={width:t,height:r,tileWidth:o,tileHeight:s,mapWidth:n,mapHeight:i,context:a,x:e.x||0,y:e.y||0,tilesets:[],layers:{},addTilesets:function(e){[].concat(e).forEach(e=>{const t=e.image;let r,n,i,a;if(`${t}`===t){let e=1/0;for(;e>=0;){const o=(e=t.lastIndexOf("/",e))<0?t:t.substr(e);if(kontra.assets.images[o]){r=kontra.assets.images[o];break}e--}}else r=t;n=e.firstGrid;const l=(r.width/o|0||1)*(r.height/s|0||1);n||(g.tilesets.length>0?(a=((i=g.tilesets[g.tilesets.length-1]).image.width/o|0)*(i.image.height/s|0),n=i.firstGrid+a):n=1),g.tilesets.push({firstGrid:n,lastGrid:n+l-1,image:r}),g.tilesets.sort((e,t)=>e.firstGrid-t.firstGrid)})},addLayers:function(e){[].concat(e).forEach(e=>{let r,o,s,n;if(e.render=void 0===e.render||e.render,Array.isArray(e.data[0])){r=[];for(let n=0;o=e.data[n];n++)for(s=0;s<t;s++)r.push(o[s]||0)}else r=e.data;g.layers[e.name]={data:r,zIndex:e.zIndex||0,render:e.render};for(const t in e.properties)if(e.properties.hasOwnProperty(t)){n=e.properties[t];try{n=JSON.parse(n)}catch(e){}g.layers[e.name][t]=n}g.layers[e.name].render&&(w.push(e.name),w.sort((e,t)=>g.layers[e].zIndex-g.layers[t].zIndex))}),function(){for(let e,t=0;e=g.layers[w[t]];t++)for(let t=0,r=e.data.length;t<r;t++)x(e,t)}()},changeTile(e,t,r){const o=b(t),s=g.layers[e];s.data[o]=r,x(s,o,!0)},tileAtLayer(e,t){const r=b(t);if(r>=0)return g.layers[e].data[r]},render(){g.context.drawImage(h,g.sx,g.sy,l,c,g.x,g.y,l,c)},renderLayer:function(e){const n=g.layers[e];let i=g.getRow();const a=g.getCol();let h=b({row:i,col:a});const d=a*o-g.sx,p=i*s-g.sy,u=Math.min(Math.ceil(l/o)+1,t),m=u*Math.min(Math.ceil(c/s)+1,r);let f,w,x,v,k,T,S,M,Y,X=0;for(;X<m;)(x=n.data[h])&&(k=(v=y(x)).image,f=d+X%u*o,w=p+(X/u|0)*s,M=(T=x-v.firstGrid)%(S=k.width/o)*o,Y=(T/S|0)*s,g.context.drawImage(k,M,Y,o,s,f,w,o,s)),++X%u==0?h=a+ ++i*t:h++},getRowAndCol({x:e,y:t}){return{row:this.getRow(t),col:this.getCol(e)}},getXAndY:({row:e,col:t,mapX:r,mapY:n})=>({x:(t?t*o:r)-g.sx+o/2,y:(e?e*s:n)-g.sy+s/2}),getRow:(e=0)=>(g.sy+e)/s|0,getCol:(e=0)=>(g.sx+e)/o|0,get sx(){return m},get sy(){return f},set sx(e){m=Math.min(Math.max(0,e),p)},set sy(e){f=Math.min(Math.max(0,e),u)}};g.sx=e.sx||0,g.sy=e.sy||0,h.width=n,h.height=i;for(const t in e.properties)if(e.properties.hasOwnProperty(t)){let r=e.properties[t];try{r=JSON.parse(r)}catch(e){}g[t]=g[t]||r}function b(e){let o,s;return void 0!==e.x&&void 0!==e.y?(o=g.getRow(e.y),s=g.getCol(e.x)):(o=e.row,s=e.col),o<0||s<0||o>=r||s>=t?-1:s+o*t}function y(e){let t,r,o=0,s=g.tilesets.length-1;for(;o<=s;){if(t=(o+s)/2|0,e>=(r=g.tilesets[t]).firstGrid&&e<=r.lastGrid)return r;r.lastGrid<e?o=t+1:s=t-1}}function x(e,r,n=!1){const i=e.data[r];if(!i)return;const a=y(i),l=a.image,c=r%t*o,h=(r/t|0)*s,p=i-a.firstGrid,u=l.width/o,m=p%u*o,f=(p/u|0)*s;n&&d.clearRect(c,h,o,s),d.drawImage(l,m,f,o,s,c,h,o,s)}return e.tilesets&&g.addTilesets(e.tilesets),e.layers&&g.addLayers(e.layers),g},U=async({data:e,width:t,height:r,col:o,row:s})=>{const{sx:n,sy:i}=g({col:o,row:s}),a=F({tileWidth:100,tileHeight:100,width:t+8,height:r+8,sx:n,sy:i}),l=((e,t,r,o)=>{const s=[];let n=0;for(let i=0;i<r+2*o;i++)for(let a=0;a<t+2*o;a++)i<o||i>=o+r||a<o||a>=o+t?s.push(0):s.push(e[n++]);return s})(e,t,r,4),c=await(()=>{const e=document.createElement("canvas");e.width=800,e.height=800;const t=e.getContext("2d");z({ctx:t,row:1,col:1,deg:0}),z({ctx:t,row:1,col:2,deg:90}),z({ctx:t,row:2,col:1,deg:270}),z({ctx:t,row:2,col:2,deg:180}),N({ctx:t,row:1,col:3,deg:0}),N({ctx:t,row:2,col:3,deg:90}),_({ctx:t,row:1,col:4,deg:0}),_({ctx:t,row:1,col:5,deg:90}),_({ctx:t,row:1,col:6,deg:180}),_({ctx:t,row:2,col:5,deg:270}),q({ctx:t,row:2,col:4}),j({ctx:t,row:3,col:1,deg:0}),j({ctx:t,row:3,col:2,deg:90}),j({ctx:t,row:3,col:3,deg:180}),j({ctx:t,row:3,col:4,deg:270}),z({ctx:t,row:4,col:1,deg:0,broken:!0}),z({ctx:t,row:4,col:2,deg:90,broken:!0}),z({ctx:t,row:5,col:1,deg:270,broken:!0}),z({ctx:t,row:5,col:2,deg:180,broken:!0}),N({ctx:t,row:4,col:3,deg:0,broken:!0}),N({ctx:t,row:5,col:3,deg:90,broken:!0}),_({ctx:t,row:4,col:4,deg:0,broken:!0}),_({ctx:t,row:4,col:5,deg:90,broken:!0}),_({ctx:t,row:4,col:6,deg:180,broken:!0}),_({ctx:t,row:5,col:5,deg:270,broken:!0}),q({ctx:t,row:5,col:4,broken:!0}),j({ctx:t,row:6,col:1,deg:0,broken:!0}),j({ctx:t,row:6,col:2,deg:90,broken:!0}),j({ctx:t,row:6,col:3,deg:180,broken:!0}),j({ctx:t,row:6,col:4,deg:270,broken:!0});const r=new Image;return r.src=e.toDataURL("image/png"),new Promise(e=>setTimeout(()=>e(r),100))})();return a.addTilesets({image:c}),a.addLayers([{name:"main",data:l}]),a};var J=new class{constructor(){this.timeoutHandler=null,this.div=document.createElement("div"),this.div.style.cssText="\nbackground-color: rgba(0,0,0,0.3);\nfont-size: 3em;\nfont-weight: bold;\nalign-items: center;\njustify-content: center;\ndisplay: flex;\ncolor: white;\nopacity: 0;\nposition: absolute;\ntop: 0;\nleft:0;\nwidth: 100vw;\nheight: 100vh;\ntext-align: center;\npointer-events: none;\ntransition: background-color 3s ease-out, color 3s ease-out;\ntext-transform: uppercase;\nfont-family: monospace;\n    ",document.getElementById("wrapper").appendChild(this.div)}show(e){clearTimeout(this.timeoutHandler),this.div.style.transition="3s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.opacity=1}flash(e){clearTimeout(this.timeoutHandler),this.div.style.transition="0.5s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.opacity=1,this.timeoutHandler=setTimeout(()=>this.div.style.opacity=0,500)}clear(){clearTimeout(this.timeoutHandler),this.div.style.transition="0.5s",this.div.style.opacity=0}},K=({map:r,direction:o,speed:s})=>{const i={context:kontra.context,x:400,y:300,collisionRadius:30,map:r,speed:s,infected:!1,gameOver:!0,direction:o,nextDirection:null,dropBomb:!1,scale:1,dropping:!1,bombCoolingDown:!1,teleportToServer:!1,update(){({nextDirection:this.nextDirection,direction:this.direction,dropBomb:this.dropBomb,scale:this.scale,bombCoolingDown:this.bombCoolingDown,teleportToServer:this.teleportToServer}=V(this,e,J))},render(){Q(this)},infect(r){E(r,this)&&(this.infected=!0,this.gameOver||(J.show("player infected<br>game over"),e.publish(t)))},teleport(){if(this.teleportToServer){const e=P.getRandom();e?(({sx:this.map.sx,sy:this.map.sy}=g(e)),k(this.map,{x:this.x,y:this.y},this.direction)||(this.direction=T(this.map,{x:this.x,y:this.y},this.direction))):J.flash("all servers are destroyed"),this.teleportToServer=!1}},enableControls(){this.gameOver=!1}};return e.subscribe(t,()=>i.gameOver=!0),e.subscribe(n,()=>i.dropping=!0),i},Q=e=>{const{context:t,x:r,y:o,direction:s,infected:n,scale:i}=e;t.save(),t.translate(r,o),t.scale(i,i),t.rotate((e=>{switch(e){case b:return X(0);case y:return X(90);case x:return X(180);case v:return X(270);default:return null}})(s)),t.lineWidth=3,t.strokeStyle=n?"#cd3926":p,t.fillStyle=n?"#7a2431":"#365b1d",t.beginPath(),t.moveTo(-15,25),t.lineTo(0,-25),t.lineTo(15,25),t.closePath(),t.fill(),t.stroke(),t.restore()},V=o=>{let{nextDirection:s,direction:i,dropBomb:a,scale:l,bombCoolingDown:c,teleportToServer:h}=o;const{dropping:d,map:p,gameOver:u,x:m,y:f}=o;if(d)return l>0?l-=.01:(J.show("You fell into the abyss<br>Game over"),e.publish(t)),{direction:i,nextDirection:s,dropBomb:a,scale:l,bombCoolingDown:c,teleportToServer:h};if(u||(({nextDirection:s,dropBomb:a,teleportToServer:h}=(e=>{let{nextDirection:t,dropBomb:r,teleportToServer:o}=e;return kontra.keys.pressed("right")&&(t=y),kontra.keys.pressed("left")&&(t=v),kontra.keys.pressed("up")&&(t=b),kontra.keys.pressed("down")&&(t=x),kontra.keys.pressed("space")&&(r=!0),kontra.keys.pressed("enter")&&(o=!0),{nextDirection:t,dropBomb:r,teleportToServer:o}})(o)),c&&(a=!1)),!(({x:e,y:t})=>(e-50)%100==0&&(t-50)%100==0)({x:p.sx,y:p.sy}))return{direction:i,nextDirection:s,dropBomb:a,scale:l,bombCoolingDown:c,teleportToServer:h};if(s&&k(p,{x:m,y:f},s))i=s,s=null;else try{i=T(p,{x:m,y:f},i)}catch({message:t}){"dropped"===t&&e.publish(n)}return a&&(e.publish(r,p.getRowAndCol({x:m,y:f})),a=!1,c=!0,setTimeout(()=>{o.bombCoolingDown=!1},100)),{direction:i,nextDirection:s,dropBomb:a,scale:l,bombCoolingDown:c,teleportToServer:h}},Z=(e,t)=>{const r=[];let o=t;for(;void 0!==o;)r.push(o),o=e.get(o);return r.reverse(),r},ee=(e,t)=>{let r=t.shift();const o=[];let s,n,i;for(;t.length;){if(s=t.shift(),!(n=te(e,r,s)))return null;if(i=Z(n,s),!t.length)return o.concat(i);o.push.apply(o,i.slice(0,-1)),r=s}return null},te=(e,t,r)=>{const o=new Map([[t,0]]),s=new Map([[0,[t]]]),n=new Map;function i(e,t){let r=s.get(e);r||(r=[],s.set(e,r)),r.push(t)}for(;s.size>0;){const t=Array.from(s.keys()).sort((e,t)=>e-t)[0],r=s.get(t),a=r.shift(),l=e.get(a)||new Map;0===r.length&&s.delete(t);for(const[e,r]of l){const s=r+t,l=o.get(e);(void 0===l||l>s)&&(o.set(e,s),i(s,e),n.set(e,a))}}return void 0===o.get(r)?null:n},re=({width:e,layers:t},r)=>{const{graph:o,allowed:s}=se(t[r].data,e);for(const[e,t]of o){const r=s.get(e),{row:n,col:i}=e;let a;for(const e of r)switch(e){case b:(a=oe(o,{row:n-1,col:i}))&&t.set(a,1);break;case y:(a=oe(o,{row:n,col:i+1}))&&t.set(a,1);break;case x:(a=oe(o,{row:n+1,col:i}))&&t.set(a,1);break;case v:(a=oe(o,{row:n,col:i-1}))&&t.set(a,1)}}return o},oe=(e,{row:t,col:r})=>{for(const[o]of e)if(t===o.row&&r===o.col)return o;return null},se=(e,t)=>{const r=new Map,o=new Map;let s=0,n=0,i=0;for(const a of e){if(C(a)){const e={row:s,col:n};o.set(e,S[a].allowed),r.set(e,new Map)}++i%t==0?(s++,n=0):n++}return{graph:r,allowed:o}};var ne=new class{constructor(e=null){this.graph=e}setDataFromMap(e,t){this.graph=re(e,t)}getNodeByCoords(e){return oe(this.graph,e)}findShortestPath(...e){return ee(this.graph,e)}isReachable(e,t){return null!==this.findShortestPathByCoords(e,t)}findShortestPathByCoords(...e){return this.findShortestPath(...e.map(e=>this.getNodeByCoords(e)))}},ie=()=>e.subscribe(3,e=>ne.setDataFromMap(e,"main"));class ae{constructor({map:r,positions:o}){this.map=r,this.users=[],this.gameOver=!1;for(const{row:e,col:t}of o)this.users.push(le({map:r,row:e,col:t}));e.subscribe(t,()=>this.gameOver=!0)}updateOnlineStatus(...r){const o=r.map(e=>({...e,...this.map.getRowAndCol({x:e.x,y:e.y})}));let s=0;for(const e of this.users.filter(({status:e})=>e===ce))for(const t of o){ne.isReachable(e,t)||(s++,e.status=he)}if(s>0){const{online:r,offline:o,infected:s}=this.getStats();0===r?(J.show(`level completed<br>offline users: ${o}<br>infected users: ${s}`),e.publish(t)):J.flash(`${o} users went offline<br>good job!`)}}getStats(){return this.users.reduce((e,{status:t})=>({online:e.online+(t===ce?1:0),offline:e.offline+(t===he?1:0),infected:e.infected+(t===de?1:0)}),{online:0,offline:0,infected:0})}update(){this.users.forEach(e=>e.update())}render(){this.users.forEach(e=>e.render())}infect(...r){const{users:o,gameOver:s}=this,n=D(o,r).filter(([e])=>e.status!==de);if(0===n.length)return;if(n.forEach(([e])=>e.infect()),s)return;const{online:i,offline:a,infected:l}=this.getStats();if(0===i)return J.show(`level completed<br>offline users: ${a}<br>infected users: ${l}`),void e.publish(t);J.flash("user infected!")}}var le=({map:t,row:r,col:o})=>{const{x:n,y:i}=t.getXAndY({row:r,col:o});return{context:kontra.context,x:n,y:i,collisionRadius:30,infected:!1,map:t,mapX:100*o,mapY:100*r,row:r,col:o,status:ce,update(){({x:this.x,y:this.y}=t.getXAndY({mapX:this.mapX,mapY:this.mapY}))},render(){ue(this)},infect(){this.status=de,e.publish(s)}}};const ce=0,he=1,de=2,pe={[ce]:{fg:"#52638a",bg:"#2b3653"},[he]:{fg:p,bg:"#365b1d"},[de]:{fg:"#cd3926",bg:"#7a2431"}};var ue=e=>{const{context:t,x:r,y:o,status:s}=e,{fg:n,bg:i}=pe[s];t.save(),t.translate(r,o),t.lineWidth=3,t.strokeStyle=n,t.fillStyle=i,t.beginPath(),t.moveTo(-40,40),t.lineTo(-40,20),t.arc(-20,20,20,X(180),X(270)),t.moveTo(-20,0),t.lineTo(20,0),t.arc(20,20,20,X(270),X(0)),t.lineTo(40,40),t.lineTo(-40,40),t.moveTo(-23,20),t.lineTo(-23,40),t.moveTo(23,20),t.lineTo(23,40),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-15,25,X(0),X(360)),t.fill(),t.stroke(),t.restore()},me=({map:e,col:t,row:r,direction:o,speed:s})=>{const{x:n,y:i}=e.getXAndY({row:r,col:t}),a=new class{constructor(){this.blips=[]}start(e){setInterval(()=>{this.blips.push(be({x:e.x,y:e.y}))},d)}update(){this.blips.forEach(e=>e.update()),this.blips=this.blips.filter(e=>e.ttl>0)}render(){this.blips.forEach(e=>e.render())}},l={context:kontra.context,x:n,y:i,speed:s,collisionRadius:30,map:e,mapX:100*t,mapY:100*r,direction:o,blips:a,update(){({x:this.x,y:this.y,mapX:this.mapX,mapY:this.mapY,direction:this.direction}=we(this)),this.blips.update()},render(){ge(this),this.blips.render()}};return a.start(l),l};let fe=null;var we=e=>{let{direction:t}=e;const{map:r}=e,{mapX:o,mapY:s}=(({mapX:e,mapY:t,direction:r,speed:o})=>{switch(r){case b:return{mapX:e,mapY:t-o};case y:return{mapX:e+o,mapY:t};case x:return{mapX:e,mapY:t+o};case v:return{mapX:e-o,mapY:t};default:return{mapX:e,mapY:t}}})(e),{x:n,y:i}=r.getXAndY({mapX:o,mapY:s});if(fe||(fe=Array(r.height).fill().map(()=>Array(r.width).fill(0))),(({mapX:e,mapY:t})=>e%100==0&&t%100==0)({mapX:o,mapY:s})){const e=r.tileAtLayer("main",{x:n,y:i}),{col:o,row:s}=r.getRowAndCol({x:n,y:i});if(fe[s][o]++,(e=>M.includes(e))(e)){const{allowed:a}=S[e],l=(({viable:e,visits:t,row:r,col:o})=>{let s=Number.MAX_SAFE_INTEGER;return e.map(e=>{let n;switch(e){case b:n=t[r-1][o];break;case y:n=t[r][o+1];break;case x:n=t[r+1][o];break;case v:n=t[r][o-1]}return s=n<s?n:s,{dir:e,vis:n}}).filter(({vis:e})=>e===s).map(({dir:e})=>e)})({viable:a.filter(e=>e!==(e=>{switch(e){case b:return x;case y:return v;case x:return b;case v:return v;default:return null}})(t)&&k(r,{x:n,y:i},e)),visits:fe,row:s,col:o});t=l[A(0,l.length-1)]}else t=T(r,{x:n,y:i},t)}return{direction:t,mapY:s,mapX:o,x:n,y:i}},ge=e=>{const{context:t,x:r,y:o}=e;t.save(),t.translate(r,o),t.lineWidth=3,t.strokeStyle="#cd3926",t.fillStyle="#7a2431",t.beginPath(),t.moveTo(A(-5,5),A(-5,-25)),t.lineTo(A(5,50),A(-5,-50)),t.lineTo(A(5,25),A(-5,5)),t.lineTo(A(5,50),A(5,50)),t.lineTo(A(-5,5),A(5,25)),t.lineTo(A(-5,-50),A(5,50)),t.lineTo(A(-5,-25),A(-5,5)),t.lineTo(A(-5,-50),A(-5,-50)),t.closePath(),t.fill(),t.stroke(),t.restore()},be=({x:e,y:t})=>({context:kontra.context,x:e,y:t,ttl:180,radius:100,update(){this.radius+=10,this.ttl--},render(){ye(this)}}),ye=e=>{const{context:t,x:r,y:o,radius:s}=e;t.save(),t.translate(r,o),t.lineWidth=1,t.strokeStyle="#cd3926",t.beginPath(),t.arc(0,0,s,X(0),X(360)),t.closePath(),t.stroke(),t.restore()};var xe=()=>{const e=document.createElement("canvas");e.width=800,e.height=600,e.style.cssText="\n        border: 4px solid #52638a;\n    ",document.getElementById("wrapper").appendChild(e)};var ve=new class{getLevel(e){return ke[e]}},ke=[{player:{col:8,row:9,direction:b,speed:5},viruses:[{col:8,row:7,dir:v,speed:2.5}],users:[{row:4,col:5},{row:4,col:9},{row:4,col:13},{row:4,col:17},{row:4,col:21},{row:5,col:4},{row:8,col:23},{row:12,col:23},{row:14,col:23},{row:16,col:23},{row:17,col:4},{row:19,col:23},{row:21,col:4},{row:21,col:23},{row:23,col:7},{row:23,col:9},{row:23,col:14},{row:23,col:17},{row:23,col:21}],servers:[{row:9,col:8},{row:9,col:12}],map:{width:20,height:20,data:[0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,20,4,11,2,1,4,2,0,0,5,11,6,11,13,0,1,11,12,2,0,0,1,11,10,9,11,13,0,0,3,0,3,0,5,11,13,0,3,3,0,0,3,1,11,6,11,10,0,1,4,2,9,11,13,0,9,11,10,3,0,0,3,3,0,3,0,0,0,3,1,13,0,0,3,0,0,0,0,5,18,0,3,3,0,3,0,1,11,10,3,9,11,6,4,11,6,2,0,3,0,0,3,3,0,3,0,3,0,0,3,0,0,3,0,0,3,3,0,3,0,0,9,13,0,5,11,10,0,0,3,1,11,10,0,0,3,3,0,3,0,0,0,3,0,3,0,0,0,1,4,10,0,0,0,0,3,5,11,4,18,0,1,13,0,5,11,2,0,3,0,1,11,11,11,11,12,10,0,0,0,0,3,3,0,3,0,5,11,13,0,9,11,2,0,0,3,0,0,1,18,0,9,10,0,5,11,10,0,9,11,11,11,12,11,6,10,0,0,3,0,0,0,0,0,3,1,11,2,1,11,11,11,10,0,3,0,1,11,4,18,20,6,6,11,10,3,0,3,3,0,0,0,1,2,9,11,12,11,2,0,0,3,3,0,0,3,0,3,3,1,11,2,3,3,0,0,3,0,3,0,0,5,4,2,0,5,11,10,3,3,0,5,12,4,11,11,13,0,5,18,0,3,0,5,11,12,11,6,10,9,6,10,3,0,0,0,9,11,10,0,20,4,11,13,0,3,0,9,11,11,13,0,9,11,6,11,6,6,11,18,0,0,0,3,0,3,0,0,0,0,5,11,11,2,3,0,3,3,0,0,0,0,0,19,0,19,0,0,0,0,19,0,0,19,9,11,10,19,0,0]}}];var Te=new class{constructor(){xe(),kontra.init(),ie(),e.subscribe(r,()=>h.play("drop-bomb")),e.subscribe(o,()=>h.play("explode")),e.subscribe(s,()=>h.play("infected")),e.subscribe(n,()=>h.play("drop-ship"))}async initLevel(t){const r=ve.getLevel(t),o=await U({...r.map,col:r.player.col,row:r.player.row});this.player=K({map:o,...r.player});const s=new G(o),n=me({map:o,...r.viruses[0]});ne.setDataFromMap(o,"main");const a=new ae({map:o,positions:r.users});P.init(o,r.servers),this.loop=$({map:o,player:this.player,virus:n,users:a,bombs:s}),e.reset(i,()=>a.updateOnlineStatus(n)),o.render(),a.render(),P.render(),s.render(),this.player.render(),n.render()}showStartScreen(){J.show(`\n            welcome, <span style="color:${p}; font-size: 150%">captain katamov!</span><br><br>\n            Your shift as chief network security officers is about to begin… all users are online and happy. \n            in case of virus intrusion, <span style="color: ${p}">cut them off</span> from the network\n            to make sure they don't get infected!<br><br>\n            <table style="font-size: 75%; text-align: left; margin-left: auto; margin-right: auto">\n                <tr>\n                    <td><span style="color: ${p}">arrow keys</span></td>\n                    <td>…</td><td>change direction</td>\n                </tr><tr>\n                    <td><span style="color: ${p}">space bar</span></td>\n                    <td>…</td><td>drop bomb</td>\n                </tr><tr>\n                    <td><span style="color: ${p}">return</span></td>\n                    <td>…</td><td>teleport to server</td>\n                </tr>\n            </table>\n            <br>\n            press any key to begin!\n        `),document.addEventListener("keydown",()=>{J.clear(),this.startLevel(),setTimeout(()=>this.player.enableControls(),500)},{once:!0})}startLevel(){this.loop.start()}};(async()=>{await Te.initLevel(0),Te.showStartScreen()})()}();
//# sourceMappingURL=game.js.map
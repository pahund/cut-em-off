!function(e){var t={};function s(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=e,s.c=t,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(r,i,function(t){return e[t]}.bind(null,i));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";s.r(t);const r="N",i="E",a="S",o="W";var n=(e,{x:t,y:s},r)=>{const i=e.tileAtLayer("main",{x:t,y:s});if(!_(i)||!u[i].allowed.includes(r))return!1;const a=m(e,{x:t,y:s},r);return _(a)},h=e=>e*Math.PI/180,l=(e,t)=>{const s=Math.min(e,t),r=Math.max(e,t);return Math.floor(Math.random()*(r-s+1))+s},p=(e,{row:t,col:s,x:r,y:i})=>{const{tileWidth:a,tileHeight:o,sx:n,sy:h}=e;return{x:(void 0!==r?r:(s-1)*a)-n+y/2+a/2,y:(void 0!==i?i:(t-1)*o)-h+b/2+o/2}},c=(e,t)=>{const s=e.x-t.x,r=e.y-t.y;return Math.sqrt(s*s+r*r)<e.collisionRadius+t.collisionRadius},d=(e,{x:t,y:s},r)=>{const i=e.tileAtLayer("main",{x:t,y:s});if(!_(i))throw new Error("dropped");const a=u[i].change[r]||r;if(n(e,{x:t,y:s},a))return a;const o=u[i].allowed.filter(r=>n(e,{x:t,y:s},r));switch(o.length){case 0:throw new Error("locked in");case 1:return o[0];default:return o[l(0,o.length-1)]}},u={1:{allowed:[a,i],change:{[r]:i,[o]:a}},2:{allowed:[o,a],change:{[r]:o,[i]:a}},3:{allowed:[r,a],change:{}},4:{allowed:[o,r,i],change:{[a]:r}},5:{allowed:[r,i,a],change:{[o]:i}},6:{allowed:[o,i,a],change:{[r]:a}},9:{allowed:[r,i],change:{[a]:i,[o]:r}},10:{allowed:[o,r],change:{[i]:r,[a]:o}},11:{allowed:[o,i],change:{}},12:{allowed:[r,i,a,o],change:{}},13:{allowed:[r,a,o],change:{[i]:o}},14:{allowed:[r,a],change:{}},17:{allowed:[a],change:{[r]:a}},18:{allowed:[o],change:{[i]:o}},19:{allowed:[r],change:{[a]:r}},20:{allowed:[i],change:{[o]:i}},38:{allowed:[r,a],change:{}}};const f=[];for(const[e,{allowed:t}]of Object.entries(u))t.length>2&&f.push(Number(e));var m=(e,{x:t,y:s},n)=>e.tileAtLayer("main",{x:n===i?t+g:n===o?t-g:t,y:n===r?s-w:n===a?s+w:s}),_=e=>e<25||e>30&&e<33||e>37&&e<41||e>44;const y=800,b=600,g=100,w=100;var v=new class{constructor(){this.subscribers=[]}subscribe(e,t){this.subscribers.push({message:e,callback:t})}publish(e,t){this.subscribers.forEach(({message:s,callback:r})=>s===e&&r(t))}};const x=0,k=1,M=6,T=7;var S=({map:e,player:t,virus:s,users:n,bombs:h})=>{let l=!0;return v.subscribe(2,()=>l=!1),kontra.gameLoop({update(){s.update(),t.update(),t.infect(s),l&&((e,t)=>{switch(t){case r:e.sy-=5;break;case i:e.sx+=5;break;case a:e.sy+=5;break;case o:e.sx-=5}})(e,t.direction),n.update(),n.infect([s]),h.update()},render(){e.render(),n.render(),h.render(),t.render(),s.render()}})},C=[0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,20,4,11,2,1,4,2,0,0,5,11,6,11,13,0,1,11,12,2,0,0,1,11,10,9,11,13,0,0,3,0,3,0,5,11,13,0,3,3,0,0,3,1,11,6,11,10,0,1,4,2,9,11,13,0,9,11,10,3,0,0,3,3,0,3,0,0,0,3,1,13,0,0,3,0,0,0,0,5,18,0,3,3,0,14,0,1,11,10,3,9,11,6,4,11,6,2,0,3,0,0,3,3,0,3,0,3,0,0,3,0,0,3,0,0,3,3,0,3,0,0,9,13,0,5,11,10,0,0,3,1,11,10,0,0,3,3,0,3,0,0,0,3,0,3,0,0,0,1,4,10,0,0,0,0,3,5,11,4,18,0,1,13,0,5,11,2,0,3,0,1,11,11,11,11,12,10,0,0,0,0,3,3,0,3,0,5,11,13,0,9,11,2,0,0,3,0,0,1,18,0,9,10,0,5,11,10,0,9,11,11,11,12,11,6,10,0,0,3,0,0,0,0,0,3,1,11,2,1,11,11,11,10,0,3,0,1,11,4,18,20,6,6,11,10,3,0,3,3,0,0,0,1,2,9,11,12,11,2,0,0,3,3,0,0,3,0,3,3,1,11,2,3,3,0,0,3,0,3,0,0,5,4,2,0,5,11,10,3,3,0,5,12,4,11,11,13,0,5,18,0,3,0,5,11,12,11,6,10,9,6,10,3,0,0,0,9,11,10,0,20,4,11,13,0,3,0,9,11,11,13,0,9,11,6,11,6,6,11,18,0,0,0,3,0,3,0,0,0,0,5,11,11,2,3,0,3,3,0,0,0,0,0,19,0,19,0,0,0,0,19,0,0,19,9,11,10,19,0,0];function P(e,t){return[Math.cos(h(e))*t+50,Math.sin(h(e))*t+50]}var q=({ctx:e,row:t,col:s,deg:r,broken:i=!1})=>{e.save(),e.translate((s-1)*g+g/2,(t-1)*w+w/2),e.rotate(h(r)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),i?(e.moveTo(20,50),e.arc(50,50,30,h(180),h(190)),e.moveTo(...P(190,30)),e.lineTo(10,45),e.lineTo(10,35),e.lineTo(-10,40),e.lineTo(...P(190,70)),e.arc(50,50,70,h(190),h(180),!0),e.moveTo(50,20),e.arc(50,50,30,h(270),h(260),!0),e.moveTo(...P(260,30)),e.lineTo(40,10),e.lineTo(45,0),e.lineTo(35,0),e.lineTo(...P(260,70)),e.arc(50,50,70,h(260),h(270))):(e.moveTo(20,50),e.arc(50,50,30,h(180),h(270)),e.moveTo(-20,50),e.arc(50,50,70,h(180),h(270))),e.stroke(),e.restore()},R=(e,t)=>t.forEach(([t,s,r])=>e[t?"lineTo":"moveTo"](s,r)),O=({ctx:e,row:t,col:s,deg:r,broken:i=!1})=>{e.save(),e.translate((s-1)*g+g/2,(t-1)*w+w/2),e.rotate(h(r)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),R(e,i?[[0,-20,50],[1,-20,30],[1,-10,40],[1,0,25],[1,10,35],[1,20,30],[1,20,50],[0,-20,-50],[1,-20,-40],[1,-10,-25],[1,0,-35],[1,10,-30],[1,20,-40],[1,20,-50]]:[[0,-20,-50],[1,-20,50],[0,20,-50],[1,20,50]]),e.stroke(),e.restore()},E=({ctx:e,row:t,col:s,deg:r,broken:i=!1})=>{e.save(),e.translate((s-1)*g+g/2,(t-1)*w+w/2),e.rotate(h(r)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),R(e,i?[[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,50,20]]),e.stroke(),e.restore()},L=({ctx:e,row:t,col:s,broken:r=!1})=>{e.save(),e.translate((s-1)*g+g/2,(t-1)*w+w/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),R(e,r?[[0,-20,50],[1,-20,45],[1,-10,40],[1,0,45],[1,10,35],[1,20,40],[1,20,50],[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,-20,20],[1,-20,50],[0,50,20],[1,20,20],[1,20,50]]),e.stroke(),e.restore()},I=({ctx:e,row:t,col:s,broken:r})=>{e.save(),e.translate((s-1)*g+g/2,(t-1)*w+w/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),R(e,[[0,30,-48],[1,48,-30],[1,48,30],[1,30,48],[1,-30,48],[1,-48,30],[1,-48,-30],[1,-30,-48],[1,30,-48]]),e.stroke(),r&&(e.lineWidth=2,R(e,[[0,10,-48],[1,0,-40],[0,24,-48],[1,20,-30],[0,48,-27],[1,20,-20],[0,-10,-30],[1,10,-30],[1,30,-10],[1,20,0],[1,10,0],[0,48,7],[1,30,10],[0,20,0],[1,30,10],[1,10,20],[0,30,48],[1,30,30],[1,10,30],[0,20,20],[1,20,30],[0,-10,48],[1,-10,20],[1,0,10],[0,-20,0],[1,-20,20],[1,-10,30],[0,-30,48],[1,-20,40],[1,-20,30],[0,-30,30],[1,-20,40],[0,-48,20],[1,-30,20],[0,-40,20],[1,-40,10],[0,-48,0],[1,-30,0],[1,-20,-10],[0,-40,0],[1,-30,10],[0,-48,-17],[1,-40,-30],[1,-30,-20],[0,-30,-48],[1,-10,-20],[1,-10,-10],[0,-20,-30],[1,-20,-20],[1,-30,-10]]),e.stroke()),e.restore()},D=({ctx:e,row:t,col:s,deg:r,broken:i=!1})=>{e.save(),e.translate((s-1)*g+g/2,(t-1)*w+w/2),e.rotate(h(r)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),R(e,i?[[0,-20,50],[1,-20,40],[1,-10,45],[1,0,35],[1,10,45],[1,20,40],[1,20,50]]:[[0,-20,50],[1,-20,0],[1,20,0],[1,20,50]]),e.stroke(),e.restore()},A=(e={})=>{if(!e.width||!e.height)throw Error("You must provide width and height properties");const t=e.width,s=e.height,r=e.tileWidth||32,i=e.tileHeight||32,a=t*r,o=s*i,n=e.context||kontra.context,h=n.canvas.width,l=n.canvas.height,p=document.createElement("canvas"),c=p.getContext("2d"),d=Math.max(0,a-h),u=Math.max(0,o-l);let f,m;const _=[],y={width:t,height:s,tileWidth:r,tileHeight:i,mapWidth:a,mapHeight:o,context:n,x:e.x||0,y:e.y||0,tilesets:[],layers:{},addTilesets:function(e){[].concat(e).forEach(e=>{const t=e.image;let s,a,o,n;if(`${t}`===t){let e=1/0;for(;e>=0;){const r=(e=t.lastIndexOf("/",e))<0?t:t.substr(e);if(kontra.assets.images[r]){s=kontra.assets.images[r];break}e--}}else s=t;a=e.firstGrid;const h=(s.width/r|0||1)*(s.height/i|0||1);a||(y.tilesets.length>0?(n=((o=y.tilesets[y.tilesets.length-1]).image.width/r|0)*(o.image.height/i|0),a=o.firstGrid+n):a=1),y.tilesets.push({firstGrid:a,lastGrid:a+h-1,image:s}),y.tilesets.sort((e,t)=>e.firstGrid-t.firstGrid)})},addLayers:function(e){[].concat(e).forEach(e=>{let s,r,i,a;if(e.render=void 0===e.render||e.render,Array.isArray(e.data[0])){s=[];for(let a=0;r=e.data[a];a++)for(i=0;i<t;i++)s.push(r[i]||0)}else s=e.data;y.layers[e.name]={data:s,zIndex:e.zIndex||0,render:e.render};for(const t in e.properties)if(e.properties.hasOwnProperty(t)){a=e.properties[t];try{a=JSON.parse(a)}catch(e){}y.layers[e.name][t]=a}y.layers[e.name].render&&(_.push(e.name),_.sort((e,t)=>y.layers[e].zIndex-y.layers[t].zIndex))}),function(){for(let e,t=0;e=y.layers[_[t]];t++)for(let t=0,s=e.data.length;t<s;t++)w(e,t)}()},changeTile(e,{row:s,col:r},i){const a=((e,t,s)=>(e-1)*s+t-1)(s,r,t),o=y.layers[e];o.data[a]=i,w(o,a,!0)},layerCollidesWith:function(e,t){const s=y.getRow(t.y),r=y.getCol(t.x),i=y.getRow(t.y+t.height),a=y.getCol(t.x+t.width);let o;for(let t=s;t<=i;t++)for(let s=r;s<=a;s++)if(o=b({row:t,col:s}),y.layers[e].data[o])return!0;return!1},tileAtLayer(e,t){const s=b(t);if(s>=0)return y.layers[e].data[s]},render(){y.context.drawImage(p,y.sx,y.sy,h,l,y.x,y.y,h,l)},renderLayer:function(e){const a=y.layers[e];let o=y.getRow();const n=y.getCol();let p=b({row:o,col:n});const c=n*r-y.sx,d=o*i-y.sy,u=Math.min(Math.ceil(h/r)+1,t),f=u*Math.min(Math.ceil(l/i)+1,s);let m,_,w,v,x,k,M,T,S,C=0;for(;C<f;)(w=a.data[p])&&(x=(v=g(w)).image,m=c+C%u*r,_=d+(C/u|0)*i,T=(k=w-v.firstGrid)%(M=x.width/r)*r,S=(k/M|0)*i,y.context.drawImage(x,T,S,r,i,m,_,r,i)),++C%u==0?p=n+ ++o*t:p++},getRow:e=>(e=e||0,(y.sy+e)/i|0),getCol:e=>(e=e||0,(y.sx+e)/r|0),get sx(){return f},get sy(){return m},set sx(e){f=Math.min(Math.max(0,e),d)},set sy(e){m=Math.min(Math.max(0,e),u)},_layerOrder:_};y.sx=e.sx||0,y.sy=e.sy||0,p.width=a,p.height=o;for(const t in e.properties)if(e.properties.hasOwnProperty(t)){let s=e.properties[t];try{s=JSON.parse(s)}catch(e){}y[t]=y[t]||s}function b(e){let r,i;return void 0!==e.x&&void 0!==e.y?(r=y.getRow(e.y),i=y.getCol(e.x)):(r=e.row,i=e.col),r<0||i<0||r>=s||i>=t?-1:i+r*t}function g(e){let t,s,r=0,i=y.tilesets.length-1;for(;r<=i;){if(t=(r+i)/2|0,e>=(s=y.tilesets[t]).firstGrid&&e<=s.lastGrid)return s;s.lastGrid<e?r=t+1:i=t-1}}function w(e,s,a=!1){const o=e.data[s];if(!o)return;const n=g(o),h=n.image,l=s%t*r,p=(s/t|0)*i,d=o-n.firstGrid,u=h.width/r,f=d%u*r,m=(d/u|0)*i;a&&c.clearRect(l,p,r,i),c.drawImage(h,f,m,r,i,l,p,r,i)}return e.tilesets&&y.addTilesets(e.tilesets),e.layers&&y.addLayers(e.layers),y},W=async()=>{const{sx:e,sy:t}=(({col:e,row:t})=>({sx:(e-1)*g+g/2,sy:(t-1)*w+w/2}))({col:5,row:6}),s=A({tileWidth:g,tileHeight:w,width:28,height:26,sx:e,sy:t}),r=((e,t,s,r,i)=>{const a=[];let o=0;for(let n=0;n<s+2*i;n++)for(let h=0;h<t+2*r;h++)n<i||n>=i+s||h<r||h>=r+t?a.push(0):a.push(e[o++]);return a})(C,20,20,4,3),i=await(()=>{const e=document.createElement("canvas");e.width=8*g,e.height=8*w;const t=e.getContext("2d");q({ctx:t,row:1,col:1,deg:0}),q({ctx:t,row:1,col:2,deg:90}),q({ctx:t,row:2,col:1,deg:270}),q({ctx:t,row:2,col:2,deg:180}),O({ctx:t,row:1,col:3,deg:0}),O({ctx:t,row:2,col:3,deg:90}),E({ctx:t,row:1,col:4,deg:0}),E({ctx:t,row:1,col:5,deg:90}),E({ctx:t,row:1,col:6,deg:180}),E({ctx:t,row:2,col:5,deg:270}),L({ctx:t,row:2,col:4}),D({ctx:t,row:3,col:1,deg:0}),D({ctx:t,row:3,col:2,deg:90}),D({ctx:t,row:3,col:3,deg:180}),D({ctx:t,row:3,col:4,deg:270}),I({ctx:t,row:2,col:6}),q({ctx:t,row:4,col:1,deg:0,broken:!0}),q({ctx:t,row:4,col:2,deg:90,broken:!0}),q({ctx:t,row:5,col:1,deg:270,broken:!0}),q({ctx:t,row:5,col:2,deg:180,broken:!0}),O({ctx:t,row:4,col:3,deg:0,broken:!0}),O({ctx:t,row:5,col:3,deg:90,broken:!0}),E({ctx:t,row:4,col:4,deg:0,broken:!0}),E({ctx:t,row:4,col:5,deg:90,broken:!0}),E({ctx:t,row:4,col:6,deg:180,broken:!0}),E({ctx:t,row:5,col:5,deg:270,broken:!0}),L({ctx:t,row:5,col:4,broken:!0}),D({ctx:t,row:6,col:1,deg:0,broken:!0}),D({ctx:t,row:6,col:2,deg:90,broken:!0}),D({ctx:t,row:6,col:3,deg:180,broken:!0}),D({ctx:t,row:6,col:4,deg:270,broken:!0}),I({ctx:t,row:5,col:6,broken:!0});const s=new Image;return s.src=e.toDataURL("image/png"),new Promise(e=>setTimeout(()=>e(s),100))})();return s.addTilesets({image:i}),s.addLayers([{name:"main",data:r},{name:"debug",data:new Array(r.length).fill(0)}]),s};var Y=new class{constructor(){this.timeoutHandler=null,this.div=document.createElement("div"),this.div.style.cssText="\nbackground-color: rgba(0,0,0,0);\nfont-size: 3em;\nfont-weight: bold;\nalign-items: center;\njustify-content: center;\ndisplay: flex;\ncolor: rgba(255,255,255,0);\nposition: absolute;\ntop: 0;\nleft:0;\nwidth: 100vw;\nheight: 100vh;\ntext-align: center;\npointer-events: none;\ntransition: background-color 3s ease-out, color 3s ease-out;\ntext-transform: uppercase;\nfont-family: monospace;\n    ",document.getElementById("wrapper").appendChild(this.div)}show(e){clearTimeout(this.timeoutHandler),this.div.style.transition="3s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.backgroundColor="rgba(0,0,0,0.5)",this.div.style.color="rgba(255,255,255,1)"}flash(e){clearTimeout(this.timeoutHandler),this.div.style.transition="0.5s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.color="rgba(255,255,255,1)",this.timeoutHandler=setTimeout(()=>this.div.style.color="rgba(255,255,255,0)",500)}},X=e=>{const t=kontra.sprite({x:y/2,y:b/2,collisionRadius:30,map:e,infected:!1,gameOver:!1,direction:"N",nextDirection:null,dropBomb:!1,scale:1,dropping:!1,bombCoolingDown:!1,update(){({nextDirection:this.nextDirection,direction:this.direction,dropBomb:this.dropBomb,scale:this.scale,bombCoolingDown:this.bombCoolingDown}=B(this,v,Y))},render(){z(this)},infect(e){c(e,this)&&(this.infected=!0,this.gameOver||(Y.show("player infected<br>game over"),v.publish(x)))}});return v.subscribe(x,()=>t.gameOver=!0),v.subscribe(2,()=>t.dropping=!0),t},z=e=>{const{context:t,x:s,y:n,direction:l,infected:p,scale:c}=e;t.save(),t.translate(s,n),t.scale(c,c),t.rotate((e=>{switch(e){case r:return h(0);case i:return h(90);case a:return h(180);case o:return h(270);default:return null}})(l)),t.lineWidth=3,t.strokeStyle=p?"#cd3926":"#75a042",t.fillStyle=p?"#7a2431":"#365b1d",t.beginPath(),t.moveTo(-15,25),t.lineTo(0,-25),t.lineTo(15,25),t.closePath(),t.fill(),t.stroke(),t.restore()},B=e=>{let{nextDirection:t,direction:s,dropBomb:h,scale:l,bombCoolingDown:p}=e;const{dropping:c}=e;if(c)return l>0?l-=.01:(Y.show("You fell into the abyss<br>Game over"),v.publish(x)),{direction:s,nextDirection:t,dropBomb:h,scale:l,bombCoolingDown:p};const{map:u,x:f,y:m,gameOver:_}=e;if(_||(({nextDirection:t,dropBomb:h}=(e=>{let{nextDirection:t,dropBomb:s}=e;return kontra.keys.pressed("right")&&(t=i),kontra.keys.pressed("left")&&(t=o),kontra.keys.pressed("up")&&(t=r),kontra.keys.pressed("down")&&(t=a),kontra.keys.pressed("space")&&(s=!0),{nextDirection:t,dropBomb:s}})(e)),p&&(h=!1)),!(({x:e,y:t})=>(e-g/2)%g==0&&(t-w/2)%w==0)({x:u.sx,y:u.sy}))return{direction:s,nextDirection:t,dropBomb:h,scale:l,bombCoolingDown:p};if(t&&n(u,{x:f,y:m},t))s=t,t=null;else try{s=d(u,{x:f,y:m},s)}catch({message:e}){"dropped"===e&&v.publish(2)}return h&&(v.publish(k,(({sx:e,sy:t,tileWidth:s,tileHeight:r})=>({col:Math.floor(e/s)+1,row:Math.floor(t/r)+1}))(u)),h=!1,p=!0,setTimeout(()=>{e.bombCoolingDown=!1},100)),{direction:s,nextDirection:t,dropBomb:h,scale:l,bombCoolingDown:p}};var H=({map:e,row:t,col:s})=>{const{x:r,y:i}=p(e,{row:t,col:s});return kontra.sprite({x:r,y:i,collisionRadius:30,infected:!1,map:e,mapX:(s-1)*g,mapY:(t-1)*w,status:0,update(){({x:this.x,y:this.y}=p(this.map,{x:this.mapX,y:this.mapY}))},render(){j(this)},infect(){this.status=2,v.publish(T)}})};const G={0:{fg:"#52638a",bg:"#2b3653"},1:{fg:"#75a042",bg:"#365b1d"},2:{fg:"#cd3926",bg:"#7a2431"}};var j=e=>{const{context:t,x:s,y:r,status:i}=e,{fg:a,bg:o}=G[i];t.save(),t.translate(s,r),t.lineWidth=3,t.strokeStyle=a,t.fillStyle=o,t.beginPath(),t.moveTo(-40,40),t.lineTo(-40,20),t.arc(-20,20,20,h(180),h(270)),t.moveTo(-20,0),t.lineTo(20,0),t.arc(20,20,20,h(270),h(0)),t.lineTo(40,40),t.lineTo(-40,40),t.moveTo(-23,20),t.lineTo(-23,40),t.moveTo(23,20),t.lineTo(23,40),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-15,25,h(0),h(360)),t.fill(),t.stroke(),t.restore()},F=e=>{const{x:t,y:s}=p(e,{row:4,col:5}),r=new Q,i=kontra.sprite({x:t,y:s,collisionRadius:30,map:e,mapX:4*g,mapY:3*w,direction:"W",blips:r,update(){({x:this.x,y:this.y,mapX:this.mapX,mapY:this.mapY,direction:this.direction}=U(this)),this.blips.update()},render(){J(this),this.blips.render()}});return r.start(i),i};const N=Array(20).fill().map(()=>Array(20).fill(0));var U=e=>{let{direction:t,x:s,y:h}=e;const{map:c}=e,{mapX:m,mapY:_}=(({mapX:e,mapY:t,direction:s})=>{switch(s){case r:return{mapX:e,mapY:t-2.5};case i:return{mapX:e+2.5,mapY:t};case a:return{mapX:e,mapY:t+2.5};case o:return{mapX:e-2.5,mapY:t};default:return{mapX:e,mapY:t}}})(e);if((({mapX:e,mapY:t})=>e%g==0&&t%w==0)({mapX:m,mapY:_})){const e=c.tileAtLayer("main",{x:s,y:h}),p=m/g+1,y=_/w+1;if(N[y-1][p-1]=N[y-1][p-1]+1,(e=>f.includes(e))(e)){const{allowed:d}=u[e],f=(({viable:e,visits:t,row:s,col:n})=>{let h=Number.MAX_SAFE_INTEGER;return e.map(e=>{let l;switch(e){case r:l=t[s-2][n-1];break;case i:l=t[s-1][n];break;case a:l=t[s][n-1];break;case o:l=t[s-1][n-2]}return h=l<h?l:h,{dir:e,vis:l}}).filter(({vis:e})=>e===h).map(({dir:e})=>e)})({viable:d.filter(e=>e!==(e=>{switch(e){case r:return a;case i:return o;case a:return r;case o:return o;default:return null}})(t)&&n(c,{x:s,y:h},e)),visits:N,row:y,col:p});t=f[l(0,f.length-1)]}else t=d(c,{x:s,y:h},t)}return({x:s,y:h}=p(c,{x:m,y:_})),{direction:t,mapY:_,mapX:m,x:s,y:h}},J=e=>{const{context:t,x:s,y:r}=e;t.save(),t.translate(s,r),t.lineWidth=3,t.strokeStyle="#cd3926",t.fillStyle="#7a2431",t.beginPath(),t.moveTo(l(-5,5),l(-5,-25)),t.lineTo(l(5,50),l(-5,-50)),t.lineTo(l(5,25),l(-5,5)),t.lineTo(l(5,50),l(5,50)),t.lineTo(l(-5,5),l(5,25)),t.lineTo(l(-5,-50),l(5,50)),t.lineTo(l(-5,-25),l(-5,5)),t.lineTo(l(-5,-50),l(-5,-50)),t.closePath(),t.fill(),t.stroke(),t.restore()},$=({x:e,y:t})=>kontra.sprite({x:e,y:t,ttl:180,radius:w,update(){this.radius+=10,this.ttl--},render(){K(this)}}),K=e=>{const{context:t,x:s,y:r,radius:i}=e;t.save(),t.translate(s,r),t.lineWidth=1,t.strokeStyle="#cd3926",t.beginPath(),t.arc(0,0,i,h(0),h(360)),t.closePath(),t.stroke(),t.restore()},Q=class{constructor(){this.blips=[]}start(e){setInterval(()=>{this.blips.push($({x:e.x,y:e.y}))},1e3)}update(){this.blips.forEach(e=>e.update()),this.blips=this.blips.filter(e=>e.ttl>0)}render(){this.blips.forEach(e=>e.render())}},V=(e,{row:t,col:s})=>{const{x:r,y:i}=p(e,{row:t,col:s});return kontra.sprite({x:r,y:i,collisionRadius:30,fuseLength:100,status:Z,shrapnel:[],explosionDuration:0,map:e,mapX:(s-1)*g,mapY:(t-1)*w,row:t,col:s,update(){({status:this.status,fuseLength:this.fuseLength,explosionDuration:this.explosionDuration,x:this.x,y:this.y}=se(this))},render(){ee(this)}})};const Z=0;var ee=e=>{const{status:t,shrapnel:s}=e;switch(t){case Z:te(e);break;case 1:s.forEach(e=>e.render())}},te=e=>{const{context:t,x:s,y:r,fuseLength:i}=e;t.save(),t.translate(s,r),t.rotate(h(-45)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(23,-10),t.lineTo(40,-10),t.lineTo(40,10),t.lineTo(23,10),t.arc(0,0,25,h(19),h(341)),t.fill(),t.stroke();const a=i/100*90;t.beginPath(),t.moveTo(40,0),t.arc(40,25,25,h(270),h(270+a)),t.stroke();const o=25*Math.cos(h(a-90))+40,n=25*Math.sin(h(a-90))+25;t.fillStyle="#cd3926";for(let e=0;e<10;e++){const e=Math.cos(h(l(0,360)))*l(0,15)+o,s=Math.sin(h(l(0,360)))*l(0,15)+n;t.fillRect(e-1,s-1,3,3)}t.restore()},se=e=>{let{status:t,fuseLength:s,explosionDuration:r,x:i,y:a}=e;const{shrapnel:o,map:n,mapX:h,mapY:l,row:c,col:d}=e;switch(({x:i,y:a}=p(n,{x:h,y:l})),t){case Z:if((s-=1)<0){t=1,v.publish(M);for(let e=0;e<50;e++)o.push(re({x:i,y:a}));const e=n.tileAtLayer("main",{row:c+3-1,col:d+4-1});n.changeTile("main",{row:c+3,col:d+4},e+24)}break;case 1:o.forEach(e=>e.update()),200===++r&&(t=2)}return{status:t,fuseLength:s,explosionDuration:r,x:i,y:a}},re=({x:e,y:t})=>{const s=l(0,360),r=l(5,15);return kontra.sprite({x:e,y:t,dx:Math.cos(h(s))*r,dy:Math.sin(h(s))*r,rotation:l(0,360),rotationDir:[l(-10,-1),l(1,10)][l(0,1)],update(){this.advance(),this.rotation+=this.rotationDir},render(){(e=>{const{context:t,x:s,y:r,rotation:i}=e;t.save(),t.translate(s,r),t.rotate(h(i)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(0,-10),t.lineTo(10,5),t.lineTo(-10,5),t.closePath(),t.fill(),t.stroke(),t.restore()})(this)}})},ie={chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encLookup:[],Init:function(){for(var e=0;e<4096;e++)this.encLookup[e]=this.chars[e>>6]+this.chars[63&e]},Encode:function(e){var t=e.length,s="",r=0;let i;for(;t>2;)i=e[r]<<16|e[r+1]<<8|e[r+2],s+=this.encLookup[i>>12]+this.encLookup[4095&i],t-=3,r+=3;if(t>0){var a=(252&e[r])>>2,o=(3&e[r])<<4;if(t>1&&(o|=(240&e[++r])>>4),s+=this.chars[a],s+=this.chars[o],2==t){var n=(15&e[r++])<<2;n|=(192&e[r])>>6,s+=this.chars[n]}1==t&&(s+="="),s+="="}return s}};ie.Init();var ae=function(e){function t(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]}function s(e){return[255&e,e>>8&255]}this.data=[],this.wav=[],this.dataURI="",this.header={chunkId:[82,73,70,70],chunkSize:0,format:[87,65,86,69],subChunk1Id:[102,109,116,32],subChunk1Size:16,audioFormat:1,numChannels:1,sampleRate:8e3,byteRate:0,blockAlign:0,bitsPerSample:8,subChunk2Id:[100,97,116,97],subChunk2Size:0},this.Make=function(e){e instanceof Array&&(this.data=e),this.header.byteRate=this.header.sampleRate*this.header.numChannels*this.header.bitsPerSample>>3,this.header.blockAlign=this.header.numChannels*this.header.bitsPerSample>>3,this.header.subChunk2Size=this.data.length,this.header.chunkSize=36+this.header.subChunk2Size,this.wav=this.header.chunkId.concat(t(this.header.chunkSize),this.header.format,this.header.subChunk1Id,t(this.header.subChunk1Size),s(this.header.audioFormat),s(this.header.numChannels),t(this.header.sampleRate),t(this.header.byteRate),s(this.header.blockAlign),s(this.header.bitsPerSample),this.header.subChunk2Id,t(this.header.subChunk2Size),this.data),this.dataURI="data:audio/wav;base64,"+ie.Encode(this.wav)},e instanceof Array&&this.Make(e)},oe=0;function ne(e){return e*e}Math.pow;function he(){this.oldParams=!0,this.wave_type=oe,this.p_env_attack=0,this.p_env_sustain=.3,this.p_env_punch=0,this.p_env_decay=.4,this.p_base_freq=.3,this.p_freq_limit=0,this.p_freq_ramp=0,this.p_freq_dramp=0,this.p_vib_strength=0,this.p_vib_speed=0,this.p_arp_mod=0,this.p_arp_speed=0,this.p_duty=0,this.p_duty_ramp=0,this.p_repeat_speed=0,this.p_pha_offset=0,this.p_pha_ramp=0,this.p_lpf_freq=1,this.p_lpf_ramp=0,this.p_lpf_resonance=0,this.p_hpf_freq=0,this.p_hpf_ramp=0,this.sound_vol=.5,this.sample_rate=44100,this.sample_size=8}function le(e){return Math.random()*e}function pe(e){return Math.floor(Math.random()*(e+1))}function ce(e){this.initFromUI(e)}he.prototype.explosion=function(){return this.wave_type=3,pe(1)?(this.p_base_freq=ne(.1+le(.4)),this.p_freq_ramp=-.1+le(.4)):(this.p_base_freq=ne(.2+le(.7)),this.p_freq_ramp=-.2-le(.2)),0===pe(4)&&(this.p_freq_ramp=0),0===pe(2)&&(this.p_repeat_speed=.3+le(.5)),this.p_env_attack=0,this.p_env_sustain=.1+le(.3),this.p_env_decay=le(.5),pe(1)&&(this.p_pha_offset=-.3+le(.9),this.p_pha_ramp=-le(.3)),this.p_env_punch=.2+le(.6),pe(1)&&(this.p_vib_strength=le(.7),this.p_vib_speed=le(.6)),0===pe(2)&&(this.p_arp_speed=.6+le(.3),this.p_arp_mod=.8-le(1.6)),this},he.prototype.hitHurt=function(){return this.wave_type=pe(2),2===this.wave_type&&(this.wave_type=3),this.wave_type===oe&&(this.p_duty=le(.6)),1===this.wave_type&&(this.p_duty=1),this.p_base_freq=.2+le(.6),this.p_freq_ramp=-.3-le(.4),this.p_env_attack=0,this.p_env_sustain=le(.1),this.p_env_decay=.1+le(.2),pe(1)&&(this.p_hpf_freq=le(.3)),this},he.prototype.jump=function(){return this.wave_type=oe,this.p_duty=le(.6),this.p_base_freq=.3+le(.3),this.p_freq_ramp=.1+le(.2),this.p_env_attack=0,this.p_env_sustain=.1+le(.3),this.p_env_decay=.1+le(.2),pe(1)&&(this.p_hpf_freq=le(.3)),pe(1)&&(this.p_lpf_freq=1-le(.6)),this},he.prototype.mutate=function(){pe(1)&&(this.p_base_freq+=le(.1)-.05),pe(1)&&(this.p_freq_ramp+=le(.1)-.05),pe(1)&&(this.p_freq_dramp+=le(.1)-.05),pe(1)&&(this.p_duty+=le(.1)-.05),pe(1)&&(this.p_duty_ramp+=le(.1)-.05),pe(1)&&(this.p_vib_strength+=le(.1)-.05),pe(1)&&(this.p_vib_speed+=le(.1)-.05),pe(1)&&(this.p_vib_delay+=le(.1)-.05),pe(1)&&(this.p_env_attack+=le(.1)-.05),pe(1)&&(this.p_env_sustain+=le(.1)-.05),pe(1)&&(this.p_env_decay+=le(.1)-.05),pe(1)&&(this.p_env_punch+=le(.1)-.05),pe(1)&&(this.p_lpf_resonance+=le(.1)-.05),pe(1)&&(this.p_lpf_freq+=le(.1)-.05),pe(1)&&(this.p_lpf_ramp+=le(.1)-.05),pe(1)&&(this.p_hpf_freq+=le(.1)-.05),pe(1)&&(this.p_hpf_ramp+=le(.1)-.05),pe(1)&&(this.p_pha_offset+=le(.1)-.05),pe(1)&&(this.p_pha_ramp+=le(.1)-.05),pe(1)&&(this.p_repeat_speed+=le(.1)-.05),pe(1)&&(this.p_arp_speed+=le(.1)-.05),pe(1)&&(this.p_arp_mod+=le(.1)-.05)},ce.prototype.initFromUI=function(e){this.initForRepeat=function(){this.elapsedSinceRepeat=0,this.period=100/(e.p_base_freq*e.p_base_freq+.001),this.periodMax=100/(e.p_freq_limit*e.p_freq_limit+.001),this.enableFrequencyCutoff=e.p_freq_limit>0,this.periodMult=1-.01*Math.pow(e.p_freq_ramp,3),this.periodMultSlide=1e-6*-Math.pow(e.p_freq_dramp,3),this.dutyCycle=.5-.5*e.p_duty,this.dutyCycleSlide=5e-5*-e.p_duty_ramp,e.p_arp_mod>=0?this.arpeggioMultiplier=1-.9*Math.pow(e.p_arp_mod,2):this.arpeggioMultiplier=1+10*Math.pow(e.p_arp_mod,2),this.arpeggioTime=Math.floor(2e4*Math.pow(1-e.p_arp_speed,2)+32),1===e.p_arp_speed&&(this.arpeggioTime=0)},this.initForRepeat(),this.waveShape=parseInt(e.wave_type),this.fltw=.1*Math.pow(e.p_lpf_freq,3),this.enableLowPassFilter=1!=e.p_lpf_freq,this.fltw_d=1+1e-4*e.p_lpf_ramp,this.fltdmp=5/(1+20*Math.pow(e.p_lpf_resonance,2))*(.01+this.fltw),this.fltdmp>.8&&(this.fltdmp=.8),this.flthp=.1*Math.pow(e.p_hpf_freq,2),this.flthp_d=1+3e-4*e.p_hpf_ramp,this.vibratoSpeed=.01*Math.pow(e.p_vib_speed,2),this.vibratoAmplitude=.5*e.p_vib_strength,this.envelopeLength=[Math.floor(e.p_env_attack*e.p_env_attack*1e5),Math.floor(e.p_env_sustain*e.p_env_sustain*1e5),Math.floor(e.p_env_decay*e.p_env_decay*1e5)],this.envelopePunch=e.p_env_punch,this.flangerOffset=1020*Math.pow(e.p_pha_offset,2),e.p_pha_offset<0&&(this.flangerOffset=-this.flangerOffset),this.flangerOffsetSlide=1*Math.pow(e.p_pha_ramp,2),e.p_pha_ramp<0&&(this.flangerOffsetSlide=-this.flangerOffsetSlide),this.repeatTime=Math.floor(2e4*Math.pow(1-e.p_repeat_speed,2)+32),0===e.p_repeat_speed&&(this.repeatTime=0),this.gain=Math.exp(e.sound_vol)-1,this.sampleRate=e.sample_rate,this.bitsPerChannel=e.sample_size},ce.prototype.generate=function(){for(var e=0,t=0,s=0,r=Array(32),i=0;i<32;++i)r[i]=2*Math.random()-1;var a=0,o=0,n=0,h=0,l=0,p=Array(1024);for(i=0;i<1024;++i)p[i]=0;for(var c=0,d=[],u=0,f=0,m=Math.floor(44100/this.sampleRate),_=0;0!=this.repeatTime&&++this.elapsedSinceRepeat>=this.repeatTime&&this.initForRepeat(),0!=this.arpeggioTime&&_>=this.arpeggioTime&&(this.arpeggioTime=0,this.period*=this.arpeggioMultiplier),this.periodMult+=this.periodMultSlide,this.period*=this.periodMult,!(this.period>this.periodMax&&(this.period=this.periodMax,this.enableFrequencyCutoff));++_){var y=this.period;this.vibratoAmplitude>0&&(n+=this.vibratoSpeed,y=this.period*(1+Math.sin(n)*this.vibratoAmplitude));var b,g=Math.floor(y);if(g<8&&(g=8),this.dutyCycle+=this.dutyCycleSlide,this.dutyCycle<0&&(this.dutyCycle=0),this.dutyCycle>.5&&(this.dutyCycle=.5),++o>this.envelopeLength[a]&&(o=0,++a>2))break;var w=o/this.envelopeLength[a];b=0===a?w:1===a?1+2*(1-w)*this.envelopePunch:1-w,this.flangerOffset+=this.flangerOffsetSlide;var v=Math.abs(Math.floor(this.flangerOffset));v>1023&&(v=1023),0!=this.flthp_d&&(this.flthp*=this.flthp_d,this.flthp<1e-5&&(this.flthp=1e-5),this.flthp>.1&&(this.flthp=.1));for(var x=0,k=0;k<8;++k){var M=0;if(++h>=g&&(h%=g,3===this.waveShape))for(i=0;i<32;++i)r[i]=2*Math.random()-1;var T=h/g;if(this.waveShape===oe)M=T<this.dutyCycle?.5:-.5;else if(1===this.waveShape)M=T<this.dutyCycle?2*T/this.dutyCycle-1:1-2*(T-this.dutyCycle)/(1-this.dutyCycle);else if(2===this.waveShape)M=Math.sin(2*T*Math.PI);else{if(3!==this.waveShape)throw"ERROR: Bad wave type: "+this.waveShape;M=r[Math.floor(32*h/g)]}var S=e;this.fltw*=this.fltw_d,this.fltw<0&&(this.fltw=0),this.fltw>.1&&(this.fltw=.1),this.enableLowPassFilter?(t+=(M-e)*this.fltw,t-=t*this.fltdmp):(e=M,t=0),s+=(e+=t)-S,M=s-=s*this.flthp,p[1023&l]=M,M+=p[l-v+1024&1023],l=l+1&1023,x+=M*b}u+=x,++f>=m&&(f=0,x=u/m,u=0,x=x/8*1,x*=this.gain,8===this.bitsPerChannel?((x=Math.floor(128*(x+1)))>255?(x=255,++c):x<0&&(x=0,++c),d.push(x)):((x=Math.floor(32768*x))>=32768?(x=32767,++c):x<-32768&&(x=-32768,++c),d.push(255&x),d.push(x>>8&255)))}var C=new ae;return C.header.sampleRate=this.sampleRate,C.header.bitsPerSample=this.bitsPerChannel,C.Make(d),C.clipping=c,C};var de={Params:he,SoundEffect:ce};const{SoundEffect:ue,Params:fe}=de,me={};function _e(e){const t=new fe;t[e]();var s=new Audio;const r=new ue(t).generate();s.src=r.dataURI,me[e]=s}_e("jump"),_e("explosion"),_e("mutate"),_e("hitHurt"),(async()=>{(()=>{const e=document.createElement("canvas");e.width=y,e.height=b,e.style.cssText="\n        border: 4px solid #52638a;\n    ",document.getElementById("wrapper").appendChild(e)})(),kontra.init();const e=await W(),t=X(e),s=F(e),r=new class{constructor(e){this.map=e,this.bombs=[],v.subscribe(k,e=>this.dropBomb(e))}dropBomb(e){this.bombs.length>0&&this.bombs.find(({col:t,row:s})=>t===e.col&&s===e.row)||this.bombs.push(V(this.map,e))}update(){this.bombs=this.bombs.filter(e=>(e.update(),2!==e.status))}render(){this.bombs.forEach(e=>e.render())}}(e),i=new class{constructor(e){this.map=e,this.users=[],this.gameOver=!1;for(let t=1;t<=26;t++)for(let s=1;s<=28;s++){const r=e.tileAtLayer("main",{row:t,col:s});r>=17&&r<=20&&this.users.push(H({map:e,row:t-3+1,col:s-4+1}))}v.subscribe(x,()=>this.gameOver=!0)}update(){this.users.forEach(e=>e.update())}render(){this.users.forEach(e=>e.render())}infect(e){const{users:t,gameOver:s}=this,r=((e,t)=>{const s=[];for(let r=0;r<e.length;r++){const i=e[r];for(let e=0;e<t.length;e++){const r=t[e];c(i,r)&&s.push([i,r])}}return s})(t,e).filter(([e])=>2!==e.status);if(0!==r.length&&(r.forEach(([e])=>e.infect()),!s))return(e=>e.every(e=>2===e.state))(t)?(Y.show("all users infected<br>game over"),void v.publish(x)):void Y.flash("user infected!")}}(e),a=S({map:e,player:t,virus:s,users:i,bombs:r});console.log("init audio"),v.subscribe(k,()=>me.jump.play()),v.subscribe(M,()=>me.explosion.play()),v.subscribe(T,()=>me.mutate.play()),v.subscribe(x,()=>me.hitHurt.play()),a.start()})()}]);
//# sourceMappingURL=game.js.map
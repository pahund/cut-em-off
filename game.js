!function(){"use strict";var e=new class{constructor(){this.subscribers=[]}subscribe(e,t){this.subscribers.push({message:e,callback:t})}reset(e,t=null){this.subscribers=this.subscribers.filter(({message:t})=>t!==e),t&&this.subscribe(e,t)}publish(e,t){this.subscribers.forEach(({message:r,callback:s})=>r===e&&s(t))}};const t=0,r=1,s=2,o=4,n=5,a=6;const i=new function(){let e,t,r,s,o,n,a,i,l,c,h,d;this._params=new function(){this.setSettings=function(e){for(let t=0;t<24;t++)this[String.fromCharCode(97+t)]=e[t]||0;this.c<.01&&(this.c=.01);const t=this.b+this.c+this.e;if(t<.18){const e=.18/t;this.b*=e,this.c*=e,this.e*=e}}},this.reset=function(){const e=this._params;s=100/(e.f*e.f+.001),o=100/(e.g*e.g+.001),n=1-e.h*e.h*e.h*.01,a=-e.i*e.i*e.i*1e-6,e.a||(h=.5-e.n/2,d=5e-5*-e.o),i=e.l>0?1-e.l*e.l*.9:1+e.l*e.l*10,l=0,c=1==e.m?0:(1-e.m)*(1-e.m)*2e4+32},this.totalReset=function(){this.reset();const s=this._params;return e=s.b*s.b*1e5,t=s.c*s.c*1e5,r=s.e*s.e*1e5+10,e+t+r|0},this.synthWave=function(p,u){const f=this._params,m=1!=f.s||f.v;let g=f.v*f.v*.1;const b=1+3e-4*f.w;let w=f.s*f.s*f.s*.1;const y=1+1e-4*f.t,x=1!=f.s,v=f.x*f.x,k=f.g,T=f.q||f.r,S=f.r*f.r*f.r*.2;let M=f.q*f.q*(f.q<0?-1020:1020);const A=f.p?32+((1-f.p)*(1-f.p)*2e4|0):0,C=f.d,E=f.j/2,Y=f.k*f.k*.01,X=f.a;let D=e;const L=1/e,P=1/t,R=1/r;let O=5/(1+f.u*f.u*20)*(.01+w);O>.8&&(O=.8),O=1-O;let I,W,B,H,G=!1,$=0,_=0,N=0,U=0,q=0,z=0,F=0,j=0,J=0;var K,Q;let V=0;const Z=new Array(1024),ee=new Array(32);for(var te=Z.length;te--;)Z[te]=0;for(te=ee.length;te--;)ee[te]=2*Math.random()-1;for(te=0;te<u;te++){if(G)return te;if(A&&++J>=A&&(J=0,this.reset()),c&&++l>=c&&(c=0,s*=i),(s*=n+=a)>o&&(s=o,k>0&&(G=!0)),W=s,E>0&&(V+=Y,W*=1+Math.sin(V)*E),(W|=0)<8&&(W=8),X||((h+=d)<0?h=0:h>.5&&(h=.5)),++_>D)switch(_=0,++$){case 1:D=t;break;case 2:D=r}switch($){case 0:N=_*L;break;case 1:N=1+2*(1-_*P)*C;break;case 2:N=1-_*R;break;case 3:N=0,G=!0}T&&((B=0|(M+=S))<0?B=-B:B>1023&&(B=1023)),m&&b&&((g*=b)<1e-5?g=1e-5:g>.1&&(g=.1)),Q=0;for(let e=8;e--;){if(++F>=W&&(F%=W,3==X))for(let e=ee.length;e--;)ee[e]=2*Math.random()-1;switch(X){case 0:K=F/W<h?.5:-.5;break;case 1:K=1-F/W*2;break;case 2:K=(K=(H=(H=F/W)>.5?6.28318531*(H-1):6.28318531*H)<0?1.27323954*H+.405284735*H*H:1.27323954*H-.405284735*H*H)<0?.225*(K*-K-K)+K:.225*(K*K-K)+K;break;case 3:K=ee[Math.abs(32*F/W|0)]}m&&(I=z,(w*=y)<0?w=0:w>.1&&(w=.1),x?(q+=(K-z)*w,q*=O):(z=K,q=0),U+=(z+=q)-I,K=U*=1-g),T&&(Z[j%1024]=K,K+=Z[(j-B+1024)%1024],j++),Q+=K}Q*=.125*N*v,p[te]=Q>=1?32767:Q<=-1?-32768:32767*Q|0}return u}};function l(e){i._params.setSettings(e);const t=i.totalReset(),r=new Uint8Array(4*((t+1)/2|0)+44);let s=2*i.synthWave(new Uint16Array(r.buffer,44),t);const o=new Uint32Array(r.buffer,0,44);o[0]=1179011410,o[1]=s+36,o[2]=1163280727,o[3]=544501094,o[4]=16,o[5]=65537,o[6]=44100,o[7]=88200,o[8]=1048578,o[9]=1635017060,o[10]=s,s+=44;let n=0;const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";let l="data:audio/wav;base64,";for(;n<s;n+=3){const e=r[n]<<16|r[n+1]<<8|r[n+2];l+=a[e>>18]+a[e>>12&63]+a[e>>6&63]+a[63&e]}return n-=s,l.slice(0,l.length-n)+"==".slice(0,n)}function c(){var e;this.sounds={},(e=this).add("infected",3,[[2,,.2916,,.2587,.9356,.3909,-.2493,,,,,,.3583,.1617,,,,1,,,.1217,,.5]]),e.add("drop-bomb",3,[[0,,.0641,.5296,.1228,.4195,,,,,,.3029,.6261,,,,,,1,,,,,.5]]),e.add("drop-ship",1,[[0,,.57,,.1398,.61,,-.26,.1,,,.02,,.3325,,,,,.9793,,,,,.5]]),e.add("explode",3,[[3,,.4,.91,.25,.21,,-.38,,,,,,,,,-.0403,-.186,1,,,,,.5]])}c.prototype.add=function(e,t,r){this.sounds[e]=[],r.forEach(function(r,s){this.sounds[e].push({tick:0,count:t,pool:[]});for(let o=0;o<t;o++){const t=new Audio;t.src=l(r),this.sounds[e][s].pool.push(t)}},this)},c.prototype.play=function(e){const t=this.sounds[e],r=t.length>1?t[Math.floor(Math.random()*t.length)]:t[0];r.pool[r.tick].play(),r.tick<r.count-1?r.tick++:r.tick=0};const h=new c;const d=1e3;var p=(e,{row:t,col:r})=>{const{x:s,y:o}=e.getXAndY({row:t,col:r});return{context:kontra.context,x:s,y:o,collisionRadius:30,fuseLength:100,status:u,shrapnel:[],explosionDuration:0,map:e,mapX:100*r,mapY:100*t,row:t,col:r,update(){({status:this.status,fuseLength:this.fuseLength,explosionDuration:this.explosionDuration,x:this.x,y:this.y}=W(this))},render(){m(this)}}};const u=0,f=2;var m=e=>{const{status:t,shrapnel:r}=e;switch(t){case u:D(e);break;case 1:r.forEach(e=>e.render())}},g=({col:e,row:t})=>({sx:100*e-400+50,sy:100*t-300+50});const b="N",w="E",y="S",x="W";var v=(e,{x:t,y:r},s)=>{const o=e.tileAtLayer("main",{x:t,y:r});if(!X(o)||!T[o].allowed.includes(s))return!1;const n=M(e,{x:t,y:r},s);return X(n)},k=(e,{x:t,y:r},s)=>{const o=e.tileAtLayer("main",{x:t,y:r});if(!X(o))throw new Error("dropped");const n=T[o].change[s]||s;if(v(e,{x:t,y:r},n))return n;const a=T[o].allowed.filter(s=>v(e,{x:t,y:r},s));switch(a.length){case 0:throw new Error("locked in");case 1:return a[0];default:return a[C(0,a.length-1)]}},T={1:{allowed:[y,w],change:{[b]:w,[x]:y}},2:{allowed:[x,y],change:{[b]:x,[w]:y}},3:{allowed:[b,y],change:{}},4:{allowed:[x,b,w],change:{[y]:b}},5:{allowed:[b,w,y],change:{[x]:w}},6:{allowed:[x,w,y],change:{[b]:y}},9:{allowed:[b,w],change:{[y]:w,[x]:b}},10:{allowed:[x,b],change:{[w]:b,[y]:x}},11:{allowed:[x,w],change:{}},12:{allowed:[b,w,y,x],change:{}},13:{allowed:[b,y,x],change:{[w]:x}},7:{allowed:[y],change:{[b]:y}},8:{allowed:[x],change:{[w]:x}},15:{allowed:[b],change:{[y]:b}},16:{allowed:[w],change:{[x]:w}}};const S=[];for(const[e,{allowed:t}]of Object.entries(T))t.length>2&&S.push(Number(e));var M=(e,{x:t,y:r},s)=>e.tileAtLayer("main",{x:s===w?t+100:s===x?t-100:t,y:s===b?r-100:s===y?r+100:r}),A=e=>e*Math.PI/180,C=(e,t)=>{const r=Math.min(e,t),s=Math.max(e,t);return Math.floor(Math.random()*(s-r+1))+r},E=(e,t)=>{const r=[];for(let s=0;s<e.length;s++){const o=e[s];for(let e=0;e<t.length;e++){const s=t[e];Y(o,s)&&r.push([o,s])}}return r},Y=(e,t)=>{const r=e.x-t.x,s=e.y-t.y;return Math.sqrt(r*r+s*s)<e.collisionRadius+t.collisionRadius},X=e=>e>=1&&e<=16,D=e=>{const{context:t,x:r,y:s,fuseLength:o}=e;t.save(),t.translate(r,s),t.rotate(A(-45)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(23,-10),t.lineTo(40,-10),t.lineTo(40,10),t.lineTo(23,10),t.arc(0,0,25,A(19),A(341)),t.fill(),t.stroke();const n=o/100*90;t.beginPath(),t.moveTo(40,0),t.arc(40,25,25,A(270),A(270+n)),t.stroke();const a=25*Math.cos(A(n-90))+40,i=25*Math.sin(A(n-90))+25;t.fillStyle="#cd3926";for(let e=0;e<10;e++){const e=Math.cos(A(C(0,360)))*C(0,15)+a,r=Math.sin(A(C(0,360)))*C(0,15)+i;t.fillRect(e-1,r-1,3,3)}t.restore()};var L=new class{constructor(){this.timeoutHandler=null,this.div=document.createElement("div"),this.div.setAttribute("id","mbx"),document.getElementById("wrapper").appendChild(this.div)}show(e){clearTimeout(this.timeoutHandler),this.div.style.transition="3s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.opacity=1}flash(e){clearTimeout(this.timeoutHandler),this.div.style.transition="0.5s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.opacity=1,this.timeoutHandler=setTimeout(()=>this.div.style.opacity=0,500)}clear(){clearTimeout(this.timeoutHandler),this.div.style.transition="0.5s",this.div.style.opacity=0}};var P=new class{constructor(){this.servers=[],this.nextServerPointer=0,this.gameOver=!1,e.subscribe(t,()=>this.gameOver=!0)}init(e,t=[]){return this.map=e,t.forEach(({col:t,row:r})=>this.servers.push(R({map:e,row:r,col:t}))),this}update(){this.servers.forEach(e=>e.update())}render(){this.servers.forEach(e=>e.render())}destroy({col:e,row:t}){const r=this.find({col:e,row:t});r&&(r.broken=!0)}infect(e){const t=this.getAvailableServers(),r=E(t,[e]);0!==r.length&&(r.forEach(([e])=>{e.infected=!0}),this.gameOver||(0!==this.getAvailableServers().length?L.flash("server infected!"):L.flash("all servers destroyed or infected – be careful")))}find({col:e,row:t}){return this.servers.find(r=>r.col===e&&r.row===t)}getAvailableServers(){return this.servers.filter(e=>!(e.broken||e.infected))}getRandom(){const e=this.getAvailableServers();return e[Math.floor(Math.random()*e.length)]}getNext(){const e=this.getAvailableServers(),t=this.nextServerPointer+1<e.length;return this.nextServerPointer=t?this.nextServerPointer+1:0,e[this.nextServerPointer]}getInfectedServers(){return this.servers.filter(e=>e.infected)}},R=({map:e,row:t,col:r})=>{const{x:s,y:o}=e.getXAndY({row:t,col:r});return{context:kontra.context,x:s,y:o,row:t,col:r,map:e,mapX:100*r,mapY:100*t,broken:!1,infected:!1,collisionRadius:30,update(){({x:this.x,y:this.y}=e.getXAndY({mapX:this.mapX,mapY:this.mapY}))},render(){I(this)}}},O=(e,t)=>t.forEach(([t,r,s])=>e[t?"lineTo":"moveTo"](r,s)),I=e=>{const{context:t,x:r,y:s,broken:o,infected:n}=e;t.save(),t.translate(r,s),t.lineWidth=3,t.strokeStyle=n?"#cd3926":"#52638a",t.fillStyle=n?"#7a2431":"#2b3653",t.beginPath(),O(t,[[0,30,-48],[1,48,-30],[1,48,30],[1,30,48],[1,-30,48],[1,-48,30],[1,-48,-30],[1,-30,-48],[1,30,-48]]),t.fill(),t.stroke(),o&&(t.lineWidth=2,O(t,[[0,10,-48],[1,0,-40],[0,24,-48],[1,20,-30],[0,48,-27],[1,20,-20],[0,-10,-30],[1,10,-30],[1,30,-10],[1,20,0],[1,10,0],[0,48,7],[1,30,10],[0,20,0],[1,30,10],[1,10,20],[0,30,48],[1,30,30],[1,10,30],[0,20,20],[1,20,30],[0,-10,48],[1,-10,20],[1,0,10],[0,-20,0],[1,-20,20],[1,-10,30],[0,-30,48],[1,-20,40],[1,-20,30],[0,-30,30],[1,-20,40],[0,-48,20],[1,-30,20],[0,-40,20],[1,-40,10],[0,-48,0],[1,-30,0],[1,-20,-10],[0,-40,0],[1,-30,10],[0,-48,-17],[1,-40,-30],[1,-30,-20],[0,-30,-48],[1,-10,-20],[1,-10,-10],[0,-20,-30],[1,-20,-20],[1,-30,-10]]),t.stroke()),t.restore()},W=t=>{let{status:r,fuseLength:s,explosionDuration:a,x:i,y:l}=t;const{shrapnel:c,map:h,mapX:d,mapY:p,row:m,col:g}=t;switch(({x:i,y:l}=h.getXAndY({mapX:d,mapY:p})),r){case u:if((s-=1)<0){r=1,e.publish(n);for(let e=0;e<50;e++)c.push(B({x:i,y:l}));if(P.find({row:m,col:g}))P.destroy({row:m,col:g});else{const t=h.tileAtLayer("main",{row:m,col:g});h.changeTile("main",{row:m,col:g},t+16),e.publish(3,h),e.publish(o)}}break;case 1:c.forEach(e=>e.update()),200===++a&&(r=f)}return{status:r,fuseLength:s,explosionDuration:a,x:i,y:l}},B=({x:e,y:t})=>{const r=C(0,360),s=C(5,15);return{context:kontra.context,x:e,y:t,dx:Math.cos(A(r))*s,dy:Math.sin(A(r))*s,rotation:C(0,360),rotationDir:[C(-10,-1),C(1,10)][C(0,1)],update(){this.x+=this.dx,this.y+=this.dy,this.rotation+=this.rotationDir},render(){(e=>{const{context:t,x:r,y:s,rotation:o}=e;t.save(),t.translate(r,s),t.rotate(A(o)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(0,-10),t.lineTo(10,5),t.lineTo(-10,5),t.closePath(),t.fill(),t.stroke(),t.restore()})(this)}}};class H{constructor(t){this.map=t,this.bombs=[],e.subscribe(r,e=>this.dropBomb(e))}dropBomb(e){this.bombs.length>0&&this.bombs.find(({col:t,row:r})=>t===e.col&&r===e.row)||this.bombs.push(p(this.map,e))}update(){this.bombs=this.bombs.filter(e=>(e.update(),e.status!==f))}render(){this.bombs.forEach(e=>e.render())}}var G=({map:t,player:r,virus:o,users:n,bombs:a})=>{let i=!0;return e.subscribe(s,()=>i=!1),kontra.gameLoop({update(){o.update(),r.update(),r.infect([...P.getInfectedServers(),o]),r.teleport(),i&&(({map:e,direction:t,speed:r})=>{switch(t){case b:e.sy-=r;break;case w:e.sx+=r;break;case y:e.sy+=r;break;case x:e.sx-=r}})({map:t,...r}),n.update(),n.infect(o),a.update(),P.update(),P.infect(o)},render(){t.render(),n.render(),P.render(),a.render(),r.render(),o.render()}})};function $(e,t){return[Math.cos(A(e))*t+50,Math.sin(A(e))*t+50]}var _=({ctx:e,row:t,col:r,deg:s,broken:o=!1})=>{e.save(),e.translate(100*(r-1)+50,100*(t-1)+50),e.rotate(A(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),o?(e.moveTo(20,50),e.arc(50,50,30,A(180),A(190)),e.moveTo(...$(190,30)),e.lineTo(10,45),e.lineTo(10,35),e.lineTo(-10,40),e.lineTo(...$(190,70)),e.arc(50,50,70,A(190),A(180),!0),e.moveTo(50,20),e.arc(50,50,30,A(270),A(260),!0),e.moveTo(...$(260,30)),e.lineTo(40,10),e.lineTo(45,0),e.lineTo(35,0),e.lineTo(...$(260,70)),e.arc(50,50,70,A(260),A(270))):(e.moveTo(20,50),e.arc(50,50,30,A(180),A(270)),e.moveTo(-20,50),e.arc(50,50,70,A(180),A(270))),e.stroke(),e.restore()},N=({ctx:e,row:t,col:r,deg:s,broken:o=!1})=>{e.save(),e.translate(100*(r-1)+50,100*(t-1)+50),e.rotate(A(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),O(e,o?[[0,-20,50],[1,-20,30],[1,-10,40],[1,0,25],[1,10,35],[1,20,30],[1,20,50],[0,-20,-50],[1,-20,-40],[1,-10,-25],[1,0,-35],[1,10,-30],[1,20,-40],[1,20,-50]]:[[0,-20,-50],[1,-20,50],[0,20,-50],[1,20,50]]),e.stroke(),e.restore()},U=({ctx:e,row:t,col:r,deg:s,broken:o=!1})=>{e.save(),e.translate(100*(r-1)+50,100*(t-1)+50),e.rotate(A(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),O(e,o?[[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,50,20]]),e.stroke(),e.restore()},q=({ctx:e,row:t,col:r,broken:s=!1})=>{e.save(),e.translate(100*(r-1)+50,100*(t-1)+50),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),O(e,s?[[0,-20,50],[1,-20,45],[1,-10,40],[1,0,45],[1,10,35],[1,20,40],[1,20,50],[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,-20,20],[1,-20,50],[0,50,20],[1,20,20],[1,20,50]]),e.stroke(),e.restore()},z=({ctx:e,row:t,col:r,deg:s,broken:o=!1})=>{e.save(),e.translate(100*(r-1)+50,100*(t-1)+50),e.rotate(A(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),O(e,o?[[0,-20,50],[1,-20,40],[1,-10,45],[1,0,35],[1,10,45],[1,20,40],[1,20,50]]:[[0,-20,50],[1,-20,0],[1,20,0],[1,20,50]]),e.stroke(),e.restore()},F=(e={})=>{const t=e.width,r=e.height,s=e.tileWidth||32,o=e.tileHeight||32,n=t*s,a=r*o,i=e.context||kontra.context,l=i.canvas.width,c=i.canvas.height,h=document.createElement("canvas"),d=h.getContext("2d"),p=Math.max(0,n-l),u=Math.max(0,a-c);let f,m;const g=[],b={width:t,height:r,tileWidth:s,tileHeight:o,mapWidth:n,mapHeight:a,context:i,x:e.x||0,y:e.y||0,tilesets:[],layers:{},addTilesets:function(e){[].concat(e).forEach(e=>{const t=e.image;let r,n,a,i;if(`${t}`===t){let e=1/0;for(;e>=0;){const s=(e=t.lastIndexOf("/",e))<0?t:t.substr(e);if(kontra.assets.images[s]){r=kontra.assets.images[s];break}e--}}else r=t;n=e.firstGrid;const l=(r.width/s|0||1)*(r.height/o|0||1);n||(b.tilesets.length>0?(i=((a=b.tilesets[b.tilesets.length-1]).image.width/s|0)*(a.image.height/o|0),n=a.firstGrid+i):n=1),b.tilesets.push({firstGrid:n,lastGrid:n+l-1,image:r}),b.tilesets.sort((e,t)=>e.firstGrid-t.firstGrid)})},addLayers:function(e){[].concat(e).forEach(e=>{let r,s,o,n;if(e.render=void 0===e.render||e.render,Array.isArray(e.data[0])){r=[];for(let n=0;s=e.data[n];n++)for(o=0;o<t;o++)r.push(s[o]||0)}else r=e.data;b.layers[e.name]={data:r,zIndex:e.zIndex||0,render:e.render};for(const t in e.properties)if(e.properties.hasOwnProperty(t)){n=e.properties[t];try{n=JSON.parse(n)}catch(e){}b.layers[e.name][t]=n}b.layers[e.name].render&&(g.push(e.name),g.sort((e,t)=>b.layers[e].zIndex-b.layers[t].zIndex))}),function(){for(let e,t=0;e=b.layers[g[t]];t++)for(let t=0,r=e.data.length;t<r;t++)x(e,t)}()},changeTile(e,t,r){const s=w(t),o=b.layers[e];o.data[s]=r,x(o,s,!0)},tileAtLayer(e,t){const r=w(t);if(r>=0)return b.layers[e].data[r]},render(){b.context.drawImage(h,b.sx,b.sy,l,c,b.x,b.y,l,c)},renderLayer:function(e){const n=b.layers[e];let a=b.getRow();const i=b.getCol();let h=w({row:a,col:i});const d=i*s-b.sx,p=a*o-b.sy,u=Math.min(Math.ceil(l/s)+1,t),f=u*Math.min(Math.ceil(c/o)+1,r);let m,g,x,v,k,T,S,M,A,C=0;for(;C<f;)(x=n.data[h])&&(k=(v=y(x)).image,m=d+C%u*s,g=p+(C/u|0)*o,M=(T=x-v.firstGrid)%(S=k.width/s)*s,A=(T/S|0)*o,b.context.drawImage(k,M,A,s,o,m,g,s,o)),++C%u==0?h=i+ ++a*t:h++},getRowAndCol({x:e,y:t}){return{row:this.getRow(t),col:this.getCol(e)}},getXAndY:({row:e,col:t,mapX:r,mapY:n})=>({x:(t?t*s:r)-b.sx+s/2,y:(e?e*o:n)-b.sy+o/2}),getRow:(e=0)=>(b.sy+e)/o|0,getCol:(e=0)=>(b.sx+e)/s|0,get sx(){return f},get sy(){return m},set sx(e){f=Math.min(Math.max(0,e),p)},set sy(e){m=Math.min(Math.max(0,e),u)}};b.sx=e.sx||0,b.sy=e.sy||0,h.width=n,h.height=a;for(const t in e.properties)if(e.properties.hasOwnProperty(t)){let r=e.properties[t];try{r=JSON.parse(r)}catch(e){}b[t]=b[t]||r}function w(e){let s,o;return void 0!==e.x&&void 0!==e.y?(s=b.getRow(e.y),o=b.getCol(e.x)):(s=e.row,o=e.col),s<0||o<0||s>=r||o>=t?-1:o+s*t}function y(e){let t,r,s=0,o=b.tilesets.length-1;for(;s<=o;){if(t=(s+o)/2|0,e>=(r=b.tilesets[t]).firstGrid&&e<=r.lastGrid)return r;r.lastGrid<e?s=t+1:o=t-1}}function x(e,r,n=!1){const a=e.data[r];if(!a)return;const i=y(a),l=i.image,c=r%t*s,h=(r/t|0)*o,p=a-i.firstGrid,u=l.width/s,f=p%u*s,m=(p/u|0)*o;n&&d.clearRect(c,h,s,o),d.drawImage(l,f,m,s,o,c,h,s,o)}return e.tilesets&&b.addTilesets(e.tilesets),e.layers&&b.addLayers(e.layers),b},j=async({data:e,width:t,height:r,col:s,row:o})=>{const{sx:n,sy:a}=g({col:s,row:o}),i=F({tileWidth:100,tileHeight:100,width:t+8,height:r+8,sx:n,sy:a}),l=((e,t,r,s)=>{const o=[];let n=0;for(let a=0;a<r+2*s;a++)for(let i=0;i<t+2*s;i++)a<s||a>=s+r||i<s||i>=s+t?o.push(0):o.push(e[n++]);return o})(e,t,r,4),c=await(()=>{const e=document.createElement("canvas");e.width=800,e.height=800;const t=e.getContext("2d");_({ctx:t,row:1,col:1,deg:0}),_({ctx:t,row:1,col:2,deg:90}),_({ctx:t,row:2,col:1,deg:270}),_({ctx:t,row:2,col:2,deg:180}),N({ctx:t,row:1,col:3,deg:0}),N({ctx:t,row:2,col:3,deg:90}),U({ctx:t,row:1,col:4,deg:0}),U({ctx:t,row:1,col:5,deg:90}),U({ctx:t,row:1,col:6,deg:180}),U({ctx:t,row:2,col:5,deg:270}),q({ctx:t,row:2,col:4}),z({ctx:t,row:1,col:7,deg:0}),z({ctx:t,row:1,col:8,deg:90}),z({ctx:t,row:2,col:7,deg:180}),z({ctx:t,row:2,col:8,deg:270}),_({ctx:t,row:3,col:1,deg:0,broken:!0}),_({ctx:t,row:3,col:2,deg:90,broken:!0}),_({ctx:t,row:4,col:1,deg:270,broken:!0}),_({ctx:t,row:4,col:2,deg:180,broken:!0}),N({ctx:t,row:3,col:3,deg:0,broken:!0}),N({ctx:t,row:4,col:3,deg:90,broken:!0}),U({ctx:t,row:3,col:4,deg:0,broken:!0}),U({ctx:t,row:3,col:5,deg:90,broken:!0}),U({ctx:t,row:3,col:6,deg:180,broken:!0}),U({ctx:t,row:4,col:5,deg:270,broken:!0}),q({ctx:t,row:4,col:4,broken:!0}),z({ctx:t,row:3,col:7,deg:0,broken:!0}),z({ctx:t,row:3,col:8,deg:90,broken:!0}),z({ctx:t,row:4,col:7,deg:180,broken:!0}),z({ctx:t,row:4,col:8,deg:270,broken:!0});const r=new Image;return r.src=e.toDataURL("image/png"),new Promise(e=>setTimeout(()=>e(r),100))})();return i.addTilesets({image:c}),i.addLayers([{name:"main",data:l}]),i},J=({map:r,direction:o,speed:n})=>{const a={context:kontra.context,x:400,y:300,collisionRadius:30,map:r,speed:n,infected:!1,gameOver:!0,direction:o,nextDirection:null,dropBomb:!1,scale:1,dropping:!1,bombCoolingDown:!1,teleportToServer:!1,teleportCoolingDown:!1,update(){({nextDirection:this.nextDirection,direction:this.direction,dropBomb:this.dropBomb,scale:this.scale,bombCoolingDown:this.bombCoolingDown,teleportToServer:this.teleportToServer}=Q(this,e,L))},render(){K(this)},infect(r){E(r,[this]).length>0&&(this.infected=!0,this.gameOver||(L.show("player infected<br>game over"),e.publish(t)))},teleport(){if(this.teleportToServer&&!this.teleportCoolingDown){this.teleportCoolingDown=!0;const e=P.getNext();e?(({sx:this.map.sx,sy:this.map.sy}=g(e)),v(this.map,{x:this.x,y:this.y},this.direction)||(this.direction=k(this.map,{x:this.x,y:this.y},this.direction))):L.flash("all servers are destroyed or infected"),setTimeout(()=>{this.teleportCoolingDown=!1},600)}this.teleportToServer=!1},enableControls(){this.gameOver=!1}};return e.subscribe(t,()=>a.gameOver=!0),e.subscribe(s,()=>a.dropping=!0),a},K=e=>{const{context:t,x:r,y:s,direction:o,infected:n,scale:a}=e;t.save(),t.translate(r,s),t.scale(a,a),t.rotate((e=>{switch(e){case b:return A(0);case w:return A(90);case y:return A(180);case x:return A(270);default:return null}})(o)),t.lineWidth=3,t.strokeStyle=n?"#cd3926":"#75a042",t.fillStyle=n?"#7a2431":"#365b1d",t.beginPath(),t.moveTo(-15,25),t.lineTo(0,-25),t.lineTo(15,25),t.closePath(),t.fill(),t.stroke(),t.restore()},Q=o=>{let{nextDirection:n,direction:a,dropBomb:i,scale:l,bombCoolingDown:c,teleportToServer:h}=o;const{dropping:d,map:p,gameOver:u,x:f,y:m}=o;if(d)return l>0?l-=.01:(L.show("You fell into the abyss<br>Game over"),e.publish(t)),{direction:a,nextDirection:n,dropBomb:i,scale:l,bombCoolingDown:c,teleportToServer:h};if(u||(({nextDirection:n,dropBomb:i,teleportToServer:h}=(e=>{let{nextDirection:t,dropBomb:r,teleportToServer:s}=e;return kontra.keys.pressed("right")&&(t=w),kontra.keys.pressed("left")&&(t=x),kontra.keys.pressed("up")&&(t=b),kontra.keys.pressed("down")&&(t=y),kontra.keys.pressed("space")&&(r=!0),kontra.keys.pressed("enter")&&(s=!0),{nextDirection:t,dropBomb:r,teleportToServer:s}})(o)),c&&(i=!1)),!(({x:e,y:t})=>(e-50)%100==0&&(t-50)%100==0)({x:p.sx,y:p.sy}))return{direction:a,nextDirection:n,dropBomb:i,scale:l,bombCoolingDown:c,teleportToServer:h};if(n&&v(p,{x:f,y:m},n))a=n,n=null;else try{a=k(p,{x:f,y:m},a)}catch({message:t}){"dropped"===t&&e.publish(s)}return i&&(e.publish(r,p.getRowAndCol({x:f,y:m})),i=!1,c=!0,setTimeout(()=>{o.bombCoolingDown=!1},100)),{direction:a,nextDirection:n,dropBomb:i,scale:l,bombCoolingDown:c,teleportToServer:h}},V=(e,t)=>{const r=[];let s=t;for(;void 0!==s;)r.push(s),s=e.get(s);return r.reverse(),r},Z=(e,t)=>{let r=t.shift();const s=[];let o,n,a;for(;t.length;){if(o=t.shift(),!(n=ee(e,r,o)))return null;if(a=V(n,o),!t.length)return s.concat(a);s.push.apply(s,a.slice(0,-1)),r=o}return null},ee=(e,t,r)=>{const s=new Map([[t,0]]),o=new Map([[0,[t]]]),n=new Map;function a(e,t){let r=o.get(e);r||(r=[],o.set(e,r)),r.push(t)}for(;o.size>0;){const t=Array.from(o.keys()).sort((e,t)=>e-t)[0],r=o.get(t),i=r.shift(),l=e.get(i)||new Map;0===r.length&&o.delete(t);for(const[e,r]of l){const o=r+t,l=s.get(e);(void 0===l||l>o)&&(s.set(e,o),a(o,e),n.set(e,i))}}return void 0===s.get(r)?null:n},te=({width:e,layers:t},r)=>{const{graph:s,allowed:o}=se(t[r].data,e);for(const[e,t]of s){const r=o.get(e),{row:n,col:a}=e;let i;for(const e of r)switch(e){case b:(i=re(s,{row:n-1,col:a}))&&t.set(i,1);break;case w:(i=re(s,{row:n,col:a+1}))&&t.set(i,1);break;case y:(i=re(s,{row:n+1,col:a}))&&t.set(i,1);break;case x:(i=re(s,{row:n,col:a-1}))&&t.set(i,1)}}return s},re=(e,{row:t,col:r})=>{for(const[s]of e)if(t===s.row&&r===s.col)return s;return null},se=(e,t)=>{const r=new Map,s=new Map;let o=0,n=0,a=0;for(const i of e){if(X(i)){const e={row:o,col:n};s.set(e,T[i].allowed),r.set(e,new Map)}++a%t==0?(o++,n=0):n++}return{graph:r,allowed:s}};var oe=new class{constructor(e=null){this.graph=e}setDataFromMap(e,t){this.graph=te(e,t)}getNodeByCoords(e){return re(this.graph,e)}findShortestPath(...e){return Z(this.graph,e)}isReachable(e,t){return null!==this.findShortestPathByCoords(e,t)}findShortestPathByCoords(...e){return this.findShortestPath(...e.map(e=>this.getNodeByCoords(e)))}},ne=()=>e.subscribe(3,e=>oe.setDataFromMap(e,"main")),ae=()=>{const e=document.createElement("div");return e.setAttribute("id","scb"),document.getElementById("wrapper").appendChild(e),e};function ie(e,t){const{gameOver:r}=t,{infected:s,online:o,offline:n}=t.getStats(),a=le({infected:s,online:o,offline:n});let i=localStorage.getItem("CUT_EM_ALL__HIGHSCORE")||0;r&&(i=Math.max(a,i),localStorage.setItem("CUT_EM_ALL__HIGHSCORE",i)),e.innerHTML=`\n        ${o} online |  \n        ${n} offline | \n        ${s} infected | \n        Score: ${a} | \n        Highscore: ${i}\n    `}function le({infected:e,online:t,offline:r}){return 100*r+(0===t&&0===e?300:0)}class ce{constructor({map:r}){this.map=r,this.users=[],this.gameOver=!1;for(let e=0;e<r.height;e++)for(let t=0;t<r.width;t++){const s=r.tileAtLayer("main",{row:e,col:t});7!==s&&8!==s&&15!==s&&16!==s||this.users.push(he({map:r,row:e,col:t}))}e.subscribe(t,()=>this.gameOver=!0)}updateOnlineStatus(...r){const s=r.map(e=>({...e,...this.map.getRowAndCol({x:e.x,y:e.y})}));let o=0;for(const e of this.users.filter(({status:e})=>e===de))for(const t of s){oe.isReachable(e,t)||(o++,e.status=pe)}if(o>0){const{online:r,offline:s,infected:o}=this.getStats();0===r?(L.show(`\n                  level completed<br>\n                  offline users: ${s}<br>\n                  infected users: ${o}<br>\n                  score: ${le({online:r,offline:s,infected:o})}\n            `),e.publish(t)):L.flash(`${s} users went offline<br>good job!`)}}getStats(){return this.users.reduce((e,{status:t})=>({online:e.online+(t===de?1:0),offline:e.offline+(t===pe?1:0),infected:e.infected+(t===ue?1:0)}),{online:0,offline:0,infected:0})}update(){this.users.forEach(e=>e.update())}render(){this.users.forEach(e=>e.render())}infect(...r){const{users:s,gameOver:o}=this,n=E(s,r).filter(([e])=>e.status!==ue);if(0===n.length)return;if(n.forEach(([e])=>e.infect()),o)return;const{online:a,offline:i,infected:l}=this.getStats();if(0===a)return L.show(`\n              level completed<br>\n              offline users: ${i}<br>\n              infected users: ${l}<br>\n              score: ${le({online:a,offline:i,infected:l})}\n            `),void e.publish(t);L.flash("user infected!")}}var he=({map:t,row:r,col:s})=>{const{x:o,y:n}=t.getXAndY({row:r,col:s});return{context:kontra.context,x:o,y:n,collisionRadius:30,infected:!1,map:t,mapX:100*s,mapY:100*r,row:r,col:s,status:de,update(){({x:this.x,y:this.y}=t.getXAndY({mapX:this.mapX,mapY:this.mapY}))},render(){me(this)},infect(){this.status=ue,e.publish(a)}}};const de=0,pe=1,ue=2,fe={[de]:{fg:"#52638a",bg:"#2b3653"},[pe]:{fg:"#75a042",bg:"#365b1d"},[ue]:{fg:"#cd3926",bg:"#7a2431"}};var me=e=>{const{context:t,x:r,y:s,status:o}=e,{fg:n,bg:a}=fe[o];t.save(),t.translate(r,s),t.lineWidth=3,t.strokeStyle=n,t.fillStyle=a,t.beginPath(),t.moveTo(-40,40),t.lineTo(-40,20),t.arc(-20,20,20,A(180),A(270)),t.moveTo(-20,0),t.lineTo(20,0),t.arc(20,20,20,A(270),A(0)),t.lineTo(40,40),t.lineTo(-40,40),t.moveTo(-23,20),t.lineTo(-23,40),t.moveTo(23,20),t.lineTo(23,40),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-15,25,A(0),A(360)),t.fill(),t.stroke(),t.restore()},ge=({map:e,col:t,row:r,direction:s,speed:o})=>{const{x:n,y:a}=e.getXAndY({row:r,col:t}),i=new class{constructor(){this.blips=[]}start(e){setInterval(()=>{this.blips.push(xe({x:e.x,y:e.y}))},d)}update(){this.blips.forEach(e=>e.update()),this.blips=this.blips.filter(e=>e.ttl>0)}render(){this.blips.forEach(e=>e.render())}},l={context:kontra.context,x:n,y:a,speed:o,collisionRadius:30,map:e,mapX:100*t,mapY:100*r,direction:s,blips:i,update(){({x:this.x,y:this.y,mapX:this.mapX,mapY:this.mapY,direction:this.direction}=we(this)),this.blips.update()},render(){ye(this),this.blips.render()}};return i.start(l),l};let be=null;var we=e=>{let{direction:t}=e;const{map:r}=e,{mapX:s,mapY:o}=(({mapX:e,mapY:t,direction:r,speed:s})=>{switch(r){case b:return{mapX:e,mapY:t-s};case w:return{mapX:e+s,mapY:t};case y:return{mapX:e,mapY:t+s};case x:return{mapX:e-s,mapY:t};default:return{mapX:e,mapY:t}}})(e),{x:n,y:a}=r.getXAndY({mapX:s,mapY:o});if(be||(be=Array(r.height).fill().map(()=>Array(r.width).fill(0))),(({mapX:e,mapY:t})=>e%100==0&&t%100==0)({mapX:s,mapY:o})){const e=r.tileAtLayer("main",{x:n,y:a}),{col:s,row:o}=r.getRowAndCol({x:n,y:a});if(be[o][s]++,(e=>S.includes(e))(e)){const{allowed:i}=T[e],l=(({viable:e,visits:t,row:r,col:s})=>{let o=Number.MAX_SAFE_INTEGER;return e.map(e=>{let n;switch(e){case b:n=t[r-1][s];break;case w:n=t[r][s+1];break;case y:n=t[r+1][s];break;case x:n=t[r][s-1]}return o=n<o?n:o,{dir:e,vis:n}}).filter(({vis:e})=>e===o).map(({dir:e})=>e)})({viable:i.filter(e=>e!==(e=>{switch(e){case b:return y;case w:return x;case y:return b;case x:return x;default:return null}})(t)&&v(r,{x:n,y:a},e)),visits:be,row:o,col:s});t=l[C(0,l.length-1)]}else t=k(r,{x:n,y:a},t)}return{direction:t,mapY:o,mapX:s,x:n,y:a}},ye=e=>{const{context:t,x:r,y:s}=e;t.save(),t.translate(r,s),t.lineWidth=3,t.strokeStyle="#cd3926",t.fillStyle="#7a2431",t.beginPath(),t.moveTo(C(-5,5),C(-5,-25)),t.lineTo(C(5,50),C(-5,-50)),t.lineTo(C(5,25),C(-5,5)),t.lineTo(C(5,50),C(5,50)),t.lineTo(C(-5,5),C(5,25)),t.lineTo(C(-5,-50),C(5,50)),t.lineTo(C(-5,-25),C(-5,5)),t.lineTo(C(-5,-50),C(-5,-50)),t.closePath(),t.fill(),t.stroke(),t.restore()},xe=({x:e,y:t})=>({context:kontra.context,x:e,y:t,ttl:180,radius:100,update(){this.radius+=10,this.ttl--},render(){ve(this)}}),ve=e=>{const{context:t,x:r,y:s,radius:o}=e;t.save(),t.translate(r,s),t.lineWidth=1,t.strokeStyle="#cd3926",t.beginPath(),t.arc(0,0,o,A(0),A(360)),t.closePath(),t.stroke(),t.restore()};var ke=()=>{const e=document.createElement("canvas");e.width=800,e.height=600,e.style.cssText="\n        border: 4px solid #52638a;\n    ",document.getElementById("wrapper").appendChild(e)},Te=[{player:{col:8,row:9,direction:y,speed:5},viruses:[{col:8,row:7,direction:w,speed:2.5}],servers:[{row:9,col:8},{row:9,col:12},{row:15,col:15}],map:{width:20,height:20,data:" 6   6   6   6   6  f3a1031  4a5ac 0ab1  0a98ac  2 2 4ac 22  20a5a9 0318ac 8a92  22 2   20c  2    47 22 2 0a928a53a51 2  22 2 2  2  2  22 2  8c 4a9  20a9  22 2   2 2   039    24a37 0c 4a1 2 0aaaab9    22 2 4ac 8a1  2  07 89 4a9 8aaaba59  2     20a10aaa9 2 0a37f55a92 22   018aba1  22  2 220a122  2 2  431 4a922 4b3aac 47 2 4aba598592   8a9 f3ac 2 8aac 8a5a55a7   2 2    4aa12 22     e e    e  e8a9e  "}}];var Se=e=>{const t=Te[e];return{...t,map:{...t.map,data:(e=>e.split("").map(e=>(function(e){const t=e.charCodeAt(0);return 32===t?0:t>=97?t-86:t-47})(e)))(t.map.data)}}};var Me=new class{constructor(){ke(),kontra.init(),ne(),e.subscribe(r,()=>h.play("drop-bomb")),e.subscribe(n,()=>h.play("explode")),e.subscribe(a,()=>h.play("infected")),e.subscribe(s,()=>h.play("drop-ship"))}async initLevel(r){const s=Se(r),n=await j({...s.map,col:s.player.col,row:s.player.row});this.player=J({map:n,...s.player});const i=new H(n),l=ge({map:n,...s.viruses[0]});oe.setDataFromMap(n,"main");const c=new ce({map:n});P.init(n,s.servers),this.loop=G({map:n,player:this.player,virus:l,users:c,bombs:i}),e.reset(o,()=>c.updateOnlineStatus(l)),function(r){const s=ae();ie(s,r.users),e.subscribe(o,()=>{setTimeout(()=>ie(s,r.users),0)}),e.subscribe(a,()=>{setTimeout(()=>ie(s,r.users),0)}),e.subscribe(t,()=>{setTimeout(()=>ie(s,r.users),0)})}({users:c,map:n}),n.render(),c.render(),P.render(),i.render(),this.player.render(),l.render()}showStartScreen(){L.show('welcome, <span class="grn">captain katamov!</span><br><br>Your shift as chief network security officers is about to begin… all users are online and happy.in case of virus intrusion, <span class="grn">cut them off</span> from the network to make sure they don\'t get infected!<br><br><table><tr><td class="grn">arrow keys</td><td>…</td><td>change direction</td></tr><tr><td class="grn">space bar</td><td>…</td><td>drop bomb</td></tr><tr><td class="grn">return</td><td>…</td><td>teleport to server</td></tr></table><br>press any key to begin!'),document.addEventListener("keydown",()=>{L.clear(),this.startLevel(),setTimeout(()=>this.player.enableControls(),500)},{once:!0})}startLevel(){this.loop.start()}};(async()=>{await Me.initLevel(0),Me.showStartScreen()})()}();
//# sourceMappingURL=game.js.map
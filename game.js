!function(e){var t={};function o(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)o.d(r,s,function(t){return e[t]}.bind(null,s));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,o){"use strict";o.r(t);const r="N",s="E",n="S",i="W";var a=e=>e*Math.PI/180,l=(e,t)=>{const o=Math.min(e,t),r=Math.max(e,t);return Math.floor(Math.random()*(r-o+1))+o},c=(e,t)=>{const o=e.x-t.x,r=e.y-t.y;return Math.sqrt(o*o+r*r)<e.collisionRadius+t.collisionRadius},d=e=>e>0&&e<25||e>30&&e<33||e>37&&e<41||e>44,h=(e,{x:t,y:o},r)=>{const s=e.tileAtLayer("main",{x:t,y:o});if(!d(s)||!p[s].allowed.includes(r))return!1;const n=g(e,{x:t,y:o},r);return d(n)},u=(e,{x:t,y:o},r)=>{const s=e.tileAtLayer("main",{x:t,y:o});if(!d(s))throw new Error("dropped");const n=p[s].change[r]||r;if(h(e,{x:t,y:o},n))return n;const i=p[s].allowed.filter(r=>h(e,{x:t,y:o},r));switch(i.length){case 0:throw new Error("locked in");case 1:return i[0];default:return i[l(0,i.length-1)]}},p={1:{allowed:[n,s],change:{[r]:s,[i]:n}},2:{allowed:[i,n],change:{[r]:i,[s]:n}},3:{allowed:[r,n],change:{}},4:{allowed:[i,r,s],change:{[n]:r}},5:{allowed:[r,s,n],change:{[i]:s}},6:{allowed:[i,s,n],change:{[r]:n}},9:{allowed:[r,s],change:{[n]:s,[i]:r}},10:{allowed:[i,r],change:{[s]:r,[n]:i}},11:{allowed:[i,s],change:{}},12:{allowed:[r,s,n,i],change:{}},13:{allowed:[r,n,i],change:{[s]:i}},17:{allowed:[n],change:{[r]:n}},18:{allowed:[i],change:{[s]:i}},19:{allowed:[r],change:{[n]:r}},20:{allowed:[s],change:{[i]:s}},14:{allowed:[r,n],change:{}},38:{allowed:[r,n],change:{}}};const f=[];for(const[e,{allowed:t}]of Object.entries(p))t.length>2&&f.push(Number(e));var g=(e,{x:t,y:o},a)=>e.tileAtLayer("main",{x:a===s?t+y:a===i?t-y:t,y:a===r?o-w:a===n?o+w:o});const b=800,m=600,y=100,w=100;var x=new class{constructor(){this.subscribers=[]}subscribe(e,t){this.subscribers.push({message:e,callback:t})}publish(e,t){this.subscribers.forEach(({message:o,callback:r})=>o===e&&r(t))}};const v=1,k=6,T=7,M=2;var S=({map:e,player:t,virus:o,users:a,bombs:l})=>{let c=!0;return x.subscribe(M,()=>c=!1),kontra.gameLoop({update(){o.update(),t.update(),t.infect(o),c&&((e,t)=>{switch(t){case r:e.sy-=5;break;case s:e.sx+=5;break;case n:e.sy+=5;break;case i:e.sx-=5}})(e,t.direction),a.update(),a.infect(o),l.update()},render(){e.render(),a.render(),l.render(),t.render(),o.render()}})},A=[0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,20,4,11,2,1,4,2,0,0,5,11,6,11,13,0,1,11,12,2,0,0,1,11,10,9,11,13,0,0,3,0,3,0,5,11,13,0,3,3,0,0,3,1,11,6,11,10,0,1,4,2,9,11,13,0,9,11,10,3,0,0,3,3,0,3,0,0,0,3,1,13,0,0,3,0,0,0,0,5,18,0,3,3,0,14,0,1,11,10,3,9,11,6,4,11,6,2,0,3,0,0,3,3,0,3,0,3,0,0,3,0,0,3,0,0,3,3,0,3,0,0,9,13,0,5,11,10,0,0,3,1,11,10,0,0,3,3,0,3,0,0,0,3,0,3,0,0,0,1,4,10,0,0,0,0,3,5,11,4,18,0,1,13,0,5,11,2,0,3,0,1,11,11,11,11,12,10,0,0,0,0,3,3,0,3,0,5,11,13,0,9,11,2,0,0,3,0,0,1,18,0,9,10,0,5,11,10,0,9,11,11,11,12,11,6,10,0,0,3,0,0,0,0,0,3,1,11,2,1,11,11,11,10,0,3,0,1,11,4,18,20,6,6,11,10,3,0,3,3,0,0,0,1,2,9,11,12,11,2,0,0,3,3,0,0,3,0,3,3,1,11,2,3,3,0,0,3,0,3,0,0,5,4,2,0,5,11,10,3,3,0,5,12,4,11,11,13,0,5,18,0,3,0,5,11,12,11,6,10,9,6,10,3,0,0,0,9,11,10,0,20,4,11,13,0,3,0,9,11,11,13,0,9,11,6,11,6,6,11,18,0,0,0,3,0,3,0,0,0,0,5,11,11,2,3,0,3,3,0,0,0,0,0,19,0,19,0,0,0,0,19,0,0,19,9,11,10,19,0,0];function P(e,t){return[Math.cos(a(e))*t+50,Math.sin(a(e))*t+50]}var D=({ctx:e,row:t,col:o,deg:r,broken:s=!1})=>{e.save(),e.translate((o-1)*y+y/2,(t-1)*w+w/2),e.rotate(a(r)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),s?(e.moveTo(20,50),e.arc(50,50,30,a(180),a(190)),e.moveTo(...P(190,30)),e.lineTo(10,45),e.lineTo(10,35),e.lineTo(-10,40),e.lineTo(...P(190,70)),e.arc(50,50,70,a(190),a(180),!0),e.moveTo(50,20),e.arc(50,50,30,a(270),a(260),!0),e.moveTo(...P(260,30)),e.lineTo(40,10),e.lineTo(45,0),e.lineTo(35,0),e.lineTo(...P(260,70)),e.arc(50,50,70,a(260),a(270))):(e.moveTo(20,50),e.arc(50,50,30,a(180),a(270)),e.moveTo(-20,50),e.arc(50,50,70,a(180),a(270))),e.stroke(),e.restore()},X=(e,t)=>t.forEach(([t,o,r])=>e[t?"lineTo":"moveTo"](o,r)),Y=({ctx:e,row:t,col:o,deg:r,broken:s=!1})=>{e.save(),e.translate((o-1)*y+y/2,(t-1)*w+w/2),e.rotate(a(r)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),X(e,s?[[0,-20,50],[1,-20,30],[1,-10,40],[1,0,25],[1,10,35],[1,20,30],[1,20,50],[0,-20,-50],[1,-20,-40],[1,-10,-25],[1,0,-35],[1,10,-30],[1,20,-40],[1,20,-50]]:[[0,-20,-50],[1,-20,50],[0,20,-50],[1,20,50]]),e.stroke(),e.restore()},C=({ctx:e,row:t,col:o,deg:r,broken:s=!1})=>{e.save(),e.translate((o-1)*y+y/2,(t-1)*w+w/2),e.rotate(a(r)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),X(e,s?[[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,50,20]]),e.stroke(),e.restore()},E=({ctx:e,row:t,col:o,broken:r=!1})=>{e.save(),e.translate((o-1)*y+y/2,(t-1)*w+w/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),X(e,r?[[0,-20,50],[1,-20,45],[1,-10,40],[1,0,45],[1,10,35],[1,20,40],[1,20,50],[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,-20,20],[1,-20,50],[0,50,20],[1,20,20],[1,20,50]]),e.stroke(),e.restore()},O=({ctx:e,row:t,col:o,broken:r})=>{e.save(),e.translate((o-1)*y+y/2,(t-1)*w+w/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),X(e,[[0,30,-48],[1,48,-30],[1,48,30],[1,30,48],[1,-30,48],[1,-48,30],[1,-48,-30],[1,-30,-48],[1,30,-48]]),e.stroke(),r&&(e.lineWidth=2,X(e,[[0,10,-48],[1,0,-40],[0,24,-48],[1,20,-30],[0,48,-27],[1,20,-20],[0,-10,-30],[1,10,-30],[1,30,-10],[1,20,0],[1,10,0],[0,48,7],[1,30,10],[0,20,0],[1,30,10],[1,10,20],[0,30,48],[1,30,30],[1,10,30],[0,20,20],[1,20,30],[0,-10,48],[1,-10,20],[1,0,10],[0,-20,0],[1,-20,20],[1,-10,30],[0,-30,48],[1,-20,40],[1,-20,30],[0,-30,30],[1,-20,40],[0,-48,20],[1,-30,20],[0,-40,20],[1,-40,10],[0,-48,0],[1,-30,0],[1,-20,-10],[0,-40,0],[1,-30,10],[0,-48,-17],[1,-40,-30],[1,-30,-20],[0,-30,-48],[1,-10,-20],[1,-10,-10],[0,-20,-30],[1,-20,-20],[1,-30,-10]]),e.stroke()),e.restore()},R=({ctx:e,row:t,col:o,deg:r,broken:s=!1})=>{e.save(),e.translate((o-1)*y+y/2,(t-1)*w+w/2),e.rotate(a(r)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),X(e,s?[[0,-20,50],[1,-20,40],[1,-10,45],[1,0,35],[1,10,45],[1,20,40],[1,20,50]]:[[0,-20,50],[1,-20,0],[1,20,0],[1,20,50]]),e.stroke(),e.restore()},L=(e={})=>{const t=e.width,o=e.height,r=e.tileWidth||32,s=e.tileHeight||32,n=t*r,i=o*s,a=e.context||kontra.context,l=a.canvas.width,c=a.canvas.height,d=document.createElement("canvas"),h=d.getContext("2d"),u=Math.max(0,n-l),p=Math.max(0,i-c);let f,g;const b=[],m={width:t,height:o,tileWidth:r,tileHeight:s,mapWidth:n,mapHeight:i,context:a,x:e.x||0,y:e.y||0,tilesets:[],layers:{},addTilesets:function(e){[].concat(e).forEach(e=>{const t=e.image;let o,n,i,a;if(`${t}`===t){let e=1/0;for(;e>=0;){const r=(e=t.lastIndexOf("/",e))<0?t:t.substr(e);if(kontra.assets.images[r]){o=kontra.assets.images[r];break}e--}}else o=t;n=e.firstGrid;const l=(o.width/r|0||1)*(o.height/s|0||1);n||(m.tilesets.length>0?(a=((i=m.tilesets[m.tilesets.length-1]).image.width/r|0)*(i.image.height/s|0),n=i.firstGrid+a):n=1),m.tilesets.push({firstGrid:n,lastGrid:n+l-1,image:o}),m.tilesets.sort((e,t)=>e.firstGrid-t.firstGrid)})},addLayers:function(e){[].concat(e).forEach(e=>{let o,r,s,n;if(e.render=void 0===e.render||e.render,Array.isArray(e.data[0])){o=[];for(let n=0;r=e.data[n];n++)for(s=0;s<t;s++)o.push(r[s]||0)}else o=e.data;m.layers[e.name]={data:o,zIndex:e.zIndex||0,render:e.render};for(const t in e.properties)if(e.properties.hasOwnProperty(t)){n=e.properties[t];try{n=JSON.parse(n)}catch(e){}m.layers[e.name][t]=n}m.layers[e.name].render&&(b.push(e.name),b.sort((e,t)=>m.layers[e].zIndex-m.layers[t].zIndex))}),function(){for(let e,t=0;e=m.layers[b[t]];t++)for(let t=0,o=e.data.length;t<o;t++)x(e,t)}()},changeTile(e,t,o){const r=y(t),s=m.layers[e];s.data[r]=o,x(s,r,!0)},tileAtLayer(e,t){const o=y(t);if(o>=0)return m.layers[e].data[o]},render(){m.context.drawImage(d,m.sx,m.sy,l,c,m.x,m.y,l,c)},renderLayer:function(e){const n=m.layers[e];let i=m.getRow();const a=m.getCol();let d=y({row:i,col:a});const h=a*r-m.sx,u=i*s-m.sy,p=Math.min(Math.ceil(l/r)+1,t),f=p*Math.min(Math.ceil(c/s)+1,o);let g,b,x,v,k,T,M,S,A,P=0;for(;P<f;)(x=n.data[d])&&(k=(v=w(x)).image,g=h+P%p*r,b=u+(P/p|0)*s,S=(T=x-v.firstGrid)%(M=k.width/r)*r,A=(T/M|0)*s,m.context.drawImage(k,S,A,r,s,g,b,r,s)),++P%p==0?d=a+ ++i*t:d++},getRowAndCol({x:e,y:t}){return{row:this.getRow(t),col:this.getCol(e)}},getXAndY:({row:e,col:t,mapX:o,mapY:n})=>({x:(t?t*r:o)-m.sx+r/2,y:(e?e*s:n)-m.sy+s/2}),getRow:(e=0)=>(m.sy+e)/s|0,getCol:(e=0)=>(m.sx+e)/r|0,get sx(){return f},get sy(){return g},set sx(e){f=Math.min(Math.max(0,e),u)},set sy(e){g=Math.min(Math.max(0,e),p)}};m.sx=e.sx||0,m.sy=e.sy||0,d.width=n,d.height=i;for(const t in e.properties)if(e.properties.hasOwnProperty(t)){let o=e.properties[t];try{o=JSON.parse(o)}catch(e){}m[t]=m[t]||o}function y(e){let r,s;return void 0!==e.x&&void 0!==e.y?(r=m.getRow(e.y),s=m.getCol(e.x)):(r=e.row,s=e.col),r<0||s<0||r>=o||s>=t?-1:s+r*t}function w(e){let t,o,r=0,s=m.tilesets.length-1;for(;r<=s;){if(t=(r+s)/2|0,e>=(o=m.tilesets[t]).firstGrid&&e<=o.lastGrid)return o;o.lastGrid<e?r=t+1:s=t-1}}function x(e,o,n=!1){const i=e.data[o];if(!i)return;const a=w(i),l=a.image,c=o%t*r,d=(o/t|0)*s,u=i-a.firstGrid,p=l.width/r,f=u%p*r,g=(u/p|0)*s;n&&h.clearRect(c,d,r,s),h.drawImage(l,f,g,r,s,c,d,r,s)}return e.tilesets&&m.addTilesets(e.tilesets),e.layers&&m.addLayers(e.layers),m},W=async()=>{const{sx:e,sy:t}=(({col:e,row:t})=>({sx:e*y-b/2+y/2,sy:t*w-m/2+w/2}))({col:8,row:9}),o=L({tileWidth:y,tileHeight:w,width:28,height:28,sx:e,sy:t}),r=((e,t,o,r)=>{const s=[];let n=0;for(let i=0;i<o+2*r;i++)for(let a=0;a<t+2*r;a++)i<r||i>=r+o||a<r||a>=r+t?s.push(0):s.push(e[n++]);return s})(A,20,20,4),s=await(()=>{const e=document.createElement("canvas");e.width=8*y,e.height=8*w;const t=e.getContext("2d");D({ctx:t,row:1,col:1,deg:0}),D({ctx:t,row:1,col:2,deg:90}),D({ctx:t,row:2,col:1,deg:270}),D({ctx:t,row:2,col:2,deg:180}),Y({ctx:t,row:1,col:3,deg:0}),Y({ctx:t,row:2,col:3,deg:90}),C({ctx:t,row:1,col:4,deg:0}),C({ctx:t,row:1,col:5,deg:90}),C({ctx:t,row:1,col:6,deg:180}),C({ctx:t,row:2,col:5,deg:270}),E({ctx:t,row:2,col:4}),R({ctx:t,row:3,col:1,deg:0}),R({ctx:t,row:3,col:2,deg:90}),R({ctx:t,row:3,col:3,deg:180}),R({ctx:t,row:3,col:4,deg:270}),O({ctx:t,row:2,col:6}),D({ctx:t,row:4,col:1,deg:0,broken:!0}),D({ctx:t,row:4,col:2,deg:90,broken:!0}),D({ctx:t,row:5,col:1,deg:270,broken:!0}),D({ctx:t,row:5,col:2,deg:180,broken:!0}),Y({ctx:t,row:4,col:3,deg:0,broken:!0}),Y({ctx:t,row:5,col:3,deg:90,broken:!0}),C({ctx:t,row:4,col:4,deg:0,broken:!0}),C({ctx:t,row:4,col:5,deg:90,broken:!0}),C({ctx:t,row:4,col:6,deg:180,broken:!0}),C({ctx:t,row:5,col:5,deg:270,broken:!0}),E({ctx:t,row:5,col:4,broken:!0}),R({ctx:t,row:6,col:1,deg:0,broken:!0}),R({ctx:t,row:6,col:2,deg:90,broken:!0}),R({ctx:t,row:6,col:3,deg:180,broken:!0}),R({ctx:t,row:6,col:4,deg:270,broken:!0}),O({ctx:t,row:5,col:6,broken:!0});const o=new Image;return o.src=e.toDataURL("image/png"),new Promise(e=>setTimeout(()=>e(o),100))})();return o.addTilesets({image:s}),o.addLayers([{name:"main",data:r}]),o};var B=new class{constructor(){this.timeoutHandler=null,this.div=document.createElement("div"),this.div.style.cssText="\nbackground-color: rgba(0,0,0,0);\nfont-size: 3em;\nfont-weight: bold;\nalign-items: center;\njustify-content: center;\ndisplay: flex;\ncolor: rgba(255,255,255,0);\nposition: absolute;\ntop: 0;\nleft:0;\nwidth: 100vw;\nheight: 100vh;\ntext-align: center;\npointer-events: none;\ntransition: background-color 3s ease-out, color 3s ease-out;\ntext-transform: uppercase;\nfont-family: monospace;\n    ",document.getElementById("wrapper").appendChild(this.div)}show(e){clearTimeout(this.timeoutHandler),this.div.style.transition="3s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.backgroundColor="rgba(0,0,0,0.5)",this.div.style.color="rgba(255,255,255,1)"}flash(e){clearTimeout(this.timeoutHandler),this.div.style.transition="0.5s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.color="rgba(255,255,255,1)",this.timeoutHandler=setTimeout(()=>this.div.style.color="rgba(255,255,255,0)",500)}},I=e=>{const t={context:kontra.context,x:b/2,y:m/2,collisionRadius:30,map:e,infected:!1,gameOver:!1,direction:"N",nextDirection:null,dropBomb:!1,scale:1,dropping:!1,bombCoolingDown:!1,update(){({nextDirection:this.nextDirection,direction:this.direction,dropBomb:this.dropBomb,scale:this.scale,bombCoolingDown:this.bombCoolingDown}=_(this,x,B))},render(){G(this)},infect(e){c(e,this)&&(this.infected=!0,this.gameOver||(B.show("player infected<br>game over"),x.publish(0)))}};return x.subscribe(0,()=>t.gameOver=!0),x.subscribe(M,()=>t.dropping=!0),t},G=e=>{const{context:t,x:o,y:l,direction:c,infected:d,scale:h}=e;t.save(),t.translate(o,l),t.scale(h,h),t.rotate((e=>{switch(e){case r:return a(0);case s:return a(90);case n:return a(180);case i:return a(270);default:return null}})(c)),t.lineWidth=3,t.strokeStyle=d?"#cd3926":"#75a042",t.fillStyle=d?"#7a2431":"#365b1d",t.beginPath(),t.moveTo(-15,25),t.lineTo(0,-25),t.lineTo(15,25),t.closePath(),t.fill(),t.stroke(),t.restore()},_=e=>{let{nextDirection:t,direction:o,dropBomb:a,scale:l,bombCoolingDown:c}=e;const{dropping:d,map:p,gameOver:f,x:g,y:b}=e;if(d)return l>0?l-=.01:(B.show("You fell into the abyss<br>Game over"),x.publish(0)),{direction:o,nextDirection:t,dropBomb:a,scale:l,bombCoolingDown:c};if(f||(({nextDirection:t,dropBomb:a}=(e=>{let{nextDirection:t,dropBomb:o}=e;return kontra.keys.pressed("right")&&(t=s),kontra.keys.pressed("left")&&(t=i),kontra.keys.pressed("up")&&(t=r),kontra.keys.pressed("down")&&(t=n),kontra.keys.pressed("space")&&(o=!0),{nextDirection:t,dropBomb:o}})(e)),c&&(a=!1)),!(({x:e,y:t})=>(e-y/2)%y==0&&(t-w/2)%w==0)({x:p.sx,y:p.sy}))return{direction:o,nextDirection:t,dropBomb:a,scale:l,bombCoolingDown:c};if(t&&h(p,{x:g,y:b},t))o=t,t=null;else try{o=u(p,{x:g,y:b},o)}catch({message:e}){"dropped"===e&&x.publish(M)}return a&&(x.publish(v,p.getRowAndCol({x:g,y:b})),a=!1,c=!0,setTimeout(()=>{e.bombCoolingDown=!1},100)),{direction:o,nextDirection:t,dropBomb:a,scale:l,bombCoolingDown:c}},j=(e,t)=>{const o=[];let r=t;for(;void 0!==r;)o.push(r),r=e.get(r);return o.reverse(),o},H=(e,t)=>{let o=t.shift();const r=[];let s,n,i;for(;t.length;){if(s=t.shift(),!(n=N(e,o,s)))return null;if(i=j(n,s),!t.length)return r.concat(i);r.push.apply(r,i.slice(0,-1)),o=s}return null},N=(e,t,o)=>{const r=new Map([[t,0]]),s=new Map([[0,[t]]]),n=new Map;function i(e,t){let o=s.get(e);o||(o=[],s.set(e,o)),o.push(t)}for(;s.size>0;){const t=Array.from(s.keys()).sort((e,t)=>e-t)[0],o=s.get(t),a=o.shift(),l=e.get(a)||new Map;0===o.length&&s.delete(t);for(const[e,o]of l){const s=o+t,l=r.get(e);(void 0===l||l>s)&&(r.set(e,s),i(s,e),n.set(e,a))}}return void 0===r.get(o)?null:n},$=({width:e,layers:t},o)=>{const{graph:a,allowed:l}=q(t[o].data,e);for(const[e,t]of a){const o=l.get(e),{row:c,col:d}=e;let h;for(const e of o)switch(e){case r:(h=z(a,{row:c-1,col:d}))&&t.set(h,1);break;case s:(h=z(a,{row:c,col:d+1}))&&t.set(h,1);break;case n:(h=z(a,{row:c+1,col:d}))&&t.set(h,1);break;case i:(h=z(a,{row:c,col:d-1}))&&t.set(h,1)}}return a},z=(e,{row:t,col:o})=>{for(const[r]of e)if(t===r.row&&o===r.col)return r;return null},q=(e,t)=>{const o=new Map,r=new Map;let s=0,n=0,i=0;for(const a of e){if(d(a)){const e={row:s,col:n};r.set(e,p[a].allowed),o.set(e,new Map)}++i%t==0?(s++,n=0):n++}return{graph:o,allowed:r}};var F=new class{constructor(e=null){this.graph=e}setDataFromMap(e,t){this.graph=$(e,t)}getNodeByCoords(e){return z(this.graph,e)}findShortestPath(...e){return H(this.graph,e)}isReachable(e,t){return null!==this.findShortestPathByCoords(e,t)}findShortestPathByCoords(...e){return this.findShortestPath(...e.map(e=>this.getNodeByCoords(e)))}},U=({map:e,row:t,col:o})=>{const{x:r,y:s}=e.getXAndY({row:t,col:o});return{context:kontra.context,x:r,y:s,collisionRadius:30,infected:!1,map:e,mapX:o*y,mapY:t*w,row:t,col:o,status:J,update(){({x:this.x,y:this.y}=e.getXAndY({mapX:this.mapX,mapY:this.mapY}))},render(){Z(this)},infect(){this.status=Q,x.publish(T)}}};const J=0,K=1,Q=2,V={[J]:{fg:"#52638a",bg:"#2b3653"},[K]:{fg:"#75a042",bg:"#365b1d"},[Q]:{fg:"#cd3926",bg:"#7a2431"}};var Z=e=>{const{context:t,x:o,y:r,status:s}=e,{fg:n,bg:i}=V[s];t.save(),t.translate(o,r),t.lineWidth=3,t.strokeStyle=n,t.fillStyle=i,t.beginPath(),t.moveTo(-40,40),t.lineTo(-40,20),t.arc(-20,20,20,a(180),a(270)),t.moveTo(-20,0),t.lineTo(20,0),t.arc(20,20,20,a(270),a(0)),t.lineTo(40,40),t.lineTo(-40,40),t.moveTo(-23,20),t.lineTo(-23,40),t.moveTo(23,20),t.lineTo(23,40),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-15,25,a(0),a(360)),t.fill(),t.stroke(),t.restore()},ee=e=>{const{x:t,y:o}=e.getXAndY({row:7,col:8}),r=new ie,s={context:kontra.context,x:t,y:o,collisionRadius:30,map:e,mapX:8*y,mapY:7*w,direction:"W",blips:r,update(){({x:this.x,y:this.y,mapX:this.mapX,mapY:this.mapY,direction:this.direction}=oe(this)),this.blips.update()},render(){re(this),this.blips.render()}};return r.start(s),s};let te=null;var oe=e=>{let{direction:t}=e;const{map:o}=e,{mapX:a,mapY:c}=(({mapX:e,mapY:t,direction:o})=>{switch(o){case r:return{mapX:e,mapY:t-2.5};case s:return{mapX:e+2.5,mapY:t};case n:return{mapX:e,mapY:t+2.5};case i:return{mapX:e-2.5,mapY:t};default:return{mapX:e,mapY:t}}})(e),{x:d,y:g}=o.getXAndY({mapX:a,mapY:c});if(te||(te=Array(o.height).fill().map(()=>Array(o.width).fill(0))),(({mapX:e,mapY:t})=>e%y==0&&t%w==0)({mapX:a,mapY:c})){const e=o.tileAtLayer("main",{x:d,y:g}),{col:a,row:c}=o.getRowAndCol({x:d,y:g});if(te[c][a]++,(e=>f.includes(e))(e)){const{allowed:u}=p[e],f=(({viable:e,visits:t,row:o,col:a})=>{let l=Number.MAX_SAFE_INTEGER;return e.map(e=>{let c;switch(e){case r:c=t[o-1][a];break;case s:c=t[o][a+1];break;case n:c=t[o+1][a];break;case i:c=t[o][a-1]}return l=c<l?c:l,{dir:e,vis:c}}).filter(({vis:e})=>e===l).map(({dir:e})=>e)})({viable:u.filter(e=>e!==(e=>{switch(e){case r:return n;case s:return i;case n:return r;case i:return i;default:return null}})(t)&&h(o,{x:d,y:g},e)),visits:te,row:c,col:a});t=f[l(0,f.length-1)]}else t=u(o,{x:d,y:g},t)}return{direction:t,mapY:c,mapX:a,x:d,y:g}},re=e=>{const{context:t,x:o,y:r}=e;t.save(),t.translate(o,r),t.lineWidth=3,t.strokeStyle="#cd3926",t.fillStyle="#7a2431",t.beginPath(),t.moveTo(l(-5,5),l(-5,-25)),t.lineTo(l(5,50),l(-5,-50)),t.lineTo(l(5,25),l(-5,5)),t.lineTo(l(5,50),l(5,50)),t.lineTo(l(-5,5),l(5,25)),t.lineTo(l(-5,-50),l(5,50)),t.lineTo(l(-5,-25),l(-5,5)),t.lineTo(l(-5,-50),l(-5,-50)),t.closePath(),t.fill(),t.stroke(),t.restore()},se=({x:e,y:t})=>({context:kontra.context,x:e,y:t,ttl:180,radius:w,update(){this.radius+=10,this.ttl--},render(){ne(this)}}),ne=e=>{const{context:t,x:o,y:r,radius:s}=e;t.save(),t.translate(o,r),t.lineWidth=1,t.strokeStyle="#cd3926",t.beginPath(),t.arc(0,0,s,a(0),a(360)),t.closePath(),t.stroke(),t.restore()},ie=class{constructor(){this.blips=[]}start(e){setInterval(()=>{this.blips.push(se({x:e.x,y:e.y}))},1e3)}update(){this.blips.forEach(e=>e.update()),this.blips=this.blips.filter(e=>e.ttl>0)}render(){this.blips.forEach(e=>e.render())}},ae=(e,{row:t,col:o})=>{const{x:r,y:s}=e.getXAndY({row:t,col:o});return{context:kontra.context,x:r,y:s,collisionRadius:30,fuseLength:100,status:le,shrapnel:[],explosionDuration:0,map:e,mapX:o*y,mapY:t*w,row:t,col:o,update(){({status:this.status,fuseLength:this.fuseLength,explosionDuration:this.explosionDuration,x:this.x,y:this.y}=he(this))},render(){ce(this)}}};const le=0;var ce=e=>{const{status:t,shrapnel:o}=e;switch(t){case le:de(e);break;case 1:o.forEach(e=>e.render())}},de=e=>{const{context:t,x:o,y:r,fuseLength:s}=e;t.save(),t.translate(o,r),t.rotate(a(-45)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(23,-10),t.lineTo(40,-10),t.lineTo(40,10),t.lineTo(23,10),t.arc(0,0,25,a(19),a(341)),t.fill(),t.stroke();const n=s/100*90;t.beginPath(),t.moveTo(40,0),t.arc(40,25,25,a(270),a(270+n)),t.stroke();const i=25*Math.cos(a(n-90))+40,c=25*Math.sin(a(n-90))+25;t.fillStyle="#cd3926";for(let e=0;e<10;e++){const e=Math.cos(a(l(0,360)))*l(0,15)+i,o=Math.sin(a(l(0,360)))*l(0,15)+c;t.fillRect(e-1,o-1,3,3)}t.restore()},he=e=>{let{status:t,fuseLength:o,explosionDuration:r,x:s,y:n}=e;const{shrapnel:i,map:a,mapX:l,mapY:c,row:d,col:h}=e;switch(({x:s,y:n}=a.getXAndY({mapX:l,mapY:c})),t){case le:if((o-=1)<0){t=1,x.publish(k);for(let e=0;e<50;e++)i.push(ue({x:s,y:n}));const e=a.tileAtLayer("main",{row:d,col:h});a.changeTile("main",{row:d,col:h},e+24),x.publish(3,a),x.publish(4)}break;case 1:i.forEach(e=>e.update()),200===++r&&(t=2)}return{status:t,fuseLength:o,explosionDuration:r,x:s,y:n}},ue=({x:e,y:t})=>{const o=l(0,360),r=l(5,15);return{context:kontra.context,x:e,y:t,dx:Math.cos(a(o))*r,dy:Math.sin(a(o))*r,rotation:l(0,360),rotationDir:[l(-10,-1),l(1,10)][l(0,1)],update(){this.x+=this.dx,this.y+=this.dy,this.rotation+=this.rotationDir},render(){(e=>{const{context:t,x:o,y:r,rotation:s}=e;t.save(),t.translate(o,r),t.rotate(a(s)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(0,-10),t.lineTo(10,5),t.lineTo(-10,5),t.closePath(),t.fill(),t.stroke(),t.restore()})(this)}}};const pe=new function(){let e,t,o,r,s,n,i,a,l,c,d,h;this._params=new function(){this.setSettings=function(e){for(let t=0;t<24;t++)this[String.fromCharCode(97+t)]=e[t]||0;this.c<.01&&(this.c=.01);const t=this.b+this.c+this.e;if(t<.18){const e=.18/t;this.b*=e,this.c*=e,this.e*=e}}},this.reset=function(){const e=this._params;r=100/(e.f*e.f+.001),s=100/(e.g*e.g+.001),n=1-e.h*e.h*e.h*.01,i=-e.i*e.i*e.i*1e-6,e.a||(d=.5-e.n/2,h=5e-5*-e.o),a=e.l>0?1-e.l*e.l*.9:1+e.l*e.l*10,l=0,c=1==e.m?0:(1-e.m)*(1-e.m)*2e4+32},this.totalReset=function(){this.reset();const r=this._params;return e=r.b*r.b*1e5,t=r.c*r.c*1e5,o=r.e*r.e*1e5+10,e+t+o|0},this.synthWave=function(u,p){const f=this._params,g=1!=f.s||f.v;let b=f.v*f.v*.1;const m=1+3e-4*f.w;let y=f.s*f.s*f.s*.1;const w=1+1e-4*f.t,x=1!=f.s,v=f.x*f.x,k=f.g,T=f.q||f.r,M=f.r*f.r*f.r*.2;let S=f.q*f.q*(f.q<0?-1020:1020);const A=f.p?32+((1-f.p)*(1-f.p)*2e4|0):0,P=f.d,D=f.j/2,X=f.k*f.k*.01,Y=f.a;let C=e;const E=1/e,O=1/t,R=1/o;let L=5/(1+f.u*f.u*20)*(.01+y);L>.8&&(L=.8),L=1-L;let W,B,I,G,_=!1,j=0,H=0,N=0,$=0,z=0,q=0,F=0,U=0,J=0;var K,Q;let V=0;const Z=new Array(1024),ee=new Array(32);for(var te=Z.length;te--;)Z[te]=0;for(te=ee.length;te--;)ee[te]=2*Math.random()-1;for(te=0;te<p;te++){if(_)return te;if(A&&++J>=A&&(J=0,this.reset()),c&&++l>=c&&(c=0,r*=a),(r*=n+=i)>s&&(r=s,k>0&&(_=!0)),B=r,D>0&&(V+=X,B*=1+Math.sin(V)*D),(B|=0)<8&&(B=8),Y||((d+=h)<0?d=0:d>.5&&(d=.5)),++H>C)switch(H=0,++j){case 1:C=t;break;case 2:C=o}switch(j){case 0:N=H*E;break;case 1:N=1+2*(1-H*O)*P;break;case 2:N=1-H*R;break;case 3:N=0,_=!0}T&&((I=0|(S+=M))<0?I=-I:I>1023&&(I=1023)),g&&m&&((b*=m)<1e-5?b=1e-5:b>.1&&(b=.1)),Q=0;for(let e=8;e--;){if(++F>=B&&(F%=B,3==Y))for(let e=ee.length;e--;)ee[e]=2*Math.random()-1;switch(Y){case 0:K=F/B<d?.5:-.5;break;case 1:K=1-F/B*2;break;case 2:K=(K=(G=(G=F/B)>.5?6.28318531*(G-1):6.28318531*G)<0?1.27323954*G+.405284735*G*G:1.27323954*G-.405284735*G*G)<0?.225*(K*-K-K)+K:.225*(K*K-K)+K;break;case 3:K=ee[Math.abs(32*F/B|0)]}g&&(W=q,(y*=w)<0?y=0:y>.1&&(y=.1),x?(z+=(K-q)*y,z*=L):(q=K,z=0),$+=(q+=z)-W,K=$*=1-b),T&&(Z[U%1024]=K,K+=Z[(U-I+1024)%1024],U++),Q+=K}Q*=.125*N*v,u[te]=Q>=1?32767:Q<=-1?-32768:32767*Q|0}return p}};var fe=function(e){pe._params.setSettings(e);const t=pe.totalReset(),o=new Uint8Array(4*((t+1)/2|0)+44);let r=2*pe.synthWave(new Uint16Array(o.buffer,44),t);const s=new Uint32Array(o.buffer,0,44);s[0]=1179011410,s[1]=r+36,s[2]=1163280727,s[3]=544501094,s[4]=16,s[5]=65537,s[6]=44100,s[7]=88200,s[8]=1048578,s[9]=1635017060,s[10]=r,r+=44;let n=0;const i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";let a="data:audio/wav;base64,";for(;n<r;n+=3){const e=o[n]<<16|o[n+1]<<8|o[n+2];a+=i[e>>18]+i[e>>12&63]+i[e>>6&63]+i[63&e]}return n-=r,a.slice(0,a.length-n)+"==".slice(0,n)};function ge(){this.sounds={},function(e){e.add("infected",3,[[2,,.2916,,.2587,.9356,.3909,-.2493,,,,,,.3583,.1617,,,,1,,,.1217,,.5]]),e.add("drop-bomb",3,[[0,,.0641,.5296,.1228,.4195,,,,,,.3029,.6261,,,,,,1,,,,,.5]]),e.add("drop-ship",1,[[0,,.57,,.1398,.61,,-.26,.1,,,.02,,.3325,,,,,.9793,,,,,.5]]),e.add("explode",3,[[3,,.1606,.5988,.2957,.1157,,-.3921,,,,,,,,,.3225,-.2522,1,,,,,.25]])}(this)}ge.prototype.add=function(e,t,o){this.sounds[e]=[],o.forEach(function(o,r){this.sounds[e].push({tick:0,count:t,pool:[]});for(let s=0;s<t;s++){const t=new Audio;t.src=fe(o),this.sounds[e][r].pool.push(t)}},this)},ge.prototype.play=function(e){const t=this.sounds[e],o=t.length>1?t[Math.floor(Math.random()*t.length)]:t[0];o.pool[o.tick].play(),o.tick<o.count-1?o.tick++:o.tick=0};const be=new ge;(async()=>{(()=>{const e=document.createElement("canvas");e.width=b,e.height=m,e.style.cssText="\n        border: 4px solid #52638a;\n    ",document.getElementById("wrapper").appendChild(e)})(),kontra.init();const e=await W();(e=>{F.setDataFromMap(e,"main"),x.subscribe(3,e=>F.setDataFromMap(e,"main"))})(e);const t=I(e),o=ee(e),r=new class{constructor(e){this.map=e,this.bombs=[],x.subscribe(v,e=>this.dropBomb(e))}dropBomb(e){this.bombs.length>0&&this.bombs.find(({col:t,row:o})=>t===e.col&&o===e.row)||this.bombs.push(ae(this.map,e))}update(){this.bombs=this.bombs.filter(e=>(e.update(),2!==e.status))}render(){this.bombs.forEach(e=>e.render())}}(e),s=new class{constructor(e){this.map=e,this.users=[],this.gameOver=!1;for(let t=0;t<e.height;t++)for(let o=0;o<e.width;o++){const r=e.tileAtLayer("main",{row:t,col:o});r>=17&&r<=20&&this.users.push(U({map:e,row:t,col:o}))}x.subscribe(0,()=>this.gameOver=!0)}updateOnlineStatus(...e){const t=e.map(e=>({...e,...this.map.getRowAndCol({x:e.x,y:e.y})}));let o=0;for(const e of this.users.filter(({status:e})=>e===J))for(const r of t)F.isReachable(e,r)||(o++,e.status=K);if(o>0){const{online:e,offline:t,infected:o}=this.getStats();0===e?(B.show(`level completed<br>offline users: ${t}<br>infected users: ${o}`),x.publish(0)):B.flash(`${t} users went offline<br>good job!`)}}getStats(){return this.users.reduce((e,{status:t})=>({online:e.online+(t===J?1:0),offline:e.offline+(t===K?1:0),infected:e.infected+(t===Q?1:0)}),{online:0,offline:0,infected:0})}update(){this.users.forEach(e=>e.update())}render(){this.users.forEach(e=>e.render())}infect(...e){const{users:t,gameOver:o}=this,r=((e,t)=>{const o=[];for(let r=0;r<e.length;r++){const s=e[r];for(let e=0;e<t.length;e++){const r=t[e];c(s,r)&&o.push([s,r])}}return o})(t,e).filter(([e])=>e.status!==Q);if(0===r.length)return;if(r.forEach(([e])=>e.infect()),o)return;const{online:s,offline:n,infected:i}=this.getStats();if(0===s)return B.show(`level completed<br>offline users: ${n}<br>infected users: ${i}`),void x.publish(0);B.flash("user infected!")}}(e);x.subscribe(4,()=>s.updateOnlineStatus(o));const n=S({map:e,player:t,virus:o,users:s,bombs:r});x.subscribe(v,()=>be.play("drop-bomb")),x.subscribe(v,()=>console.log("drop bomb")),x.subscribe(k,()=>be.play("explode")),x.subscribe(T,()=>be.play("infected")),x.subscribe(M,()=>be.play("drop-ship")),n.start()})()}]);
//# sourceMappingURL=game.js.map
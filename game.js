!function(){"use strict";var e=new class{constructor(){this.subscribers=[]}subscribe(e,t){this.subscribers.push({message:e,callback:t})}publish(e,t){this.subscribers.forEach(({message:o,callback:s})=>o===e&&s(t))}};const t=0,o=1,s=6,r=7,n=2,a=4;const i=new function(){let e,t,o,s,r,n,a,i,l,c,h,d;this._params=new function(){this.setSettings=function(e){for(let t=0;t<24;t++)this[String.fromCharCode(97+t)]=e[t]||0;this.c<.01&&(this.c=.01);const t=this.b+this.c+this.e;if(t<.18){const e=.18/t;this.b*=e,this.c*=e,this.e*=e}}},this.reset=function(){const e=this._params;s=100/(e.f*e.f+.001),r=100/(e.g*e.g+.001),n=1-e.h*e.h*e.h*.01,a=-e.i*e.i*e.i*1e-6,e.a||(h=.5-e.n/2,d=5e-5*-e.o),i=e.l>0?1-e.l*e.l*.9:1+e.l*e.l*10,l=0,c=1==e.m?0:(1-e.m)*(1-e.m)*2e4+32},this.totalReset=function(){this.reset();const s=this._params;return e=s.b*s.b*1e5,t=s.c*s.c*1e5,o=s.e*s.e*1e5+10,e+t+o|0},this.synthWave=function(u,p){const f=this._params,m=1!=f.s||f.v;let g=f.v*f.v*.1;const b=1+3e-4*f.w;let y=f.s*f.s*f.s*.1;const w=1+1e-4*f.t,x=1!=f.s,v=f.x*f.x,k=f.g,T=f.q||f.r,M=f.r*f.r*f.r*.2;let S=f.q*f.q*(f.q<0?-1020:1020);const A=f.p?32+((1-f.p)*(1-f.p)*2e4|0):0,Y=f.d,D=f.j/2,X=f.k*f.k*.01,C=f.a;let E=e;const P=1/e,L=1/t,R=1/o;let W=5/(1+f.u*f.u*20)*(.01+y);W>.8&&(W=.8),W=1-W;let B,O,I,G,$=!1,H=0,N=0,z=0,_=0,q=0,j=0,F=0,U=0,J=0;var K,Q;let V=0;const Z=new Array(1024),ee=new Array(32);for(var te=Z.length;te--;)Z[te]=0;for(te=ee.length;te--;)ee[te]=2*Math.random()-1;for(te=0;te<p;te++){if($)return te;if(A&&++J>=A&&(J=0,this.reset()),c&&++l>=c&&(c=0,s*=i),(s*=n+=a)>r&&(s=r,k>0&&($=!0)),O=s,D>0&&(V+=X,O*=1+Math.sin(V)*D),(O|=0)<8&&(O=8),C||((h+=d)<0?h=0:h>.5&&(h=.5)),++N>E)switch(N=0,++H){case 1:E=t;break;case 2:E=o}switch(H){case 0:z=N*P;break;case 1:z=1+2*(1-N*L)*Y;break;case 2:z=1-N*R;break;case 3:z=0,$=!0}T&&((I=0|(S+=M))<0?I=-I:I>1023&&(I=1023)),m&&b&&((g*=b)<1e-5?g=1e-5:g>.1&&(g=.1)),Q=0;for(let e=8;e--;){if(++F>=O&&(F%=O,3==C))for(let e=ee.length;e--;)ee[e]=2*Math.random()-1;switch(C){case 0:K=F/O<h?.5:-.5;break;case 1:K=1-F/O*2;break;case 2:K=(K=(G=(G=F/O)>.5?6.28318531*(G-1):6.28318531*G)<0?1.27323954*G+.405284735*G*G:1.27323954*G-.405284735*G*G)<0?.225*(K*-K-K)+K:.225*(K*K-K)+K;break;case 3:K=ee[Math.abs(32*F/O|0)]}m&&(B=j,(y*=w)<0?y=0:y>.1&&(y=.1),x?(q+=(K-j)*y,q*=W):(j=K,q=0),_+=(j+=q)-B,K=_*=1-g),T&&(Z[U%1024]=K,K+=Z[(U-I+1024)%1024],U++),Q+=K}Q*=.125*z*v,u[te]=Q>=1?32767:Q<=-1?-32768:32767*Q|0}return p}};function l(e){i._params.setSettings(e);const t=i.totalReset(),o=new Uint8Array(4*((t+1)/2|0)+44);let s=2*i.synthWave(new Uint16Array(o.buffer,44),t);const r=new Uint32Array(o.buffer,0,44);r[0]=1179011410,r[1]=s+36,r[2]=1163280727,r[3]=544501094,r[4]=16,r[5]=65537,r[6]=44100,r[7]=88200,r[8]=1048578,r[9]=1635017060,r[10]=s,s+=44;let n=0;const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";let l="data:audio/wav;base64,";for(;n<s;n+=3){const e=o[n]<<16|o[n+1]<<8|o[n+2];l+=a[e>>18]+a[e>>12&63]+a[e>>6&63]+a[63&e]}return n-=s,l.slice(0,l.length-n)+"==".slice(0,n)}function c(){var e;this.sounds={},(e=this).add("infected",3,[[2,,.2916,,.2587,.9356,.3909,-.2493,,,,,,.3583,.1617,,,,1,,,.1217,,.5]]),e.add("drop-bomb",3,[[0,,.0641,.5296,.1228,.4195,,,,,,.3029,.6261,,,,,,1,,,,,.5]]),e.add("drop-ship",1,[[0,,.57,,.1398,.61,,-.26,.1,,,.02,,.3325,,,,,.9793,,,,,.5]]),e.add("explode",3,[[3,,.1606,.5988,.2957,.1157,,-.3921,,,,,,,,,.3225,-.2522,1,,,,,.25]])}c.prototype.add=function(e,t,o){this.sounds[e]=[],o.forEach(function(o,s){this.sounds[e].push({tick:0,count:t,pool:[]});for(let r=0;r<t;r++){const t=new Audio;t.src=l(o),this.sounds[e][s].pool.push(t)}},this)},c.prototype.play=function(e){const t=this.sounds[e],o=t.length>1?t[Math.floor(Math.random()*t.length)]:t[0];o.pool[o.tick].play(),o.tick<o.count-1?o.tick++:o.tick=0};const h=new c;const d="N",u="E",p="S",f="W";var m=e=>e*Math.PI/180,g=(e,t)=>{const o=Math.min(e,t),s=Math.max(e,t);return Math.floor(Math.random()*(s-o+1))+o},b=(e,t)=>{const o=[];for(let s=0;s<e.length;s++){const r=e[s];for(let e=0;e<t.length;e++){const s=t[e];y(r,s)&&o.push([r,s])}}return o},y=(e,t)=>{const o=e.x-t.x,s=e.y-t.y;return Math.sqrt(o*o+s*s)<e.collisionRadius+t.collisionRadius},w=e=>e>0&&e<25||e>30&&e<33||e>37&&e<41||e>44,x=(e,{x:t,y:o},s)=>{const r=e.tileAtLayer("main",{x:t,y:o});if(!w(r)||!k[r].allowed.includes(s))return!1;const n=M(e,{x:t,y:o},s);return w(n)},v=(e,{x:t,y:o},s)=>{const r=e.tileAtLayer("main",{x:t,y:o});if(!w(r))throw new Error("dropped");const n=k[r].change[s]||s;if(x(e,{x:t,y:o},n))return n;const a=k[r].allowed.filter(s=>x(e,{x:t,y:o},s));switch(a.length){case 0:throw new Error("locked in");case 1:return a[0];default:return a[g(0,a.length-1)]}},k={1:{allowed:[p,u],change:{[d]:u,[f]:p}},2:{allowed:[f,p],change:{[d]:f,[u]:p}},3:{allowed:[d,p],change:{}},4:{allowed:[f,d,u],change:{[p]:d}},5:{allowed:[d,u,p],change:{[f]:u}},6:{allowed:[f,u,p],change:{[d]:p}},9:{allowed:[d,u],change:{[p]:u,[f]:d}},10:{allowed:[f,d],change:{[u]:d,[p]:f}},11:{allowed:[f,u],change:{}},12:{allowed:[d,u,p,f],change:{}},13:{allowed:[d,p,f],change:{[u]:f}},17:{allowed:[p],change:{[d]:p}},18:{allowed:[f],change:{[u]:f}},19:{allowed:[d],change:{[p]:d}},20:{allowed:[u],change:{[f]:u}},14:{allowed:[d,p],change:{}},38:{allowed:[d,p],change:{}}};const T=[];for(const[e,{allowed:t}]of Object.entries(k))t.length>2&&T.push(Number(e));var M=(e,{x:t,y:o},s)=>e.tileAtLayer("main",{x:s===u?t+Y:s===f?t-Y:t,y:s===d?o-D:s===p?o+D:o});const S=800,A=600,Y=100,D=100,X=1e3,C="#75a042";var E=(e,{row:t,col:o})=>{const{x:s,y:r}=e.getXAndY({row:t,col:o});return{context:kontra.context,x:s,y:r,collisionRadius:30,fuseLength:100,status:P,shrapnel:[],explosionDuration:0,map:e,mapX:o*Y,mapY:t*D,row:t,col:o,update(){({status:this.status,fuseLength:this.fuseLength,explosionDuration:this.explosionDuration,x:this.x,y:this.y}=B(this))},render(){R(this)}}};const P=0,L=2;var R=e=>{const{status:t,shrapnel:o}=e;switch(t){case P:W(e);break;case 1:o.forEach(e=>e.render())}},W=e=>{const{context:t,x:o,y:s,fuseLength:r}=e;t.save(),t.translate(o,s),t.rotate(m(-45)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(23,-10),t.lineTo(40,-10),t.lineTo(40,10),t.lineTo(23,10),t.arc(0,0,25,m(19),m(341)),t.fill(),t.stroke();const n=r/100*90;t.beginPath(),t.moveTo(40,0),t.arc(40,25,25,m(270),m(270+n)),t.stroke();const a=25*Math.cos(m(n-90))+40,i=25*Math.sin(m(n-90))+25;t.fillStyle="#cd3926";for(let e=0;e<10;e++){const e=Math.cos(m(g(0,360)))*g(0,15)+a,o=Math.sin(m(g(0,360)))*g(0,15)+i;t.fillRect(e-1,o-1,3,3)}t.restore()},B=t=>{let{status:o,fuseLength:r,explosionDuration:n,x:i,y:l}=t;const{shrapnel:c,map:h,mapX:d,mapY:u,row:p,col:f}=t;switch(({x:i,y:l}=h.getXAndY({mapX:d,mapY:u})),o){case P:if((r-=1)<0){o=1,e.publish(s);for(let e=0;e<50;e++)c.push(O({x:i,y:l}));const t=h.tileAtLayer("main",{row:p,col:f});h.changeTile("main",{row:p,col:f},t+24),e.publish(3,h),e.publish(a)}break;case 1:c.forEach(e=>e.update()),200===++n&&(o=L)}return{status:o,fuseLength:r,explosionDuration:n,x:i,y:l}},O=({x:e,y:t})=>{const o=g(0,360),s=g(5,15);return{context:kontra.context,x:e,y:t,dx:Math.cos(m(o))*s,dy:Math.sin(m(o))*s,rotation:g(0,360),rotationDir:[g(-10,-1),g(1,10)][g(0,1)],update(){this.x+=this.dx,this.y+=this.dy,this.rotation+=this.rotationDir},render(){(e=>{const{context:t,x:o,y:s,rotation:r}=e;t.save(),t.translate(o,s),t.rotate(m(r)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(0,-10),t.lineTo(10,5),t.lineTo(-10,5),t.closePath(),t.fill(),t.stroke(),t.restore()})(this)}}};class I{constructor(t){this.map=t,this.bombs=[],e.subscribe(o,e=>this.dropBomb(e))}dropBomb(e){this.bombs.length>0&&this.bombs.find(({col:t,row:o})=>t===e.col&&o===e.row)||this.bombs.push(E(this.map,e))}update(){this.bombs=this.bombs.filter(e=>(e.update(),e.status!==L))}render(){this.bombs.forEach(e=>e.render())}}var G=({map:t,player:o,virus:s,users:r,bombs:a})=>{let i=!0;return e.subscribe(n,()=>i=!1),kontra.gameLoop({update(){s.update(),o.update(),o.infect(s),i&&((e,t)=>{switch(t){case d:e.sy-=5;break;case u:e.sx+=5;break;case p:e.sy+=5;break;case f:e.sx-=5}})(t,o.direction),r.update(),r.infect(s),a.update()},render(){t.render(),r.render(),a.render(),o.render(),s.render()}})},$=[0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,20,4,11,2,1,4,2,0,0,5,11,6,11,13,0,1,11,12,2,0,0,1,11,10,9,11,13,0,0,3,0,3,0,5,11,13,0,3,3,0,0,3,1,11,6,11,10,0,1,4,2,9,11,13,0,9,11,10,3,0,0,3,3,0,3,0,0,0,3,1,13,0,0,3,0,0,0,0,5,18,0,3,3,0,14,0,1,11,10,3,9,11,6,4,11,6,2,0,3,0,0,3,3,0,3,0,3,0,0,3,0,0,3,0,0,3,3,0,3,0,0,9,13,0,5,11,10,0,0,3,1,11,10,0,0,3,3,0,3,0,0,0,3,0,3,0,0,0,1,4,10,0,0,0,0,3,5,11,4,18,0,1,13,0,5,11,2,0,3,0,1,11,11,11,11,12,10,0,0,0,0,3,3,0,3,0,5,11,13,0,9,11,2,0,0,3,0,0,1,18,0,9,10,0,5,11,10,0,9,11,11,11,12,11,6,10,0,0,3,0,0,0,0,0,3,1,11,2,1,11,11,11,10,0,3,0,1,11,4,18,20,6,6,11,10,3,0,3,3,0,0,0,1,2,9,11,12,11,2,0,0,3,3,0,0,3,0,3,3,1,11,2,3,3,0,0,3,0,3,0,0,5,4,2,0,5,11,10,3,3,0,5,12,4,11,11,13,0,5,18,0,3,0,5,11,12,11,6,10,9,6,10,3,0,0,0,9,11,10,0,20,4,11,13,0,3,0,9,11,11,13,0,9,11,6,11,6,6,11,18,0,0,0,3,0,3,0,0,0,0,5,11,11,2,3,0,3,3,0,0,0,0,0,19,0,19,0,0,0,0,19,0,0,19,9,11,10,19,0,0];function H(e,t){return[Math.cos(m(e))*t+50,Math.sin(m(e))*t+50]}var N=({ctx:e,row:t,col:o,deg:s,broken:r=!1})=>{e.save(),e.translate((o-1)*Y+Y/2,(t-1)*D+D/2),e.rotate(m(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),r?(e.moveTo(20,50),e.arc(50,50,30,m(180),m(190)),e.moveTo(...H(190,30)),e.lineTo(10,45),e.lineTo(10,35),e.lineTo(-10,40),e.lineTo(...H(190,70)),e.arc(50,50,70,m(190),m(180),!0),e.moveTo(50,20),e.arc(50,50,30,m(270),m(260),!0),e.moveTo(...H(260,30)),e.lineTo(40,10),e.lineTo(45,0),e.lineTo(35,0),e.lineTo(...H(260,70)),e.arc(50,50,70,m(260),m(270))):(e.moveTo(20,50),e.arc(50,50,30,m(180),m(270)),e.moveTo(-20,50),e.arc(50,50,70,m(180),m(270))),e.stroke(),e.restore()},z=(e,t)=>t.forEach(([t,o,s])=>e[t?"lineTo":"moveTo"](o,s)),_=({ctx:e,row:t,col:o,deg:s,broken:r=!1})=>{e.save(),e.translate((o-1)*Y+Y/2,(t-1)*D+D/2),e.rotate(m(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),z(e,r?[[0,-20,50],[1,-20,30],[1,-10,40],[1,0,25],[1,10,35],[1,20,30],[1,20,50],[0,-20,-50],[1,-20,-40],[1,-10,-25],[1,0,-35],[1,10,-30],[1,20,-40],[1,20,-50]]:[[0,-20,-50],[1,-20,50],[0,20,-50],[1,20,50]]),e.stroke(),e.restore()},q=({ctx:e,row:t,col:o,deg:s,broken:r=!1})=>{e.save(),e.translate((o-1)*Y+Y/2,(t-1)*D+D/2),e.rotate(m(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),z(e,r?[[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,50,20]]),e.stroke(),e.restore()},j=({ctx:e,row:t,col:o,broken:s=!1})=>{e.save(),e.translate((o-1)*Y+Y/2,(t-1)*D+D/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),z(e,s?[[0,-20,50],[1,-20,45],[1,-10,40],[1,0,45],[1,10,35],[1,20,40],[1,20,50],[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,-20,20],[1,-20,50],[0,50,20],[1,20,20],[1,20,50]]),e.stroke(),e.restore()},F=({ctx:e,row:t,col:o,broken:s})=>{e.save(),e.translate((o-1)*Y+Y/2,(t-1)*D+D/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),z(e,[[0,30,-48],[1,48,-30],[1,48,30],[1,30,48],[1,-30,48],[1,-48,30],[1,-48,-30],[1,-30,-48],[1,30,-48]]),e.stroke(),s&&(e.lineWidth=2,z(e,[[0,10,-48],[1,0,-40],[0,24,-48],[1,20,-30],[0,48,-27],[1,20,-20],[0,-10,-30],[1,10,-30],[1,30,-10],[1,20,0],[1,10,0],[0,48,7],[1,30,10],[0,20,0],[1,30,10],[1,10,20],[0,30,48],[1,30,30],[1,10,30],[0,20,20],[1,20,30],[0,-10,48],[1,-10,20],[1,0,10],[0,-20,0],[1,-20,20],[1,-10,30],[0,-30,48],[1,-20,40],[1,-20,30],[0,-30,30],[1,-20,40],[0,-48,20],[1,-30,20],[0,-40,20],[1,-40,10],[0,-48,0],[1,-30,0],[1,-20,-10],[0,-40,0],[1,-30,10],[0,-48,-17],[1,-40,-30],[1,-30,-20],[0,-30,-48],[1,-10,-20],[1,-10,-10],[0,-20,-30],[1,-20,-20],[1,-30,-10]]),e.stroke()),e.restore()},U=({ctx:e,row:t,col:o,deg:s,broken:r=!1})=>{e.save(),e.translate((o-1)*Y+Y/2,(t-1)*D+D/2),e.rotate(m(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),z(e,r?[[0,-20,50],[1,-20,40],[1,-10,45],[1,0,35],[1,10,45],[1,20,40],[1,20,50]]:[[0,-20,50],[1,-20,0],[1,20,0],[1,20,50]]),e.stroke(),e.restore()},J=(e={})=>{const t=e.width,o=e.height,s=e.tileWidth||32,r=e.tileHeight||32,n=t*s,a=o*r,i=e.context||kontra.context,l=i.canvas.width,c=i.canvas.height,h=document.createElement("canvas"),d=h.getContext("2d"),u=Math.max(0,n-l),p=Math.max(0,a-c);let f,m;const g=[],b={width:t,height:o,tileWidth:s,tileHeight:r,mapWidth:n,mapHeight:a,context:i,x:e.x||0,y:e.y||0,tilesets:[],layers:{},addTilesets:function(e){[].concat(e).forEach(e=>{const t=e.image;let o,n,a,i;if(`${t}`===t){let e=1/0;for(;e>=0;){const s=(e=t.lastIndexOf("/",e))<0?t:t.substr(e);if(kontra.assets.images[s]){o=kontra.assets.images[s];break}e--}}else o=t;n=e.firstGrid;const l=(o.width/s|0||1)*(o.height/r|0||1);n||(b.tilesets.length>0?(i=((a=b.tilesets[b.tilesets.length-1]).image.width/s|0)*(a.image.height/r|0),n=a.firstGrid+i):n=1),b.tilesets.push({firstGrid:n,lastGrid:n+l-1,image:o}),b.tilesets.sort((e,t)=>e.firstGrid-t.firstGrid)})},addLayers:function(e){[].concat(e).forEach(e=>{let o,s,r,n;if(e.render=void 0===e.render||e.render,Array.isArray(e.data[0])){o=[];for(let n=0;s=e.data[n];n++)for(r=0;r<t;r++)o.push(s[r]||0)}else o=e.data;b.layers[e.name]={data:o,zIndex:e.zIndex||0,render:e.render};for(const t in e.properties)if(e.properties.hasOwnProperty(t)){n=e.properties[t];try{n=JSON.parse(n)}catch(e){}b.layers[e.name][t]=n}b.layers[e.name].render&&(g.push(e.name),g.sort((e,t)=>b.layers[e].zIndex-b.layers[t].zIndex))}),function(){for(let e,t=0;e=b.layers[g[t]];t++)for(let t=0,o=e.data.length;t<o;t++)x(e,t)}()},changeTile(e,t,o){const s=y(t),r=b.layers[e];r.data[s]=o,x(r,s,!0)},tileAtLayer(e,t){const o=y(t);if(o>=0)return b.layers[e].data[o]},render(){b.context.drawImage(h,b.sx,b.sy,l,c,b.x,b.y,l,c)},renderLayer:function(e){const n=b.layers[e];let a=b.getRow();const i=b.getCol();let h=y({row:a,col:i});const d=i*s-b.sx,u=a*r-b.sy,p=Math.min(Math.ceil(l/s)+1,t),f=p*Math.min(Math.ceil(c/r)+1,o);let m,g,x,v,k,T,M,S,A,Y=0;for(;Y<f;)(x=n.data[h])&&(k=(v=w(x)).image,m=d+Y%p*s,g=u+(Y/p|0)*r,S=(T=x-v.firstGrid)%(M=k.width/s)*s,A=(T/M|0)*r,b.context.drawImage(k,S,A,s,r,m,g,s,r)),++Y%p==0?h=i+ ++a*t:h++},getRowAndCol({x:e,y:t}){return{row:this.getRow(t),col:this.getCol(e)}},getXAndY:({row:e,col:t,mapX:o,mapY:n})=>({x:(t?t*s:o)-b.sx+s/2,y:(e?e*r:n)-b.sy+r/2}),getRow:(e=0)=>(b.sy+e)/r|0,getCol:(e=0)=>(b.sx+e)/s|0,get sx(){return f},get sy(){return m},set sx(e){f=Math.min(Math.max(0,e),u)},set sy(e){m=Math.min(Math.max(0,e),p)}};b.sx=e.sx||0,b.sy=e.sy||0,h.width=n,h.height=a;for(const t in e.properties)if(e.properties.hasOwnProperty(t)){let o=e.properties[t];try{o=JSON.parse(o)}catch(e){}b[t]=b[t]||o}function y(e){let s,r;return void 0!==e.x&&void 0!==e.y?(s=b.getRow(e.y),r=b.getCol(e.x)):(s=e.row,r=e.col),s<0||r<0||s>=o||r>=t?-1:r+s*t}function w(e){let t,o,s=0,r=b.tilesets.length-1;for(;s<=r;){if(t=(s+r)/2|0,e>=(o=b.tilesets[t]).firstGrid&&e<=o.lastGrid)return o;o.lastGrid<e?s=t+1:r=t-1}}function x(e,o,n=!1){const a=e.data[o];if(!a)return;const i=w(a),l=i.image,c=o%t*s,h=(o/t|0)*r,u=a-i.firstGrid,p=l.width/s,f=u%p*s,m=(u/p|0)*r;n&&d.clearRect(c,h,s,r),d.drawImage(l,f,m,s,r,c,h,s,r)}return e.tilesets&&b.addTilesets(e.tilesets),e.layers&&b.addLayers(e.layers),b},K=async()=>{const{sx:e,sy:t}=(({col:e,row:t})=>({sx:e*Y-S/2+Y/2,sy:t*D-A/2+D/2}))({col:8,row:9}),o=J({tileWidth:Y,tileHeight:D,width:28,height:28,sx:e,sy:t}),s=((e,t,o,s)=>{const r=[];let n=0;for(let a=0;a<o+2*s;a++)for(let i=0;i<t+2*s;i++)a<s||a>=s+o||i<s||i>=s+t?r.push(0):r.push(e[n++]);return r})($,20,20,4),r=await(()=>{const e=document.createElement("canvas");e.width=8*Y,e.height=8*D;const t=e.getContext("2d");N({ctx:t,row:1,col:1,deg:0}),N({ctx:t,row:1,col:2,deg:90}),N({ctx:t,row:2,col:1,deg:270}),N({ctx:t,row:2,col:2,deg:180}),_({ctx:t,row:1,col:3,deg:0}),_({ctx:t,row:2,col:3,deg:90}),q({ctx:t,row:1,col:4,deg:0}),q({ctx:t,row:1,col:5,deg:90}),q({ctx:t,row:1,col:6,deg:180}),q({ctx:t,row:2,col:5,deg:270}),j({ctx:t,row:2,col:4}),U({ctx:t,row:3,col:1,deg:0}),U({ctx:t,row:3,col:2,deg:90}),U({ctx:t,row:3,col:3,deg:180}),U({ctx:t,row:3,col:4,deg:270}),F({ctx:t,row:2,col:6}),N({ctx:t,row:4,col:1,deg:0,broken:!0}),N({ctx:t,row:4,col:2,deg:90,broken:!0}),N({ctx:t,row:5,col:1,deg:270,broken:!0}),N({ctx:t,row:5,col:2,deg:180,broken:!0}),_({ctx:t,row:4,col:3,deg:0,broken:!0}),_({ctx:t,row:5,col:3,deg:90,broken:!0}),q({ctx:t,row:4,col:4,deg:0,broken:!0}),q({ctx:t,row:4,col:5,deg:90,broken:!0}),q({ctx:t,row:4,col:6,deg:180,broken:!0}),q({ctx:t,row:5,col:5,deg:270,broken:!0}),j({ctx:t,row:5,col:4,broken:!0}),U({ctx:t,row:6,col:1,deg:0,broken:!0}),U({ctx:t,row:6,col:2,deg:90,broken:!0}),U({ctx:t,row:6,col:3,deg:180,broken:!0}),U({ctx:t,row:6,col:4,deg:270,broken:!0}),F({ctx:t,row:5,col:6,broken:!0});const o=new Image;return o.src=e.toDataURL("image/png"),new Promise(e=>setTimeout(()=>e(o),100))})();return o.addTilesets({image:r}),o.addLayers([{name:"main",data:s}]),o};var Q=new class{constructor(){this.timeoutHandler=null,this.div=document.createElement("div"),this.div.style.cssText="\nbackground-color: rgba(0,0,0,0.3);\nfont-size: 3em;\nfont-weight: bold;\nalign-items: center;\njustify-content: center;\ndisplay: flex;\ncolor: white;\nopacity: 0;\nposition: absolute;\ntop: 0;\nleft:0;\nwidth: 100vw;\nheight: 100vh;\ntext-align: center;\npointer-events: none;\ntransition: background-color 3s ease-out, color 3s ease-out;\ntext-transform: uppercase;\nfont-family: monospace;\n    ",document.getElementById("wrapper").appendChild(this.div)}show(e){clearTimeout(this.timeoutHandler),this.div.style.transition="3s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.opacity=1}flash(e){clearTimeout(this.timeoutHandler),this.div.style.transition="0.5s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.opacity=1,this.timeoutHandler=setTimeout(()=>this.div.style.opacity=0,500)}clear(){clearTimeout(this.timeoutHandler),this.div.style.transition="0.5s",this.div.style.opacity=0}},V=o=>{const s={context:kontra.context,x:S/2,y:A/2,collisionRadius:30,map:o,infected:!1,gameOver:!0,direction:"N",nextDirection:null,dropBomb:!1,scale:1,dropping:!1,bombCoolingDown:!1,update(){({nextDirection:this.nextDirection,direction:this.direction,dropBomb:this.dropBomb,scale:this.scale,bombCoolingDown:this.bombCoolingDown}=ee(this,e,Q))},render(){Z(this)},infect(o){y(o,this)&&(this.infected=!0,this.gameOver||(Q.show("player infected<br>game over"),e.publish(t)))},enableControls(){this.gameOver=!1}};return e.subscribe(t,()=>s.gameOver=!0),e.subscribe(n,()=>s.dropping=!0),s},Z=e=>{const{context:t,x:o,y:s,direction:r,infected:n,scale:a}=e;t.save(),t.translate(o,s),t.scale(a,a),t.rotate((e=>{switch(e){case d:return m(0);case u:return m(90);case p:return m(180);case f:return m(270);default:return null}})(r)),t.lineWidth=3,t.strokeStyle=n?"#cd3926":C,t.fillStyle=n?"#7a2431":"#365b1d",t.beginPath(),t.moveTo(-15,25),t.lineTo(0,-25),t.lineTo(15,25),t.closePath(),t.fill(),t.stroke(),t.restore()},ee=s=>{let{nextDirection:r,direction:a,dropBomb:i,scale:l,bombCoolingDown:c}=s;const{dropping:h,map:m,gameOver:g,x:b,y:y}=s;if(h)return l>0?l-=.01:(Q.show("You fell into the abyss<br>Game over"),e.publish(t)),{direction:a,nextDirection:r,dropBomb:i,scale:l,bombCoolingDown:c};if(g||(({nextDirection:r,dropBomb:i}=(e=>{let{nextDirection:t,dropBomb:o}=e;return kontra.keys.pressed("right")&&(t=u),kontra.keys.pressed("left")&&(t=f),kontra.keys.pressed("up")&&(t=d),kontra.keys.pressed("down")&&(t=p),kontra.keys.pressed("space")&&(o=!0),{nextDirection:t,dropBomb:o}})(s)),c&&(i=!1)),!(({x:e,y:t})=>(e-Y/2)%Y==0&&(t-D/2)%D==0)({x:m.sx,y:m.sy}))return{direction:a,nextDirection:r,dropBomb:i,scale:l,bombCoolingDown:c};if(r&&x(m,{x:b,y:y},r))a=r,r=null;else try{a=v(m,{x:b,y:y},a)}catch({message:t}){"dropped"===t&&e.publish(n)}return i&&(e.publish(o,m.getRowAndCol({x:b,y:y})),i=!1,c=!0,setTimeout(()=>{s.bombCoolingDown=!1},100)),{direction:a,nextDirection:r,dropBomb:i,scale:l,bombCoolingDown:c}},te=(e,t)=>{const o=[];let s=t;for(;void 0!==s;)o.push(s),s=e.get(s);return o.reverse(),o},oe=(e,t)=>{let o=t.shift();const s=[];let r,n,a;for(;t.length;){if(r=t.shift(),!(n=se(e,o,r)))return null;if(a=te(n,r),!t.length)return s.concat(a);s.push.apply(s,a.slice(0,-1)),o=r}return null},se=(e,t,o)=>{const s=new Map([[t,0]]),r=new Map([[0,[t]]]),n=new Map;function a(e,t){let o=r.get(e);o||(o=[],r.set(e,o)),o.push(t)}for(;r.size>0;){const t=Array.from(r.keys()).sort((e,t)=>e-t)[0],o=r.get(t),i=o.shift(),l=e.get(i)||new Map;0===o.length&&r.delete(t);for(const[e,o]of l){const r=o+t,l=s.get(e);(void 0===l||l>r)&&(s.set(e,r),a(r,e),n.set(e,i))}}return void 0===s.get(o)?null:n},re=({width:e,layers:t},o)=>{const{graph:s,allowed:r}=ae(t[o].data,e);for(const[e,t]of s){const o=r.get(e),{row:n,col:a}=e;let i;for(const e of o)switch(e){case d:(i=ne(s,{row:n-1,col:a}))&&t.set(i,1);break;case u:(i=ne(s,{row:n,col:a+1}))&&t.set(i,1);break;case p:(i=ne(s,{row:n+1,col:a}))&&t.set(i,1);break;case f:(i=ne(s,{row:n,col:a-1}))&&t.set(i,1)}}return s},ne=(e,{row:t,col:o})=>{for(const[s]of e)if(t===s.row&&o===s.col)return s;return null},ae=(e,t)=>{const o=new Map,s=new Map;let r=0,n=0,a=0;for(const i of e){if(w(i)){const e={row:r,col:n};s.set(e,k[i].allowed),o.set(e,new Map)}++a%t==0?(r++,n=0):n++}return{graph:o,allowed:s}};var ie=new class{constructor(e=null){this.graph=e}setDataFromMap(e,t){this.graph=re(e,t)}getNodeByCoords(e){return ne(this.graph,e)}findShortestPath(...e){return oe(this.graph,e)}isReachable(e,t){return null!==this.findShortestPathByCoords(e,t)}findShortestPathByCoords(...e){return this.findShortestPath(...e.map(e=>this.getNodeByCoords(e)))}},le=t=>{ie.setDataFromMap(t,"main"),e.subscribe(3,e=>ie.setDataFromMap(e,"main"))};class ce{constructor(o){this.map=o,this.users=[],this.gameOver=!1;for(let e=0;e<o.height;e++)for(let t=0;t<o.width;t++){const s=o.tileAtLayer("main",{row:e,col:t});s>=17&&s<=20&&this.users.push(he({map:o,row:e,col:t}))}e.subscribe(t,()=>this.gameOver=!0)}updateOnlineStatus(...o){const s=o.map(e=>({...e,...this.map.getRowAndCol({x:e.x,y:e.y})}));let r=0;for(const e of this.users.filter(({status:e})=>e===de))for(const t of s){ie.isReachable(e,t)||(r++,e.status=ue)}if(r>0){const{online:o,offline:s,infected:r}=this.getStats();0===o?(Q.show(`level completed<br>offline users: ${s}<br>infected users: ${r}`),e.publish(t)):Q.flash(`${s} users went offline<br>good job!`)}}getStats(){return this.users.reduce((e,{status:t})=>({online:e.online+(t===de?1:0),offline:e.offline+(t===ue?1:0),infected:e.infected+(t===pe?1:0)}),{online:0,offline:0,infected:0})}update(){this.users.forEach(e=>e.update())}render(){this.users.forEach(e=>e.render())}infect(...o){const{users:s,gameOver:r}=this,n=b(s,o).filter(([e])=>e.status!==pe);if(0===n.length)return;if(n.forEach(([e])=>e.infect()),r)return;const{online:a,offline:i,infected:l}=this.getStats();if(0===a)return Q.show(`level completed<br>offline users: ${i}<br>infected users: ${l}`),void e.publish(t);Q.flash("user infected!")}}var he=({map:t,row:o,col:s})=>{const{x:n,y:a}=t.getXAndY({row:o,col:s});return{context:kontra.context,x:n,y:a,collisionRadius:30,infected:!1,map:t,mapX:s*Y,mapY:o*D,row:o,col:s,status:de,update(){({x:this.x,y:this.y}=t.getXAndY({mapX:this.mapX,mapY:this.mapY}))},render(){me(this)},infect(){this.status=pe,e.publish(r)}}};const de=0,ue=1,pe=2,fe={[de]:{fg:"#52638a",bg:"#2b3653"},[ue]:{fg:C,bg:"#365b1d"},[pe]:{fg:"#cd3926",bg:"#7a2431"}};var me=e=>{const{context:t,x:o,y:s,status:r}=e,{fg:n,bg:a}=fe[r];t.save(),t.translate(o,s),t.lineWidth=3,t.strokeStyle=n,t.fillStyle=a,t.beginPath(),t.moveTo(-40,40),t.lineTo(-40,20),t.arc(-20,20,20,m(180),m(270)),t.moveTo(-20,0),t.lineTo(20,0),t.arc(20,20,20,m(270),m(0)),t.lineTo(40,40),t.lineTo(-40,40),t.moveTo(-23,20),t.lineTo(-23,40),t.moveTo(23,20),t.lineTo(23,40),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-15,25,m(0),m(360)),t.fill(),t.stroke(),t.restore()},ge=e=>{const{x:t,y:o}=e.getXAndY({row:7,col:8}),s=new class{constructor(){this.blips=[]}start(e){setInterval(()=>{this.blips.push(xe({x:e.x,y:e.y}))},X)}update(){this.blips.forEach(e=>e.update()),this.blips=this.blips.filter(e=>e.ttl>0)}render(){this.blips.forEach(e=>e.render())}},r={context:kontra.context,x:t,y:o,collisionRadius:30,map:e,mapX:8*Y,mapY:7*D,direction:"W",blips:s,update(){({x:this.x,y:this.y,mapX:this.mapX,mapY:this.mapY,direction:this.direction}=ye(this)),this.blips.update()},render(){we(this),this.blips.render()}};return s.start(r),r};let be=null;var ye=e=>{let{direction:t}=e;const{map:o}=e,{mapX:s,mapY:r}=(({mapX:e,mapY:t,direction:o})=>{switch(o){case d:return{mapX:e,mapY:t-2.5};case u:return{mapX:e+2.5,mapY:t};case p:return{mapX:e,mapY:t+2.5};case f:return{mapX:e-2.5,mapY:t};default:return{mapX:e,mapY:t}}})(e),{x:n,y:a}=o.getXAndY({mapX:s,mapY:r});if(be||(be=Array(o.height).fill().map(()=>Array(o.width).fill(0))),(({mapX:e,mapY:t})=>e%Y==0&&t%D==0)({mapX:s,mapY:r})){const e=o.tileAtLayer("main",{x:n,y:a}),{col:s,row:r}=o.getRowAndCol({x:n,y:a});if(be[r][s]++,(e=>T.includes(e))(e)){const{allowed:i}=k[e],l=(({viable:e,visits:t,row:o,col:s})=>{let r=Number.MAX_SAFE_INTEGER;return e.map(e=>{let n;switch(e){case d:n=t[o-1][s];break;case u:n=t[o][s+1];break;case p:n=t[o+1][s];break;case f:n=t[o][s-1]}return r=n<r?n:r,{dir:e,vis:n}}).filter(({vis:e})=>e===r).map(({dir:e})=>e)})({viable:i.filter(e=>e!==(e=>{switch(e){case d:return p;case u:return f;case p:return d;case f:return f;default:return null}})(t)&&x(o,{x:n,y:a},e)),visits:be,row:r,col:s});t=l[g(0,l.length-1)]}else t=v(o,{x:n,y:a},t)}return{direction:t,mapY:r,mapX:s,x:n,y:a}},we=e=>{const{context:t,x:o,y:s}=e;t.save(),t.translate(o,s),t.lineWidth=3,t.strokeStyle="#cd3926",t.fillStyle="#7a2431",t.beginPath(),t.moveTo(g(-5,5),g(-5,-25)),t.lineTo(g(5,50),g(-5,-50)),t.lineTo(g(5,25),g(-5,5)),t.lineTo(g(5,50),g(5,50)),t.lineTo(g(-5,5),g(5,25)),t.lineTo(g(-5,-50),g(5,50)),t.lineTo(g(-5,-25),g(-5,5)),t.lineTo(g(-5,-50),g(-5,-50)),t.closePath(),t.fill(),t.stroke(),t.restore()},xe=({x:e,y:t})=>({context:kontra.context,x:e,y:t,ttl:180,radius:D,update(){this.radius+=10,this.ttl--},render(){ve(this)}}),ve=e=>{const{context:t,x:o,y:s,radius:r}=e;t.save(),t.translate(o,s),t.lineWidth=1,t.strokeStyle="#cd3926",t.beginPath(),t.arc(0,0,r,m(0),m(360)),t.closePath(),t.stroke(),t.restore()};var ke=()=>{const e=document.createElement("canvas");e.width=S,e.height=A,e.style.cssText="\n        border: 4px solid #52638a;\n    ",document.getElementById("wrapper").appendChild(e)};var Te=new class{async init(){ke(),kontra.init();const t=await K();le(t),this.player=V(t);const i=ge(t),l=new I(t),c=new ce(t);e.subscribe(a,()=>c.updateOnlineStatus(i)),this.loop=G({map:t,player:this.player,virus:i,users:c,bombs:l}),e.subscribe(o,()=>h.play("drop-bomb")),e.subscribe(o,()=>console.log("drop bomb")),e.subscribe(s,()=>h.play("explode")),e.subscribe(r,()=>h.play("infected")),e.subscribe(n,()=>h.play("drop-ship")),t.render(),c.render(),l.render(),this.player.render(),i.render()}showStartScreen(){Q.show(`\n            welcome, <span style="color:${C}; font-size: 150%">captain katamov!</span><br><br>\n            Your shift as chief network security officers is about to begin… all users are online and happy. \n            in case of virus intrusion, <span style="color: ${C}">cut them off</span> from the network\n            to make sure they don't get infected!<br><br>\n            <table style="font-size: 75%; text-align: left; margin-left: auto; margin-right: auto">\n                <tr>\n                    <td><span style="color: ${C}">arrow keys</span></td>\n                    <td>…</td><td>change direction</td>\n                </tr><tr>\n                    <td><span style="color: ${C}">space bar</span></td>\n                    <td>…</td><td>drop bomb</td>\n                </tr><tr>\n                    <td><span style="color: ${C}">return</span></td>\n                    <td>…</td><td>teleport to server</td>\n                </tr>\n            </table>\n            <br>\n            press any key to begin!\n        `),document.addEventListener("keydown",()=>{Q.clear(),this.startLevel(),setTimeout(()=>this.player.enableControls(),500)},{once:!0})}startLevel(){this.loop.start()}};(async()=>{await Te.init(),Te.showStartScreen()})()}();
//# sourceMappingURL=game.js.map
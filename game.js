!function(e){var t={};function r(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(s,i,function(t){return e[t]}.bind(null,i));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);const s="N",i="E",o="S",a="W";var n=(e,{x:t,y:r},s)=>{const i=e.tileAtLayer("main",{x:t,y:r});if(!y(i)||!u[i].allowed.includes(s))return!1;const o=m(e,{x:t,y:r},s);return y(o)},h=e=>e*Math.PI/180,l=(e,t)=>{const r=Math.min(e,t),s=Math.max(e,t);return Math.floor(Math.random()*(s-r+1))+r},c=(e,{row:t,col:r,x:s,y:i})=>{const{tileWidth:o,tileHeight:a,sx:n,sy:h}=e;return{x:(void 0!==s?s:(r-1)*o)-n+b/2+o/2,y:(void 0!==i?i:(t-1)*a)-h+g/2+a/2}},p=(e,t)=>{const r=e.x-t.x,s=e.y-t.y;return Math.sqrt(r*r+s*s)<e.collisionRadius+t.collisionRadius},d=(e,{x:t,y:r},s)=>{const i=e.tileAtLayer("main",{x:t,y:r});if(!y(i))throw new Error("dropped");const o=u[i].change[s]||s;if(n(e,{x:t,y:r},o))return o;const a=u[i].allowed.filter(s=>n(e,{x:t,y:r},s));switch(a.length){case 0:throw new Error("locked in");case 1:return a[0];default:return a[l(0,a.length-1)]}},u={1:{allowed:[o,i],change:{[s]:i,[a]:o}},2:{allowed:[a,o],change:{[s]:a,[i]:o}},3:{allowed:[s,o],change:{}},4:{allowed:[a,s,i],change:{[o]:s}},5:{allowed:[s,i,o],change:{[a]:i}},6:{allowed:[a,i,o],change:{[s]:o}},9:{allowed:[s,i],change:{[o]:i,[a]:s}},10:{allowed:[a,s],change:{[i]:s,[o]:a}},11:{allowed:[a,i],change:{}},12:{allowed:[s,i,o,a],change:{}},13:{allowed:[s,o,a],change:{[i]:a}},14:{allowed:[s,o],change:{}},17:{allowed:[o],change:{[s]:o}},18:{allowed:[a],change:{[i]:a}},19:{allowed:[s],change:{[o]:s}},20:{allowed:[i],change:{[a]:i}},38:{allowed:[s,o],change:{}}};const f=[];for(const[e,{allowed:t}]of Object.entries(u))t.length>2&&f.push(Number(e));var m=(e,{x:t,y:r},n)=>e.tileAtLayer("main",{x:n===i?t+w:n===a?t-w:t,y:n===s?r-_:n===o?r+_:r}),y=e=>e<25||e>30&&e<33||e>37&&e<41||e>44;const b=800,g=600,w=100,_=100;var v=new class{constructor(){this.subscribers=[]}subscribe(e,t){this.subscribers.push({message:e,callback:t})}publish(e,t){this.subscribers.forEach(({message:r,callback:s})=>r===e&&s(t))}};const x=1,k=6,M=7;var T=({map:e,player:t,virus:r,users:n,bombs:h})=>{let l=!0;return v.subscribe(2,()=>l=!1),kontra.gameLoop({update(){r.update(),t.update(),t.infect(r),l&&((e,t)=>{switch(t){case s:e.sy-=5;break;case i:e.sx+=5;break;case o:e.sy+=5;break;case a:e.sx-=5}})(e,t.direction),n.update(),n.infect([r]),h.update()},render(){e.render(),n.render(),h.render(),t.render(),r.render()}})},S=[0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,20,4,11,2,1,4,2,0,0,5,11,6,11,13,0,1,11,12,2,0,0,1,11,10,9,11,13,0,0,3,0,3,0,5,11,13,0,3,3,0,0,3,1,11,6,11,10,0,1,4,2,9,11,13,0,9,11,10,3,0,0,3,3,0,3,0,0,0,3,1,13,0,0,3,0,0,0,0,5,18,0,3,3,0,14,0,1,11,10,3,9,11,6,4,11,6,2,0,3,0,0,3,3,0,3,0,3,0,0,3,0,0,3,0,0,3,3,0,3,0,0,9,13,0,5,11,10,0,0,3,1,11,10,0,0,3,3,0,3,0,0,0,3,0,3,0,0,0,1,4,10,0,0,0,0,3,5,11,4,18,0,1,13,0,5,11,2,0,3,0,1,11,11,11,11,12,10,0,0,0,0,3,3,0,3,0,5,11,13,0,9,11,2,0,0,3,0,0,1,18,0,9,10,0,5,11,10,0,9,11,11,11,12,11,6,10,0,0,3,0,0,0,0,0,3,1,11,2,1,11,11,11,10,0,3,0,1,11,4,18,20,6,6,11,10,3,0,3,3,0,0,0,1,2,9,11,12,11,2,0,0,3,3,0,0,3,0,3,3,1,11,2,3,3,0,0,3,0,3,0,0,5,4,2,0,5,11,10,3,3,0,5,12,4,11,11,13,0,5,18,0,3,0,5,11,12,11,6,10,9,6,10,3,0,0,0,9,11,10,0,20,4,11,13,0,3,0,9,11,11,13,0,9,11,6,11,6,6,11,18,0,0,0,3,0,3,0,0,0,0,5,11,11,2,3,0,3,3,0,0,0,0,0,19,0,19,0,0,0,0,19,0,0,19,9,11,10,19,0,0];function C(e,t){return[Math.cos(h(e))*t+50,Math.sin(h(e))*t+50]}var P=({ctx:e,row:t,col:r,deg:s,broken:i=!1})=>{e.save(),e.translate((r-1)*w+w/2,(t-1)*_+_/2),e.rotate(h(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),i?(e.moveTo(20,50),e.arc(50,50,30,h(180),h(190)),e.moveTo(...C(190,30)),e.lineTo(10,45),e.lineTo(10,35),e.lineTo(-10,40),e.lineTo(...C(190,70)),e.arc(50,50,70,h(190),h(180),!0),e.moveTo(50,20),e.arc(50,50,30,h(270),h(260),!0),e.moveTo(...C(260,30)),e.lineTo(40,10),e.lineTo(45,0),e.lineTo(35,0),e.lineTo(...C(260,70)),e.arc(50,50,70,h(260),h(270))):(e.moveTo(20,50),e.arc(50,50,30,h(180),h(270)),e.moveTo(-20,50),e.arc(50,50,70,h(180),h(270))),e.stroke(),e.restore()},R=(e,t)=>t.forEach(([t,r,s])=>e[t?"lineTo":"moveTo"](r,s)),q=({ctx:e,row:t,col:r,deg:s,broken:i=!1})=>{e.save(),e.translate((r-1)*w+w/2,(t-1)*_+_/2),e.rotate(h(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),R(e,i?[[0,-20,50],[1,-20,30],[1,-10,40],[1,0,25],[1,10,35],[1,20,30],[1,20,50],[0,-20,-50],[1,-20,-40],[1,-10,-25],[1,0,-35],[1,10,-30],[1,20,-40],[1,20,-50]]:[[0,-20,-50],[1,-20,50],[0,20,-50],[1,20,50]]),e.stroke(),e.restore()},O=({ctx:e,row:t,col:r,deg:s,broken:i=!1})=>{e.save(),e.translate((r-1)*w+w/2,(t-1)*_+_/2),e.rotate(h(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),R(e,i?[[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,50,20]]),e.stroke(),e.restore()},E=({ctx:e,row:t,col:r,broken:s=!1})=>{e.save(),e.translate((r-1)*w+w/2,(t-1)*_+_/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),R(e,s?[[0,-20,50],[1,-20,45],[1,-10,40],[1,0,45],[1,10,35],[1,20,40],[1,20,50],[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,-20,20],[1,-20,50],[0,50,20],[1,20,20],[1,20,50]]),e.stroke(),e.restore()},L=({ctx:e,row:t,col:r,broken:s})=>{e.save(),e.translate((r-1)*w+w/2,(t-1)*_+_/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),R(e,[[0,30,-48],[1,48,-30],[1,48,30],[1,30,48],[1,-30,48],[1,-48,30],[1,-48,-30],[1,-30,-48],[1,30,-48]]),e.stroke(),s&&(e.lineWidth=2,R(e,[[0,10,-48],[1,0,-40],[0,24,-48],[1,20,-30],[0,48,-27],[1,20,-20],[0,-10,-30],[1,10,-30],[1,30,-10],[1,20,0],[1,10,0],[0,48,7],[1,30,10],[0,20,0],[1,30,10],[1,10,20],[0,30,48],[1,30,30],[1,10,30],[0,20,20],[1,20,30],[0,-10,48],[1,-10,20],[1,0,10],[0,-20,0],[1,-20,20],[1,-10,30],[0,-30,48],[1,-20,40],[1,-20,30],[0,-30,30],[1,-20,40],[0,-48,20],[1,-30,20],[0,-40,20],[1,-40,10],[0,-48,0],[1,-30,0],[1,-20,-10],[0,-40,0],[1,-30,10],[0,-48,-17],[1,-40,-30],[1,-30,-20],[0,-30,-48],[1,-10,-20],[1,-10,-10],[0,-20,-30],[1,-20,-20],[1,-30,-10]]),e.stroke()),e.restore()},I=({ctx:e,row:t,col:r,deg:s,broken:i=!1})=>{e.save(),e.translate((r-1)*w+w/2,(t-1)*_+_/2),e.rotate(h(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),R(e,i?[[0,-20,50],[1,-20,40],[1,-10,45],[1,0,35],[1,10,45],[1,20,40],[1,20,50]]:[[0,-20,50],[1,-20,0],[1,20,0],[1,20,50]]),e.stroke(),e.restore()},A=(e={})=>{if(!e.width||!e.height)throw Error("You must provide width and height properties");const t=e.width,r=e.height,s=e.tileWidth||32,i=e.tileHeight||32,o=t*s,a=r*i,n=e.context||kontra.context,h=n.canvas.width,l=n.canvas.height,c=document.createElement("canvas"),p=c.getContext("2d"),d=Math.max(0,o-h),u=Math.max(0,a-l);let f,m;const y=[],b={width:t,height:r,tileWidth:s,tileHeight:i,mapWidth:o,mapHeight:a,context:n,x:e.x||0,y:e.y||0,tilesets:[],layers:{},addTilesets:function(e){[].concat(e).forEach(e=>{const t=e.image;let r,o,a,n;if(`${t}`===t){let e=1/0;for(;e>=0;){const s=(e=t.lastIndexOf("/",e))<0?t:t.substr(e);if(kontra.assets.images[s]){r=kontra.assets.images[s];break}e--}}else r=t;o=e.firstGrid;const h=(r.width/s|0||1)*(r.height/i|0||1);o||(b.tilesets.length>0?(n=((a=b.tilesets[b.tilesets.length-1]).image.width/s|0)*(a.image.height/i|0),o=a.firstGrid+n):o=1),b.tilesets.push({firstGrid:o,lastGrid:o+h-1,image:r}),b.tilesets.sort((e,t)=>e.firstGrid-t.firstGrid)})},addLayers:function(e){[].concat(e).forEach(e=>{let r,s,i,o;if(e.render=void 0===e.render||e.render,Array.isArray(e.data[0])){r=[];for(let o=0;s=e.data[o];o++)for(i=0;i<t;i++)r.push(s[i]||0)}else r=e.data;b.layers[e.name]={data:r,zIndex:e.zIndex||0,render:e.render};for(const t in e.properties)if(e.properties.hasOwnProperty(t)){o=e.properties[t];try{o=JSON.parse(o)}catch(e){}b.layers[e.name][t]=o}b.layers[e.name].render&&(y.push(e.name),y.sort((e,t)=>b.layers[e].zIndex-b.layers[t].zIndex))}),function(){for(let e,t=0;e=b.layers[y[t]];t++)for(let t=0,r=e.data.length;t<r;t++)_(e,t)}()},changeTile(e,{row:r,col:s},i){const o=((e,t,r)=>(e-1)*r+t-1)(r,s,t),a=b.layers[e];a.data[o]=i,_(a,o,!0)},layerCollidesWith:function(e,t){const r=b.getRow(t.y),s=b.getCol(t.x),i=b.getRow(t.y+t.height),o=b.getCol(t.x+t.width);let a;for(let t=r;t<=i;t++)for(let r=s;r<=o;r++)if(a=g({row:t,col:r}),b.layers[e].data[a])return!0;return!1},tileAtLayer(e,t){const r=g(t);if(r>=0)return b.layers[e].data[r]},render(){b.context.drawImage(c,b.sx,b.sy,h,l,b.x,b.y,h,l)},renderLayer:function(e){const o=b.layers[e];let a=b.getRow();const n=b.getCol();let c=g({row:a,col:n});const p=n*s-b.sx,d=a*i-b.sy,u=Math.min(Math.ceil(h/s)+1,t),f=u*Math.min(Math.ceil(l/i)+1,r);let m,y,_,v,x,k,M,T,S,C=0;for(;C<f;)(_=o.data[c])&&(x=(v=w(_)).image,m=p+C%u*s,y=d+(C/u|0)*i,T=(k=_-v.firstGrid)%(M=x.width/s)*s,S=(k/M|0)*i,b.context.drawImage(x,T,S,s,i,m,y,s,i)),++C%u==0?c=n+ ++a*t:c++},getRow:e=>(e=e||0,(b.sy+e)/i|0),getCol:e=>(e=e||0,(b.sx+e)/s|0),get sx(){return f},get sy(){return m},set sx(e){f=Math.min(Math.max(0,e),d)},set sy(e){m=Math.min(Math.max(0,e),u)},_layerOrder:y};b.sx=e.sx||0,b.sy=e.sy||0,c.width=o,c.height=a;for(const t in e.properties)if(e.properties.hasOwnProperty(t)){let r=e.properties[t];try{r=JSON.parse(r)}catch(e){}b[t]=b[t]||r}function g(e){let s,i;return void 0!==e.x&&void 0!==e.y?(s=b.getRow(e.y),i=b.getCol(e.x)):(s=e.row,i=e.col),s<0||i<0||s>=r||i>=t?-1:i+s*t}function w(e){let t,r,s=0,i=b.tilesets.length-1;for(;s<=i;){if(t=(s+i)/2|0,e>=(r=b.tilesets[t]).firstGrid&&e<=r.lastGrid)return r;r.lastGrid<e?s=t+1:i=t-1}}function _(e,r,o=!1){const a=e.data[r];if(!a)return;const n=w(a),h=n.image,l=r%t*s,c=(r/t|0)*i,d=a-n.firstGrid,u=h.width/s,f=d%u*s,m=(d/u|0)*i;o&&p.clearRect(l,c,s,i),p.drawImage(h,f,m,s,i,l,c,s,i)}return e.tilesets&&b.addTilesets(e.tilesets),e.layers&&b.addLayers(e.layers),b},D=async()=>{const{sx:e,sy:t}=(({col:e,row:t})=>({sx:(e-1)*w+w/2,sy:(t-1)*_+_/2}))({col:5,row:6}),r=A({tileWidth:w,tileHeight:_,width:28,height:26,sx:e,sy:t}),s=((e,t,r,s,i)=>{const o=[];let a=0;for(let n=0;n<r+2*i;n++)for(let h=0;h<t+2*s;h++)n<i||n>=i+r||h<s||h>=s+t?o.push(0):o.push(e[a++]);return o})(S,20,20,4,3),i=await(()=>{const e=document.createElement("canvas");e.width=8*w,e.height=8*_;const t=e.getContext("2d");P({ctx:t,row:1,col:1,deg:0}),P({ctx:t,row:1,col:2,deg:90}),P({ctx:t,row:2,col:1,deg:270}),P({ctx:t,row:2,col:2,deg:180}),q({ctx:t,row:1,col:3,deg:0}),q({ctx:t,row:2,col:3,deg:90}),O({ctx:t,row:1,col:4,deg:0}),O({ctx:t,row:1,col:5,deg:90}),O({ctx:t,row:1,col:6,deg:180}),O({ctx:t,row:2,col:5,deg:270}),E({ctx:t,row:2,col:4}),I({ctx:t,row:3,col:1,deg:0}),I({ctx:t,row:3,col:2,deg:90}),I({ctx:t,row:3,col:3,deg:180}),I({ctx:t,row:3,col:4,deg:270}),L({ctx:t,row:2,col:6}),P({ctx:t,row:4,col:1,deg:0,broken:!0}),P({ctx:t,row:4,col:2,deg:90,broken:!0}),P({ctx:t,row:5,col:1,deg:270,broken:!0}),P({ctx:t,row:5,col:2,deg:180,broken:!0}),q({ctx:t,row:4,col:3,deg:0,broken:!0}),q({ctx:t,row:5,col:3,deg:90,broken:!0}),O({ctx:t,row:4,col:4,deg:0,broken:!0}),O({ctx:t,row:4,col:5,deg:90,broken:!0}),O({ctx:t,row:4,col:6,deg:180,broken:!0}),O({ctx:t,row:5,col:5,deg:270,broken:!0}),E({ctx:t,row:5,col:4,broken:!0}),I({ctx:t,row:6,col:1,deg:0,broken:!0}),I({ctx:t,row:6,col:2,deg:90,broken:!0}),I({ctx:t,row:6,col:3,deg:180,broken:!0}),I({ctx:t,row:6,col:4,deg:270,broken:!0}),L({ctx:t,row:5,col:6,broken:!0});const r=new Image;return r.src=e.toDataURL("image/png"),new Promise(e=>setTimeout(()=>e(r),100))})();return r.addTilesets({image:i}),r.addLayers([{name:"main",data:s},{name:"debug",data:new Array(s.length).fill(0)}]),r};var W=new class{constructor(){this.timeoutHandler=null,this.div=document.createElement("div"),this.div.style.cssText="\nbackground-color: rgba(0,0,0,0);\nfont-size: 3em;\nfont-weight: bold;\nalign-items: center;\njustify-content: center;\ndisplay: flex;\ncolor: rgba(255,255,255,0);\nposition: absolute;\ntop: 0;\nleft:0;\nwidth: 100vw;\nheight: 100vh;\ntext-align: center;\npointer-events: none;\ntransition: background-color 3s ease-out, color 3s ease-out;\ntext-transform: uppercase;\nfont-family: monospace;\n    ",document.getElementById("wrapper").appendChild(this.div)}show(e){clearTimeout(this.timeoutHandler),this.div.style.transition="3s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.backgroundColor="rgba(0,0,0,0.5)",this.div.style.color="rgba(255,255,255,1)"}flash(e){clearTimeout(this.timeoutHandler),this.div.style.transition="0.5s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.color="rgba(255,255,255,1)",this.timeoutHandler=setTimeout(()=>this.div.style.color="rgba(255,255,255,0)",500)}},Y=e=>{const t=kontra.sprite({x:b/2,y:g/2,collisionRadius:30,map:e,infected:!1,gameOver:!1,direction:"N",nextDirection:null,dropBomb:!1,scale:1,dropping:!1,bombCoolingDown:!1,update(){({nextDirection:this.nextDirection,direction:this.direction,dropBomb:this.dropBomb,scale:this.scale,bombCoolingDown:this.bombCoolingDown}=z(this,v,W))},render(){X(this)},infect(e){p(e,this)&&(this.infected=!0,this.gameOver||(W.show("player infected<br>game over"),v.publish(0)))}});return v.subscribe(0,()=>t.gameOver=!0),v.subscribe(2,()=>t.dropping=!0),t},X=e=>{const{context:t,x:r,y:n,direction:l,infected:c,scale:p}=e;t.save(),t.translate(r,n),t.scale(p,p),t.rotate((e=>{switch(e){case s:return h(0);case i:return h(90);case o:return h(180);case a:return h(270);default:return null}})(l)),t.lineWidth=3,t.strokeStyle=c?"#cd3926":"#75a042",t.fillStyle=c?"#7a2431":"#365b1d",t.beginPath(),t.moveTo(-15,25),t.lineTo(0,-25),t.lineTo(15,25),t.closePath(),t.fill(),t.stroke(),t.restore()},z=e=>{let{nextDirection:t,direction:r,dropBomb:h,scale:l,bombCoolingDown:c}=e;const{dropping:p}=e;if(p)return l>0?l-=.01:(W.show("You fell into the abyss<br>Game over"),v.publish(0)),{direction:r,nextDirection:t,dropBomb:h,scale:l,bombCoolingDown:c};const{map:u,x:f,y:m,gameOver:y}=e;if(y||(({nextDirection:t,dropBomb:h}=(e=>{let{nextDirection:t,dropBomb:r}=e;return kontra.keys.pressed("right")&&(t=i),kontra.keys.pressed("left")&&(t=a),kontra.keys.pressed("up")&&(t=s),kontra.keys.pressed("down")&&(t=o),kontra.keys.pressed("space")&&(r=!0),{nextDirection:t,dropBomb:r}})(e)),c&&(h=!1)),!(({x:e,y:t})=>(e-w/2)%w==0&&(t-_/2)%_==0)({x:u.sx,y:u.sy}))return{direction:r,nextDirection:t,dropBomb:h,scale:l,bombCoolingDown:c};if(t&&n(u,{x:f,y:m},t))r=t,t=null;else try{r=d(u,{x:f,y:m},r)}catch({message:e}){"dropped"===e&&v.publish(2)}return h&&(v.publish(x,(({sx:e,sy:t,tileWidth:r,tileHeight:s})=>({col:Math.floor(e/r)+1,row:Math.floor(t/s)+1}))(u)),h=!1,c=!0,setTimeout(()=>{e.bombCoolingDown=!1},100)),{direction:r,nextDirection:t,dropBomb:h,scale:l,bombCoolingDown:c}};var B=({map:e,row:t,col:r})=>{const{x:s,y:i}=c(e,{row:t,col:r});return kontra.sprite({x:s,y:i,collisionRadius:30,infected:!1,map:e,mapX:(r-1)*w,mapY:(t-1)*_,status:0,update(){({x:this.x,y:this.y}=c(this.map,{x:this.mapX,y:this.mapY}))},render(){G(this)},infect(){this.status=2,v.publish(M)}})};const H={0:{fg:"#52638a",bg:"#2b3653"},1:{fg:"#75a042",bg:"#365b1d"},2:{fg:"#cd3926",bg:"#7a2431"}};var G=e=>{const{context:t,x:r,y:s,status:i}=e,{fg:o,bg:a}=H[i];t.save(),t.translate(r,s),t.lineWidth=3,t.strokeStyle=o,t.fillStyle=a,t.beginPath(),t.moveTo(-40,40),t.lineTo(-40,20),t.arc(-20,20,20,h(180),h(270)),t.moveTo(-20,0),t.lineTo(20,0),t.arc(20,20,20,h(270),h(0)),t.lineTo(40,40),t.lineTo(-40,40),t.moveTo(-23,20),t.lineTo(-23,40),t.moveTo(23,20),t.lineTo(23,40),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-15,25,h(0),h(360)),t.fill(),t.stroke(),t.restore()},j=e=>{const{x:t,y:r}=c(e,{row:4,col:5}),s=new K,i=kontra.sprite({x:t,y:r,collisionRadius:30,map:e,mapX:4*w,mapY:3*_,direction:"W",blips:s,update(){({x:this.x,y:this.y,mapX:this.mapX,mapY:this.mapY,direction:this.direction}=N(this)),this.blips.update()},render(){U(this),this.blips.render()}});return s.start(i),i};const F=Array(20).fill().map(()=>Array(20).fill(0));var N=e=>{let{direction:t,x:r,y:h}=e;const{map:p}=e,{mapX:m,mapY:y}=(({mapX:e,mapY:t,direction:r})=>{switch(r){case s:return{mapX:e,mapY:t-2.5};case i:return{mapX:e+2.5,mapY:t};case o:return{mapX:e,mapY:t+2.5};case a:return{mapX:e-2.5,mapY:t};default:return{mapX:e,mapY:t}}})(e);if((({mapX:e,mapY:t})=>e%w==0&&t%_==0)({mapX:m,mapY:y})){const e=p.tileAtLayer("main",{x:r,y:h}),c=m/w+1,b=y/_+1;if(F[b-1][c-1]=F[b-1][c-1]+1,(e=>f.includes(e))(e)){const{allowed:d}=u[e],f=(({viable:e,visits:t,row:r,col:n})=>{let h=Number.MAX_SAFE_INTEGER;return e.map(e=>{let l;switch(e){case s:l=t[r-2][n-1];break;case i:l=t[r-1][n];break;case o:l=t[r][n-1];break;case a:l=t[r-1][n-2]}return h=l<h?l:h,{dir:e,vis:l}}).filter(({vis:e})=>e===h).map(({dir:e})=>e)})({viable:d.filter(e=>e!==(e=>{switch(e){case s:return o;case i:return a;case o:return s;case a:return a;default:return null}})(t)&&n(p,{x:r,y:h},e)),visits:F,row:b,col:c});t=f[l(0,f.length-1)]}else t=d(p,{x:r,y:h},t)}return({x:r,y:h}=c(p,{x:m,y:y})),{direction:t,mapY:y,mapX:m,x:r,y:h}},U=e=>{const{context:t,x:r,y:s}=e;t.save(),t.translate(r,s),t.lineWidth=3,t.strokeStyle="#cd3926",t.fillStyle="#7a2431",t.beginPath(),t.moveTo(l(-5,5),l(-5,-25)),t.lineTo(l(5,50),l(-5,-50)),t.lineTo(l(5,25),l(-5,5)),t.lineTo(l(5,50),l(5,50)),t.lineTo(l(-5,5),l(5,25)),t.lineTo(l(-5,-50),l(5,50)),t.lineTo(l(-5,-25),l(-5,5)),t.lineTo(l(-5,-50),l(-5,-50)),t.closePath(),t.fill(),t.stroke(),t.restore()},J=({x:e,y:t})=>kontra.sprite({x:e,y:t,ttl:180,radius:_,update(){this.radius+=10,this.ttl--},render(){$(this)}}),$=e=>{const{context:t,x:r,y:s,radius:i}=e;t.save(),t.translate(r,s),t.lineWidth=1,t.strokeStyle="#cd3926",t.beginPath(),t.arc(0,0,i,h(0),h(360)),t.closePath(),t.stroke(),t.restore()},K=class{constructor(){this.blips=[]}start(e){setInterval(()=>{this.blips.push(J({x:e.x,y:e.y}))},1e3)}update(){this.blips.forEach(e=>e.update()),this.blips=this.blips.filter(e=>e.ttl>0)}render(){this.blips.forEach(e=>e.render())}},Q=(e,{row:t,col:r})=>{const{x:s,y:i}=c(e,{row:t,col:r});return kontra.sprite({x:s,y:i,collisionRadius:30,fuseLength:100,status:V,shrapnel:[],explosionDuration:0,map:e,mapX:(r-1)*w,mapY:(t-1)*_,row:t,col:r,update(){({status:this.status,fuseLength:this.fuseLength,explosionDuration:this.explosionDuration,x:this.x,y:this.y}=te(this))},render(){Z(this)}})};const V=0;var Z=e=>{const{status:t,shrapnel:r}=e;switch(t){case V:ee(e);break;case 1:r.forEach(e=>e.render())}},ee=e=>{const{context:t,x:r,y:s,fuseLength:i}=e;t.save(),t.translate(r,s),t.rotate(h(-45)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(23,-10),t.lineTo(40,-10),t.lineTo(40,10),t.lineTo(23,10),t.arc(0,0,25,h(19),h(341)),t.fill(),t.stroke();const o=i/100*90;t.beginPath(),t.moveTo(40,0),t.arc(40,25,25,h(270),h(270+o)),t.stroke();const a=25*Math.cos(h(o-90))+40,n=25*Math.sin(h(o-90))+25;t.fillStyle="#cd3926";for(let e=0;e<10;e++){const e=Math.cos(h(l(0,360)))*l(0,15)+a,r=Math.sin(h(l(0,360)))*l(0,15)+n;t.fillRect(e-1,r-1,3,3)}t.restore()},te=e=>{let{status:t,fuseLength:r,explosionDuration:s,x:i,y:o}=e;const{shrapnel:a,map:n,mapX:h,mapY:l,row:p,col:d}=e;switch(({x:i,y:o}=c(n,{x:h,y:l})),t){case V:if((r-=1)<0){t=1,v.publish(k);for(let e=0;e<50;e++)a.push(re({x:i,y:o}));const e=n.tileAtLayer("main",{row:p+3-1,col:d+4-1});n.changeTile("main",{row:p+3,col:d+4},e+24)}break;case 1:a.forEach(e=>e.update()),200===++s&&(t=2)}return{status:t,fuseLength:r,explosionDuration:s,x:i,y:o}},re=({x:e,y:t})=>{const r=l(0,360),s=l(5,15);return kontra.sprite({x:e,y:t,dx:Math.cos(h(r))*s,dy:Math.sin(h(r))*s,rotation:l(0,360),rotationDir:[l(-10,-1),l(1,10)][l(0,1)],update(){this.advance(),this.rotation+=this.rotationDir},render(){(e=>{const{context:t,x:r,y:s,rotation:i}=e;t.save(),t.translate(r,s),t.rotate(h(i)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(0,-10),t.lineTo(10,5),t.lineTo(-10,5),t.closePath(),t.fill(),t.stroke(),t.restore()})(this)}})},se={chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encLookup:[],Init:function(){for(var e=0;e<4096;e++)this.encLookup[e]=this.chars[e>>6]+this.chars[63&e]},Encode:function(e){var t=e.length,r="",s=0;let i;for(;t>2;)i=e[s]<<16|e[s+1]<<8|e[s+2],r+=this.encLookup[i>>12]+this.encLookup[4095&i],t-=3,s+=3;if(t>0){var o=(252&e[s])>>2,a=(3&e[s])<<4;if(t>1&&(a|=(240&e[++s])>>4),r+=this.chars[o],r+=this.chars[a],2==t){var n=(15&e[s++])<<2;n|=(192&e[s])>>6,r+=this.chars[n]}1==t&&(r+="="),r+="="}return r}};se.Init();var ie=function(e){function t(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]}function r(e){return[255&e,e>>8&255]}this.data=[],this.wav=[],this.dataURI="",this.header={chunkId:[82,73,70,70],chunkSize:0,format:[87,65,86,69],subChunk1Id:[102,109,116,32],subChunk1Size:16,audioFormat:1,numChannels:1,sampleRate:8e3,byteRate:0,blockAlign:0,bitsPerSample:8,subChunk2Id:[100,97,116,97],subChunk2Size:0},this.Make=function(e){e instanceof Array&&(this.data=e),this.header.byteRate=this.header.sampleRate*this.header.numChannels*this.header.bitsPerSample>>3,this.header.blockAlign=this.header.numChannels*this.header.bitsPerSample>>3,this.header.subChunk2Size=this.data.length,this.header.chunkSize=36+this.header.subChunk2Size,this.wav=this.header.chunkId.concat(t(this.header.chunkSize),this.header.format,this.header.subChunk1Id,t(this.header.subChunk1Size),r(this.header.audioFormat),r(this.header.numChannels),t(this.header.sampleRate),t(this.header.byteRate),r(this.header.blockAlign),r(this.header.bitsPerSample),this.header.subChunk2Id,t(this.header.subChunk2Size),this.data),this.dataURI="data:audio/wav;base64,"+se.Encode(this.wav)},e instanceof Array&&this.Make(e)},oe=0;function ae(e){return e*e}Math.pow;function ne(){this.oldParams=!0,this.wave_type=oe,this.p_env_attack=0,this.p_env_sustain=.3,this.p_env_punch=0,this.p_env_decay=.4,this.p_base_freq=.3,this.p_freq_limit=0,this.p_freq_ramp=0,this.p_freq_dramp=0,this.p_vib_strength=0,this.p_vib_speed=0,this.p_arp_mod=0,this.p_arp_speed=0,this.p_duty=0,this.p_duty_ramp=0,this.p_repeat_speed=0,this.p_pha_offset=0,this.p_pha_ramp=0,this.p_lpf_freq=1,this.p_lpf_ramp=0,this.p_lpf_resonance=0,this.p_hpf_freq=0,this.p_hpf_ramp=0,this.sound_vol=.25,this.sample_rate=44100,this.sample_size=8}function he(e){return Math.random()*e}function le(e){return Math.floor(Math.random()*(e+1))}function ce(e){this.initFromUI(e)}ne.prototype.explosion=function(){return this.wave_type=3,le(1)?(this.p_base_freq=ae(.1+he(.4)),this.p_freq_ramp=-.1+he(.4)):(this.p_base_freq=ae(.2+he(.7)),this.p_freq_ramp=-.2-he(.2)),0===le(4)&&(this.p_freq_ramp=0),0===le(2)&&(this.p_repeat_speed=.3+he(.5)),this.p_env_attack=0,this.p_env_sustain=.1+he(.3),this.p_env_decay=he(.5),le(1)&&(this.p_pha_offset=-.3+he(.9),this.p_pha_ramp=-he(.3)),this.p_env_punch=.2+he(.6),le(1)&&(this.p_vib_strength=he(.7),this.p_vib_speed=he(.6)),0===le(2)&&(this.p_arp_speed=.6+he(.3),this.p_arp_mod=.8-he(1.6)),this},ne.prototype.hitHurt=function(){return this.wave_type=le(2),2===this.wave_type&&(this.wave_type=3),this.wave_type===oe&&(this.p_duty=he(.6)),1===this.wave_type&&(this.p_duty=1),this.p_base_freq=.2+he(.6),this.p_freq_ramp=-.3-he(.4),this.p_env_attack=0,this.p_env_sustain=he(.1),this.p_env_decay=.1+he(.2),le(1)&&(this.p_hpf_freq=he(.3)),this},ne.prototype.jump=function(){return this.wave_type=oe,this.p_duty=he(.6),this.p_base_freq=.3+he(.3),this.p_freq_ramp=.1+he(.2),this.p_env_attack=0,this.p_env_sustain=.1+he(.3),this.p_env_decay=.1+he(.2),le(1)&&(this.p_hpf_freq=he(.3)),le(1)&&(this.p_lpf_freq=1-he(.6)),this},ce.prototype.initFromUI=function(e){this.initForRepeat=function(){this.elapsedSinceRepeat=0,this.period=100/(e.p_base_freq*e.p_base_freq+.001),this.periodMax=100/(e.p_freq_limit*e.p_freq_limit+.001),this.enableFrequencyCutoff=e.p_freq_limit>0,this.periodMult=1-.01*Math.pow(e.p_freq_ramp,3),this.periodMultSlide=1e-6*-Math.pow(e.p_freq_dramp,3),this.dutyCycle=.5-.5*e.p_duty,this.dutyCycleSlide=5e-5*-e.p_duty_ramp,e.p_arp_mod>=0?this.arpeggioMultiplier=1-.9*Math.pow(e.p_arp_mod,2):this.arpeggioMultiplier=1+10*Math.pow(e.p_arp_mod,2),this.arpeggioTime=Math.floor(2e4*Math.pow(1-e.p_arp_speed,2)+32),1===e.p_arp_speed&&(this.arpeggioTime=0)},this.initForRepeat(),this.waveShape=parseInt(e.wave_type),this.fltw=.1*Math.pow(e.p_lpf_freq,3),this.enableLowPassFilter=1!=e.p_lpf_freq,this.fltw_d=1+1e-4*e.p_lpf_ramp,this.fltdmp=5/(1+20*Math.pow(e.p_lpf_resonance,2))*(.01+this.fltw),this.fltdmp>.8&&(this.fltdmp=.8),this.flthp=.1*Math.pow(e.p_hpf_freq,2),this.flthp_d=1+3e-4*e.p_hpf_ramp,this.vibratoSpeed=.01*Math.pow(e.p_vib_speed,2),this.vibratoAmplitude=.5*e.p_vib_strength,this.envelopeLength=[Math.floor(e.p_env_attack*e.p_env_attack*1e5),Math.floor(e.p_env_sustain*e.p_env_sustain*1e5),Math.floor(e.p_env_decay*e.p_env_decay*1e5)],this.envelopePunch=e.p_env_punch,this.flangerOffset=1020*Math.pow(e.p_pha_offset,2),e.p_pha_offset<0&&(this.flangerOffset=-this.flangerOffset),this.flangerOffsetSlide=1*Math.pow(e.p_pha_ramp,2),e.p_pha_ramp<0&&(this.flangerOffsetSlide=-this.flangerOffsetSlide),this.repeatTime=Math.floor(2e4*Math.pow(1-e.p_repeat_speed,2)+32),0===e.p_repeat_speed&&(this.repeatTime=0),this.gain=Math.exp(e.sound_vol)-1,this.sampleRate=e.sample_rate,this.bitsPerChannel=e.sample_size},ce.prototype.generate=function(){for(var e=0,t=0,r=0,s=Array(32),i=0;i<32;++i)s[i]=2*Math.random()-1;var o=0,a=0,n=0,h=0,l=0,c=Array(1024);for(i=0;i<1024;++i)c[i]=0;for(var p=0,d=[],u=0,f=0,m=Math.floor(44100/this.sampleRate),y=0;0!=this.repeatTime&&++this.elapsedSinceRepeat>=this.repeatTime&&this.initForRepeat(),0!=this.arpeggioTime&&y>=this.arpeggioTime&&(this.arpeggioTime=0,this.period*=this.arpeggioMultiplier),this.periodMult+=this.periodMultSlide,this.period*=this.periodMult,!(this.period>this.periodMax&&(this.period=this.periodMax,this.enableFrequencyCutoff));++y){var b=this.period;this.vibratoAmplitude>0&&(n+=this.vibratoSpeed,b=this.period*(1+Math.sin(n)*this.vibratoAmplitude));var g,w=Math.floor(b);if(w<8&&(w=8),this.dutyCycle+=this.dutyCycleSlide,this.dutyCycle<0&&(this.dutyCycle=0),this.dutyCycle>.5&&(this.dutyCycle=.5),++a>this.envelopeLength[o]&&(a=0,++o>2))break;var _=a/this.envelopeLength[o];g=0===o?_:1===o?1+2*(1-_)*this.envelopePunch:1-_,this.flangerOffset+=this.flangerOffsetSlide;var v=Math.abs(Math.floor(this.flangerOffset));v>1023&&(v=1023),0!=this.flthp_d&&(this.flthp*=this.flthp_d,this.flthp<1e-5&&(this.flthp=1e-5),this.flthp>.1&&(this.flthp=.1));for(var x=0,k=0;k<8;++k){var M=0;if(++h>=w&&(h%=w,3===this.waveShape))for(i=0;i<32;++i)s[i]=2*Math.random()-1;var T=h/w;if(this.waveShape===oe)M=T<this.dutyCycle?.5:-.5;else if(1===this.waveShape)M=T<this.dutyCycle?2*T/this.dutyCycle-1:1-2*(T-this.dutyCycle)/(1-this.dutyCycle);else if(2===this.waveShape)M=Math.sin(2*T*Math.PI);else{if(3!==this.waveShape)throw"ERROR: Bad wave type: "+this.waveShape;M=s[Math.floor(32*h/w)]}var S=e;this.fltw*=this.fltw_d,this.fltw<0&&(this.fltw=0),this.fltw>.1&&(this.fltw=.1),this.enableLowPassFilter?(t+=(M-e)*this.fltw,t-=t*this.fltdmp):(e=M,t=0),r+=(e+=t)-S,M=r-=r*this.flthp,c[1023&l]=M,M+=c[l-v+1024&1023],l=l+1&1023,x+=M*g}u+=x,++f>=m&&(f=0,x=u/m,u=0,x=x/8*1,x*=this.gain,8===this.bitsPerChannel?((x=Math.floor(128*(x+1)))>255?(x=255,++p):x<0&&(x=0,++p),d.push(x)):((x=Math.floor(32768*x))>=32768?(x=32767,++p):x<-32768&&(x=-32768,++p),d.push(255&x),d.push(x>>8&255)))}var C=new ie;return C.header.sampleRate=this.sampleRate,C.header.bitsPerSample=this.bitsPerChannel,C.Make(d),C.clipping=p,C};var pe={Params:ne,SoundEffect:ce};const{SoundEffect:de,Params:ue}=pe,fe={};function me(e){const t=new ue;t[e]();const r=new de(t).generate();fe[e]=function(e){const t=new Audio;return t.src=e.dataURI,t}(r)}window.AudioContext=window.AudioContext||window.webkitAudioContext,me("jump"),me("explosion"),me("hitHurt"),play(),(async()=>{(()=>{const e=document.createElement("canvas");e.width=b,e.height=g,e.style.cssText="\n        border: 4px solid #52638a;\n    ",document.getElementById("wrapper").appendChild(e)})(),kontra.init();const e=await D(),t=Y(e),r=j(e),s=new class{constructor(e){this.map=e,this.bombs=[],v.subscribe(x,e=>this.dropBomb(e))}dropBomb(e){this.bombs.length>0&&this.bombs.find(({col:t,row:r})=>t===e.col&&r===e.row)||this.bombs.push(Q(this.map,e))}update(){this.bombs=this.bombs.filter(e=>(e.update(),2!==e.status))}render(){this.bombs.forEach(e=>e.render())}}(e),i=new class{constructor(e){this.map=e,this.users=[],this.gameOver=!1;for(let t=1;t<=26;t++)for(let r=1;r<=28;r++){const s=e.tileAtLayer("main",{row:t,col:r});s>=17&&s<=20&&this.users.push(B({map:e,row:t-3+1,col:r-4+1}))}v.subscribe(0,()=>this.gameOver=!0)}update(){this.users.forEach(e=>e.update())}render(){this.users.forEach(e=>e.render())}infect(e){const{users:t,gameOver:r}=this,s=((e,t)=>{const r=[];for(let s=0;s<e.length;s++){const i=e[s];for(let e=0;e<t.length;e++){const s=t[e];p(i,s)&&r.push([i,s])}}return r})(t,e).filter(([e])=>2!==e.status);if(0!==s.length&&(s.forEach(([e])=>e.infect()),!r))return(e=>e.every(e=>2===e.state))(t)?(W.show("all users infected<br>game over"),void v.publish(0)):void W.flash("user infected!")}}(e),o=T({map:e,player:t,virus:r,users:i,bombs:s});v.subscribe(x,()=>fe.jump.play()),v.subscribe(k,()=>fe.explosion.play()),v.subscribe(M,()=>fe.hitHurt.play()),o.start()})()}]);
//# sourceMappingURL=game.js.map
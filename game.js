!function(e){var t={};function r(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(s,n,function(t){return e[t]}.bind(null,n));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);const s="N",n="E",a="S",o="W";var i=(e,t)=>l[e].change[t]||t,l={1:{allowed:[a,n],change:{[s]:n,[o]:a}},2:{allowed:[o,a],change:{[s]:o,[n]:a}},3:{allowed:[s,a],change:{}},4:{allowed:[o,s,n],change:{[a]:s}},5:{allowed:[s,n,a],change:{[o]:n}},6:{allowed:[o,n,a],change:{[s]:a}},9:{allowed:[s,n],change:{[a]:n,[o]:s}},10:{allowed:[o,s],change:{[n]:s,[a]:o}},11:{allowed:[o,n],change:{}},12:{allowed:[s,n,a,o],change:{}},13:{allowed:[s,a,o],change:{[n]:o}},14:{allowed:[s,a],change:{}},17:{allowed:[a],change:{[s]:a}},18:{allowed:[o],change:{[n]:o}},19:{allowed:[s],change:{[a]:s}},20:{allowed:[n],change:{[o]:n}}};const c=[];for(const[e,{allowed:t}]of Object.entries(l))t.length>2&&c.push(Number(e));var d=e=>e*Math.PI/180,h=(e,t)=>{const r=Math.min(e,t),s=Math.max(e,t);return Math.floor(Math.random()*(s-r+1))+r},u=(e,{row:t,col:r,x:s,y:n})=>{const{tileWidth:a,tileHeight:o,sx:i,sy:l}=e;return{x:(void 0!==s?s:(r-1)*a)-i+400+a/2,y:(void 0!==n?n:(t-1)*o)-l+300+o/2}},p=(e,t)=>{const r=e.x-t.x,s=e.y-t.y;return Math.sqrt(r*r+s*s)<e.collisionRadius+t.collisionRadius},m=({sx:e,sy:t,tileWidth:r,tileHeight:s})=>({col:Math.floor(e/r)+1,row:Math.floor(t/s)+1}),f=({map:e,player:t,virus:r,users:i,messageBox:l,bombs:c,devbox:d})=>{const h=[];let u;return kontra.gameLoop({update(){r.update(),t.update(),t.infect(r,l),((e,t)=>{switch(t){case s:e.sy-=5;break;case n:e.sx+=5;break;case a:e.sy+=5;break;case o:e.sx-=5}})(e,t.direction),i.update(),i.infect([r],l),c.update()},render(){e.render(),i.render(),c.render(),t.render(),r.render();const s=performance.now();for(;h.length>0&&h[0]<=s-1e3;)h.shift();h.push(s),u=h.length;const{row:n,col:a}=m(e);d.innerHTML=`${u} fps â€“ sx=${e.sx}, sy=${e.sy}, row=${n}, col=${a}`}})},y=[0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,20,4,11,2,1,4,2,0,0,5,11,6,11,13,0,1,11,12,2,0,0,1,11,10,9,11,13,0,0,3,0,3,0,5,11,13,0,3,3,0,0,3,1,11,6,11,10,0,1,4,2,9,11,13,0,9,11,10,3,0,0,3,3,0,3,0,0,0,3,1,13,0,0,3,0,0,0,0,5,18,0,3,3,0,14,0,1,11,10,3,9,11,6,4,11,6,2,0,3,0,0,3,3,0,3,0,3,0,0,3,0,0,3,0,0,3,3,0,3,0,0,9,13,0,5,11,10,0,0,3,1,11,10,0,0,3,3,0,3,0,0,0,3,0,3,0,0,0,1,4,10,0,0,0,0,3,5,11,4,18,0,1,13,0,5,11,2,0,3,0,1,11,11,11,11,12,10,0,0,0,0,3,3,0,3,0,5,11,13,0,9,11,2,0,0,3,0,0,1,18,0,9,10,0,5,11,10,0,9,11,11,11,12,11,6,10,0,0,3,0,0,0,0,0,3,1,11,2,1,11,11,11,10,0,3,0,1,11,4,18,20,6,6,11,10,3,0,3,3,0,0,0,1,2,9,11,12,11,2,0,0,3,3,0,0,3,0,3,3,1,11,2,3,3,0,0,3,0,3,0,0,5,4,2,0,5,11,10,3,3,0,5,12,4,11,11,13,0,5,18,0,3,0,5,11,12,11,6,10,9,6,10,3,0,0,0,9,11,10,0,20,4,11,13,0,3,0,9,11,11,13,0,9,11,6,11,6,6,11,18,0,0,0,3,0,3,0,0,0,0,5,11,11,2,3,0,3,3,0,0,0,0,0,19,0,19,0,0,0,0,19,0,0,19,9,11,10,19,0,0],g=(e={})=>{if(!e.width||!e.height)throw Error("You must provide width and height properties");const t=e.width,r=e.height,s=e.tileWidth||32,n=e.tileHeight||32,a=t*s,o=r*n,i=e.context||kontra.context,l=i.canvas.width,c=i.canvas.height,d=document.createElement("canvas"),h=d.getContext("2d"),u=Math.max(0,a-l),p=Math.max(0,o-c);let m,f;const y=[],g={width:t,height:r,tileWidth:s,tileHeight:n,mapWidth:a,mapHeight:o,context:i,x:e.x||0,y:e.y||0,tilesets:[],layers:{},addTilesets:function(e){[].concat(e).forEach(e=>{const t=e.image;let r,a,o,i;if(`${t}`===t){let e=1/0;for(;e>=0;){const s=(e=t.lastIndexOf("/",e))<0?t:t.substr(e);if(kontra.assets.images[s]){r=kontra.assets.images[s];break}e--}}else r=t;a=e.firstGrid;const l=(r.width/s|0||1)*(r.height/n|0||1);a||(g.tilesets.length>0?(i=((o=g.tilesets[g.tilesets.length-1]).image.width/s|0)*(o.image.height/n|0),a=o.firstGrid+i):a=1),g.tilesets.push({firstGrid:a,lastGrid:a+l-1,image:r}),g.tilesets.sort((e,t)=>e.firstGrid-t.firstGrid)})},addLayers:function(e){[].concat(e).forEach(e=>{let r,s,n,a;if(e.render=void 0===e.render||e.render,Array.isArray(e.data[0])){r=[];for(let a=0;s=e.data[a];a++)for(n=0;n<t;n++)r.push(s[n]||0)}else r=e.data;g.layers[e.name]={data:r,zIndex:e.zIndex||0,render:e.render};for(const t in e.properties)if(e.properties.hasOwnProperty(t)){a=e.properties[t];try{a=JSON.parse(a)}catch(e){}g.layers[e.name][t]=a}g.layers[e.name].render&&(y.push(e.name),y.sort((e,t)=>g.layers[e].zIndex-g.layers[t].zIndex))}),function(){for(let e,t=0;e=g.layers[y[t]];t++)for(let t=0,r=e.data.length;t<r;t++)w(e,t)}()},changeTile(e,{row:r,col:s},n){const a=((e,t,r)=>(e-1)*r+t-1)(r,s,t),o=g.layers[e];o.data[a]=n,w(o,a,!0)},layerCollidesWith:function(e,t){const r=g.getRow(t.y),s=g.getCol(t.x),n=g.getRow(t.y+t.height),a=g.getCol(t.x+t.width);let o;for(let t=r;t<=n;t++)for(let r=s;r<=a;r++)if(o=x({row:t,col:r}),g.layers[e].data[o])return!0;return!1},tileAtLayer(e,t){const r=x(t);if(r>=0)return g.layers[e].data[r]},render(){g.context.drawImage(d,g.sx,g.sy,l,c,g.x,g.y,l,c)},renderLayer:function(e){const a=g.layers[e];let o=g.getRow();const i=g.getCol();let d=x({row:o,col:i});const h=i*s-g.sx,u=o*n-g.sy,p=Math.min(Math.ceil(l/s)+1,t),m=p*Math.min(Math.ceil(c/n)+1,r);let f,y,w,v,k,T,M,O,E,L=0;for(;L<m;)(w=a.data[d])&&(k=(v=b(w)).image,f=h+L%p*s,y=u+(L/p|0)*n,O=(T=w-v.firstGrid)%(M=k.width/s)*s,E=(T/M|0)*n,g.context.drawImage(k,O,E,s,n,f,y,s,n)),++L%p==0?d=i+ ++o*t:d++},getRow:e=>(e=e||0,(g.sy+e)/n|0),getCol:e=>(e=e||0,(g.sx+e)/s|0),get sx(){return m},get sy(){return f},set sx(e){m=Math.min(Math.max(0,e),u)},set sy(e){f=Math.min(Math.max(0,e),p)},_layerOrder:y};g.sx=e.sx||0,g.sy=e.sy||0,d.width=a,d.height=o;for(const t in e.properties)if(e.properties.hasOwnProperty(t)){let r=e.properties[t];try{r=JSON.parse(r)}catch(e){}g[t]=g[t]||r}function x(e){let s,n;return void 0!==e.x&&void 0!==e.y?(s=g.getRow(e.y),n=g.getCol(e.x)):(s=e.row,n=e.col),s<0||n<0||s>=r||n>=t?-1:n+s*t}function b(e){let t,r,s=0,n=g.tilesets.length-1;for(;s<=n;){if(t=(s+n)/2|0,e>=(r=g.tilesets[t]).firstGrid&&e<=r.lastGrid)return r;r.lastGrid<e?s=t+1:n=t-1}}function w(e,r,a=!1){const o=e.data[r];if(!o)return;const i=b(o),l=i.image,c=r%t*s,d=(r/t|0)*n,u=o-i.firstGrid,p=l.width/s,m=u%p*s,f=(u/p|0)*n;a&&h.clearRect(c,d,s,n),h.drawImage(l,m,f,s,n,c,d,s,n)}return e.tilesets&&g.addTilesets(e.tilesets),e.layers&&g.addLayers(e.layers),g};let x=null;var b=(e,t)=>{const r=kontra.sprite({x:400,y:300,collisionRadius:30,map:e,infected:!1,gameOver:!1,direction:"N",nextDirection:null,dropBomb:!1,update(){({nextDirection:this.nextDirection,direction:this.direction,dropBomb:this.dropBomb}=v(this,t))},render(){w(this)},infect(e,r){p(e,this)&&(this.infected=!0,this.gameOver||(r.show("player infected<br>game over"),t.publish(0)))}});return t.subscribe(0,()=>r.gameOver=!0),r},w=e=>{const{context:t,x:r,y:i,direction:l,infected:c}=e;t.save(),t.translate(r,i),t.rotate((e=>{switch(e){case s:return d(0);case n:return d(90);case a:return d(180);case o:return d(270);default:return null}})(l)),t.lineWidth=3,t.strokeStyle=c?"#cd3926":"#75a042",t.fillStyle=c?"#7a2431":"#365b1d",t.beginPath(),t.moveTo(-15,25),t.lineTo(0,-25),t.lineTo(15,25),t.closePath(),t.fill(),t.stroke(),t.restore()},v=(e,t)=>{let{nextDirection:r,direction:c,dropBomb:d}=e;const{map:h,x:u,y:p,gameOver:f}=e;if(f||({nextDirection:r,dropBomb:d}=(e=>{let{nextDirection:t,dropBomb:r}=e;return kontra.keys.pressed("right")&&(t=n),kontra.keys.pressed("left")&&(t=o),kontra.keys.pressed("up")&&(t=s),kontra.keys.pressed("down")&&(t=a),kontra.keys.pressed("space")&&(r=!0),{nextDirection:t,dropBomb:r}})(e)),!(({x:e,y:t})=>(e-50)%100==0&&(t-50)%100==0)({x:h.sx,y:h.sy}))return{direction:c,nextDirection:r,dropBomb:d};const y=h.tileAtLayer("main",{x:u,y:p});return r&&((e,t)=>l[e].allowed.includes(t))(y,r)?(c=r,r=null):c=i(y,c),d&&(t.publish(1,m(h)),d=!1),{direction:c,nextDirection:r,dropBomb:d}};var k=({map:e,row:t,col:r})=>{const{x:s,y:n}=u(e,{row:t,col:r});return kontra.sprite({x:s,y:n,collisionRadius:30,infected:!1,map:e,mapX:100*(r-1),mapY:100*(t-1),status:0,update(){({x:this.x,y:this.y}=u(this.map,{x:this.mapX,y:this.mapY}))},render(){M(this)},infect(){this.status=2}})};const T={0:{sx:600,sy:0},1:{sx:600,sy:0},2:{sx:700,sy:100}};var M=e=>{const{context:t,x:r,y:s,status:n}=e,{sx:a,sy:o}=T[n];t.save(),t.translate(r,s),t.drawImage(kontra.assets.images.tilesheet,a,o,100,100,-50,-50,100,100),t.restore()},O=e=>{const{x:t,y:r}=u(e,{row:4,col:5});return kontra.sprite({x:t,y:r,collisionRadius:30,map:e,mapX:400,mapY:300,direction:"W",update(){({x:this.x,y:this.y,mapX:this.mapX,mapY:this.mapY,direction:this.direction}=L(this))},render(){S(this)}})};const E=Array(20).fill().map(()=>Array(20).fill(0));var L=e=>{let{direction:t,x:r,y:d}=e;const{map:p}=e,{mapX:m,mapY:f}=(({mapX:e,mapY:t,direction:r})=>{switch(r){case s:return{mapX:e,mapY:t-2.5};case n:return{mapX:e+2.5,mapY:t};case a:return{mapX:e,mapY:t+2.5};case o:return{mapX:e-2.5,mapY:t};default:return{mapX:e,mapY:t}}})(e);if((({mapX:e,mapY:t})=>e%100==0&&t%100==0)({mapX:m,mapY:f})){const e=p.tileAtLayer("main",{x:r,y:d}),u=m/100+1,y=f/100+1;if(E[y-1][u-1]=E[y-1][u-1]+1,(e=>c.includes(e))(e)){const{allowed:r}=l[e],i=(({viable:e,visits:t,row:r,col:i})=>{let l=Number.MAX_SAFE_INTEGER;return e.map(e=>{let c;switch(e){case s:c=t[r-2][i-1];break;case n:c=t[r-1][i];break;case a:c=t[r][i-1];break;case o:c=t[r-1][i-2]}return l=c<l?c:l,{dir:e,vis:c}}).filter(({vis:e})=>e===l).map(({dir:e})=>e)})({viable:r.filter(e=>e!==(e=>{switch(e){case s:return a;case n:return o;case a:return s;case o:return o;default:return null}})(t)),visits:E,row:y,col:u});t=i[h(0,i.length-1)]}else t=i(e,t)}return({x:r,y:d}=u(p,{x:m,y:f})),{direction:t,mapY:f,mapX:m,x:r,y:d}},S=e=>{const{context:t,x:r,y:s}=e;t.save(),t.translate(r,s),t.lineWidth=3,t.strokeStyle="#cd3926",t.fillStyle="#7a2431",t.beginPath(),t.moveTo(h(-5,5),h(-5,-25)),t.lineTo(h(5,50),h(-5,-50)),t.lineTo(h(5,25),h(-5,5)),t.lineTo(h(5,50),h(5,50)),t.lineTo(h(-5,5),h(5,25)),t.lineTo(h(-5,-50),h(5,50)),t.lineTo(h(-5,-25),h(-5,5)),t.lineTo(h(-5,-50),h(-5,-50)),t.closePath(),t.fill(),t.stroke(),t.restore()},X=(e,{row:t,col:r})=>{const{x:s,y:n}=u(e,{row:t,col:r});return kontra.sprite({x:s,y:n,collisionRadius:30,fuseLength:100,status:Y,shrapnel:[],explosionDuration:0,map:e,mapX:100*(r-1),mapY:100*(t-1),update(){({status:this.status,fuseLength:this.fuseLength,explosionDuration:this.explosionDuration,x:this.x,y:this.y}=B(this))},render(){D(this)}})};const Y=0;var D=e=>{const{status:t,shrapnel:r}=e;switch(t){case Y:P(e);break;case 1:r.forEach(e=>e.render())}},P=e=>{const{context:t,x:r,y:s,fuseLength:n}=e;t.save(),t.translate(r,s),t.rotate(d(-45)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(23,-10),t.lineTo(40,-10),t.lineTo(40,10),t.lineTo(23,10),t.arc(0,0,25,d(19),d(341)),t.fill(),t.stroke();const a=n/100*90;t.beginPath(),t.moveTo(40,0),t.arc(40,25,25,d(270),d(270+a)),t.stroke();const o=25*Math.cos(d(a-90))+40,i=25*Math.sin(d(a-90))+25;t.fillStyle="#cd3926";for(let e=0;e<10;e++){const e=Math.cos(d(h(0,360)))*h(0,15)+o,r=Math.sin(d(h(0,360)))*h(0,15)+i;t.fillRect(e-1,r-1,3,3)}t.restore()},B=e=>{let{status:t,fuseLength:r,explosionDuration:s,x:n,y:a}=e;const{shrapnel:o,map:i,mapX:l,mapY:c}=e;switch(({x:n,y:a}=u(i,{x:l,y:c})),t){case Y:if((r-=1)<0){t=1;for(let e=0;e<50;e++)o.push(R({x:n,y:a}))}break;case 1:o.forEach(e=>e.update()),200===++s&&(t=2)}return{status:t,fuseLength:r,explosionDuration:s,x:n,y:a}},R=({x:e,y:t})=>{const r=h(0,360),s=h(5,15);return kontra.sprite({x:e,y:t,dx:Math.cos(d(r))*s,dy:Math.sin(d(r))*s,rotation:h(0,360),rotationDir:[h(-10,-1),h(1,10)][h(0,1)],update(){this.advance(),this.rotation+=this.rotationDir},render(){(e=>{const{context:t,x:r,y:s,rotation:n}=e;t.save(),t.translate(r,s),t.rotate(d(n)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(0,-10),t.lineTo(10,5),t.lineTo(-10,5),t.closePath(),t.fill(),t.stroke(),t.restore()})(this)}})};(async()=>{const e=new class{constructor(){this.subscribers=[]}subscribe(e,t){this.subscribers.push({message:e,callback:t})}publish(e,t){this.subscribers.forEach(({message:r,callback:s})=>r===e&&s(t))}};(()=>{const e=document.createElement("canvas");e.width=800,e.height=600,e.style.cssText="\n        border: 4px solid #52638a;\n    ",document.getElementById("wrapper").appendChild(e)})(),kontra.init(),await(async()=>await kontra.assets.load("tilesheet.png"))();const t=(()=>{const{sx:e,sy:t}=(({col:e,row:t})=>({sx:100*(e-1)+50,sy:100*(t-1)+50}))({col:5,row:6}),r=g({tileWidth:100,tileHeight:100,width:28,height:26,sx:e,sy:t}),s=((e,t,r,s,n)=>{const a=[];let o=0;for(let i=0;i<r+2*n;i++)for(let l=0;l<t+2*s;l++)i<n||i>=n+r||l<s||l>=s+t?a.push(0):a.push(e[o++]);return a})(y,20,20,4,3);return r.addTilesets({image:kontra.assets.images.tilesheet}),r.addLayers([{name:"main",data:s}]),r})(),r=b(t,e),s=O(t),n=new class{constructor(e,t){this.map=e,this.pubsub=t,this.bombs=[],this.pubsub.subscribe(1,e=>this.dropBomb(e))}dropBomb(e){this.bombs.push(X(this.map,e))}update(){this.bombs=this.bombs.filter(e=>(e.update(),2!==e.status))}render(){this.bombs.forEach(e=>e.render())}}(t,e),a=new class{constructor(e,t){this.map=e,this.pubsub=t,this.users=[],this.gameOver=!1;for(let t=1;t<=26;t++)for(let r=1;r<=28;r++){const s=e.tileAtLayer("main",{row:t,col:r});s>=17&&s<=20&&this.users.push(k({map:e,row:t-3+1,col:r-4+1}))}this.pubsub.subscribe(0,()=>this.gameOver=!0)}update(){this.users.forEach(e=>e.update())}render(){this.users.forEach(e=>e.render())}infect(e,t){const{users:r,pubsub:s,gameOver:n}=this,a=((e,t)=>{const r=[];for(let s=0;s<e.length;s++){const n=e[s];for(let e=0;e<t.length;e++){const s=t[e];p(n,s)&&r.push([n,s])}}return r})(r,e).filter(([e])=>2!==e.status);if(0!==a.length&&(a.forEach(([e])=>e.infect()),!n))return(e=>e.every(e=>2===e.state))(r)?(t.show("all users infected<br>game over"),void s.publish(0)):void t.flash("user infected!")}}(t,e),o={},i=(()=>{const e=document.createElement("div");return e.style.cssText="\n        background-color: rgba(0,0,0,0);\n        font-size: 3em;\n        font-weight: bold;\n        align-items: center;\n        justify-content: center;\n        display: flex;\n        color: rgba(255,255,255,0);\n        position: absolute;\n        top: 0;\n        left:0;\n        width: 100vw;\n        height: 100vh;\n        text-align: center;\n        pointer-events: none;\n        transition: background-color 3s ease-out, color 3s ease-out;\n        text-transform: uppercase;\n        font-family: monospace;\n    ",document.getElementById("wrapper").appendChild(e),{show(t){clearTimeout(x),e.style.transition="3s",e.innerHTML=`<div>${t}</div>`,e.style.backgroundColor="rgba(0,0,0,0.5)",e.style.color="rgba(255,255,255,1)"},flash(t){clearTimeout(x),e.style.transition="0.5s",e.innerHTML=`<div>${t}</div>`,e.style.color="rgba(255,255,255,1)",x=setTimeout(()=>{e.style.color="rgba(255,255,255,0)"},500)}}})();f({map:t,player:r,virus:s,users:a,devbox:o,messageBox:i,bombs:n}).start()})()}]);
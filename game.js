!function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,o){"use strict";o.r(t);const r="N",n="E",i="S",s="W";var a=(e,{x:t,y:o},r)=>{const n=e.tileAtLayer("main",{x:t,y:o});if(!m[n].allowed.includes(r))return!1;const i=p(e,{x:t,y:o},r);return T(i)},l=e=>e*Math.PI/180,c=(e,t)=>{const o=Math.min(e,t),r=Math.max(e,t);return Math.floor(Math.random()*(r-o+1))+o},d=(e,{row:t,col:o,x:r,y:n})=>{const{tileWidth:i,tileHeight:s,sx:a,sy:l}=e;return{x:(void 0!==r?r:(o-1)*i)-a+y/2+i/2,y:(void 0!==n?n:(t-1)*s)-l+x/2+s/2}},h=(e,t)=>{const o=e.x-t.x,r=e.y-t.y;return Math.sqrt(o*o+r*r)<e.collisionRadius+t.collisionRadius},u=(e,{x:t,y:o},r)=>{const n=e.tileAtLayer("main",{x:t,y:o}),i=m[n].change[r]||r;if(a(e,{x:t,y:o},i))return i;const s=m[n].allowed.filter(r=>a(e,{x:t,y:o},r));switch(s.length){case 0:return null;case 1:return s[0];default:return s[c(0,s.length-1)]}},m={1:{allowed:[i,n],change:{[r]:n,[s]:i}},2:{allowed:[s,i],change:{[r]:s,[n]:i}},3:{allowed:[r,i],change:{}},4:{allowed:[s,r,n],change:{[i]:r}},5:{allowed:[r,n,i],change:{[s]:n}},6:{allowed:[s,n,i],change:{[r]:i}},9:{allowed:[r,n],change:{[i]:n,[s]:r}},10:{allowed:[s,r],change:{[n]:r,[i]:s}},11:{allowed:[s,n],change:{}},12:{allowed:[r,n,i,s],change:{}},13:{allowed:[r,i,s],change:{[n]:s}},14:{allowed:[r,i],change:{}},17:{allowed:[i],change:{[r]:i}},18:{allowed:[s],change:{[n]:s}},19:{allowed:[r],change:{[i]:r}},20:{allowed:[n],change:{[s]:n}}};const g=[];for(const[e,{allowed:t}]of Object.entries(m))t.length>2&&g.push(Number(e));var p=(e,{x:t,y:o},a)=>e.tileAtLayer("main",{x:a===n?t+f:a===s?t-f:t,y:a===r?o-b:a===i?o+b:o}),T=e=>e<25||e>30&&e<33||e>37&&e<41||e>44;const y=800,x=600,f=100,b=100;var w=({map:e,player:t,virus:o,users:a,messageBox:l,bombs:c})=>{return kontra.gameLoop({update(){o.update(),t.update(),t.infect(o,l),((e,t)=>{switch(t){case r:e.sy-=5;break;case n:e.sx+=5;break;case i:e.sy+=5;break;case s:e.sx-=5}})(e,t.direction),a.update(),a.infect([o],l),c.update()},render(){e.render(),a.render(),c.render(),t.render(),o.render()}})},v=[0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,20,4,11,2,1,4,2,0,0,5,11,6,11,13,0,1,11,12,2,0,0,1,11,10,9,11,13,0,0,3,0,3,0,5,11,13,0,3,3,0,0,3,1,11,6,11,10,0,1,4,2,9,11,13,0,9,11,10,3,0,0,3,3,0,3,0,0,0,3,1,13,0,0,3,0,0,0,0,5,18,0,3,3,0,14,0,1,11,10,3,9,11,6,4,11,6,2,0,3,0,0,3,3,0,3,0,3,0,0,3,0,0,3,0,0,3,3,0,3,0,0,9,13,0,5,11,10,0,0,3,1,11,10,0,0,3,3,0,3,0,0,0,3,0,3,0,0,0,1,4,10,0,0,0,0,3,5,11,4,18,0,1,13,0,5,11,2,0,3,0,1,11,11,11,11,12,10,0,0,0,0,3,3,0,3,0,5,11,13,0,9,11,2,0,0,3,0,0,1,18,0,9,10,0,5,11,10,0,9,11,11,11,12,11,6,10,0,0,3,0,0,0,0,0,3,1,11,2,1,11,11,11,10,0,3,0,1,11,4,18,20,6,6,11,10,3,0,3,3,0,0,0,1,2,9,11,12,11,2,0,0,3,3,0,0,3,0,3,3,1,11,2,3,3,0,0,3,0,3,0,0,5,4,2,0,5,11,10,3,3,0,5,12,4,11,11,13,0,5,18,0,3,0,5,11,12,11,6,10,9,6,10,3,0,0,0,9,11,10,0,20,4,11,13,0,3,0,9,11,11,13,0,9,11,6,11,6,6,11,18,0,0,0,3,0,3,0,0,0,0,5,11,11,2,3,0,3,3,0,0,0,0,0,19,0,19,0,0,0,0,19,0,0,19,9,11,10,19,0,0];function k(e,t){return[Math.cos(l(e))*t+50,Math.sin(l(e))*t+50]}var M=({ctx:e,row:t,col:o,deg:r,broken:n=!1})=>{e.save(),e.translate((o-1)*f+f/2,(t-1)*b+b/2),e.rotate(l(r)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),n?(e.moveTo(20,50),e.arc(50,50,30,l(180),l(190)),e.moveTo(...k(190,30)),e.lineTo(10,45),e.lineTo(10,35),e.lineTo(-10,40),e.lineTo(...k(190,70)),e.arc(50,50,70,l(190),l(180),!0),e.moveTo(50,20),e.arc(50,50,30,l(270),l(260),!0),e.moveTo(...k(260,30)),e.lineTo(40,10),e.lineTo(45,0),e.lineTo(35,0),e.lineTo(...k(260,70)),e.arc(50,50,70,l(260),l(270))):(e.moveTo(20,50),e.arc(50,50,30,l(180),l(270)),e.moveTo(-20,50),e.arc(50,50,70,l(180),l(270))),e.stroke(),e.restore()},P=({ctx:e,row:t,col:o,deg:r,broken:n=!1})=>{e.save(),e.translate((o-1)*f+f/2,(t-1)*b+b/2),e.rotate(l(r)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),n?(e.moveTo(-20,50),e.lineTo(-20,30),e.lineTo(-10,40),e.lineTo(0,25),e.lineTo(10,35),e.lineTo(20,30),e.lineTo(20,50),e.stroke(),e.beginPath(),e.moveTo(-20,-50),e.lineTo(-20,-40),e.lineTo(-10,-25),e.lineTo(0,-35),e.lineTo(10,-30),e.lineTo(20,-40),e.lineTo(20,-50)):(e.moveTo(-20,-50),e.lineTo(-20,50),e.moveTo(20,-50),e.lineTo(20,50)),e.stroke(),e.restore()},S=({ctx:e,row:t,col:o,deg:r,broken:n=!1})=>{e.save(),e.translate((o-1)*f+f/2,(t-1)*b+b/2),e.rotate(l(r)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),n?(e.moveTo(50,20),e.lineTo(40,20),e.lineTo(45,10),e.lineTo(40,-10),e.lineTo(45,-20),e.lineTo(50,-20),e.stroke(),e.beginPath(),e.moveTo(20,-50),e.lineTo(20,-35),e.lineTo(10,-40),e.lineTo(0,-30),e.lineTo(-10,-40),e.lineTo(-20,-35),e.lineTo(-20,-50),e.stroke(),e.beginPath(),e.moveTo(-50,-20),e.lineTo(-40,-20),e.lineTo(-35,-10),e.lineTo(-45,0),e.lineTo(-30,10),e.lineTo(-35,20),e.lineTo(-50,20)):(e.moveTo(-20,-50),e.lineTo(-20,-20),e.lineTo(-50,-20),e.moveTo(20,-50),e.lineTo(20,-20),e.lineTo(50,-20),e.moveTo(-50,20),e.lineTo(50,20)),e.stroke(),e.restore()},L=({ctx:e,row:t,col:o,broken:r=!1})=>{e.save(),e.translate((o-1)*f+f/2,(t-1)*b+b/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),r?(e.moveTo(-20,50),e.lineTo(-20,45),e.lineTo(-10,40),e.lineTo(0,45),e.lineTo(10,35),e.lineTo(20,40),e.lineTo(20,50),e.stroke(),e.beginPath(),e.moveTo(50,20),e.lineTo(40,20),e.lineTo(45,10),e.lineTo(40,-10),e.lineTo(45,-20),e.lineTo(50,-20),e.stroke(),e.beginPath(),e.moveTo(20,-50),e.lineTo(20,-35),e.lineTo(10,-40),e.lineTo(0,-30),e.lineTo(-10,-40),e.lineTo(-20,-35),e.lineTo(-20,-50),e.stroke(),e.beginPath(),e.moveTo(-50,-20),e.lineTo(-40,-20),e.lineTo(-35,-10),e.lineTo(-45,0),e.lineTo(-30,10),e.lineTo(-35,20),e.lineTo(-50,20)):(e.moveTo(-20,-50),e.lineTo(-20,-20),e.lineTo(-50,-20),e.moveTo(20,-50),e.lineTo(20,-20),e.lineTo(50,-20),e.moveTo(-50,20),e.lineTo(-20,20),e.lineTo(-20,50),e.moveTo(50,20),e.lineTo(20,20),e.lineTo(20,50)),e.stroke(),e.restore()},O=({ctx:e,row:t,col:o})=>{e.save(),e.translate((o-1)*f+f/2,(t-1)*b+b/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),e.moveTo(30,-48),e.lineTo(48,-30),e.lineTo(48,30),e.lineTo(30,48),e.lineTo(-30,48),e.lineTo(-48,30),e.lineTo(-48,-30),e.lineTo(-30,-48),e.lineTo(30,-48),e.stroke(),e.restore()},E=({ctx:e,row:t,col:o,deg:r,broken:n=!1})=>{e.save(),e.translate((o-1)*f+f/2,(t-1)*b+b/2),e.rotate(l(r)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),n?(e.moveTo(-20,50),e.lineTo(-20,40),e.lineTo(-10,45),e.lineTo(0,35),e.lineTo(10,45),e.lineTo(20,40),e.lineTo(20,50)):(e.moveTo(-20,50),e.lineTo(-20,0),e.lineTo(20,0),e.lineTo(20,50)),e.stroke(),e.restore()},W=(e={})=>{if(!e.width||!e.height)throw Error("You must provide width and height properties");const t=e.width,o=e.height,r=e.tileWidth||32,n=e.tileHeight||32,i=t*r,s=o*n,a=e.context||kontra.context,l=a.canvas.width,c=a.canvas.height,d=document.createElement("canvas"),h=d.getContext("2d"),u=Math.max(0,i-l),m=Math.max(0,s-c);let g,p;const T=[],y={width:t,height:o,tileWidth:r,tileHeight:n,mapWidth:i,mapHeight:s,context:a,x:e.x||0,y:e.y||0,tilesets:[],layers:{},addTilesets:function(e){[].concat(e).forEach(e=>{const t=e.image;let o,i,s,a;if(`${t}`===t){let e=1/0;for(;e>=0;){const r=(e=t.lastIndexOf("/",e))<0?t:t.substr(e);if(kontra.assets.images[r]){o=kontra.assets.images[r];break}e--}}else o=t;i=e.firstGrid;const l=(o.width/r|0||1)*(o.height/n|0||1);i||(y.tilesets.length>0?(a=((s=y.tilesets[y.tilesets.length-1]).image.width/r|0)*(s.image.height/n|0),i=s.firstGrid+a):i=1),y.tilesets.push({firstGrid:i,lastGrid:i+l-1,image:o}),y.tilesets.sort((e,t)=>e.firstGrid-t.firstGrid)})},addLayers:function(e){[].concat(e).forEach(e=>{let o,r,n,i;if(e.render=void 0===e.render||e.render,Array.isArray(e.data[0])){o=[];for(let i=0;r=e.data[i];i++)for(n=0;n<t;n++)o.push(r[n]||0)}else o=e.data;y.layers[e.name]={data:o,zIndex:e.zIndex||0,render:e.render};for(const t in e.properties)if(e.properties.hasOwnProperty(t)){i=e.properties[t];try{i=JSON.parse(i)}catch(e){}y.layers[e.name][t]=i}y.layers[e.name].render&&(T.push(e.name),T.sort((e,t)=>y.layers[e].zIndex-y.layers[t].zIndex))}),function(){for(let e,t=0;e=y.layers[T[t]];t++)for(let t=0,o=e.data.length;t<o;t++)b(e,t)}()},changeTile(e,{row:o,col:r},n){const i=((e,t,o)=>(e-1)*o+t-1)(o,r,t),s=y.layers[e];s.data[i]=n,b(s,i,!0)},layerCollidesWith:function(e,t){const o=y.getRow(t.y),r=y.getCol(t.x),n=y.getRow(t.y+t.height),i=y.getCol(t.x+t.width);let s;for(let t=o;t<=n;t++)for(let o=r;o<=i;o++)if(s=x({row:t,col:o}),y.layers[e].data[s])return!0;return!1},tileAtLayer(e,t){const o=x(t);if(o>=0)return y.layers[e].data[o]},render(){y.context.drawImage(d,y.sx,y.sy,l,c,y.x,y.y,l,c)},renderLayer:function(e){const i=y.layers[e];let s=y.getRow();const a=y.getCol();let d=x({row:s,col:a});const h=a*r-y.sx,u=s*n-y.sy,m=Math.min(Math.ceil(l/r)+1,t),g=m*Math.min(Math.ceil(c/n)+1,o);let p,T,b,w,v,k,M,P,S,L=0;for(;L<g;)(b=i.data[d])&&(v=(w=f(b)).image,p=h+L%m*r,T=u+(L/m|0)*n,P=(k=b-w.firstGrid)%(M=v.width/r)*r,S=(k/M|0)*n,y.context.drawImage(v,P,S,r,n,p,T,r,n)),++L%m==0?d=a+ ++s*t:d++},getRow:e=>(e=e||0,(y.sy+e)/n|0),getCol:e=>(e=e||0,(y.sx+e)/r|0),get sx(){return g},get sy(){return p},set sx(e){g=Math.min(Math.max(0,e),u)},set sy(e){p=Math.min(Math.max(0,e),m)},_layerOrder:T};y.sx=e.sx||0,y.sy=e.sy||0,d.width=i,d.height=s;for(const t in e.properties)if(e.properties.hasOwnProperty(t)){let o=e.properties[t];try{o=JSON.parse(o)}catch(e){}y[t]=y[t]||o}function x(e){let r,n;return void 0!==e.x&&void 0!==e.y?(r=y.getRow(e.y),n=y.getCol(e.x)):(r=e.row,n=e.col),r<0||n<0||r>=o||n>=t?-1:n+r*t}function f(e){let t,o,r=0,n=y.tilesets.length-1;for(;r<=n;){if(t=(r+n)/2|0,e>=(o=y.tilesets[t]).firstGrid&&e<=o.lastGrid)return o;o.lastGrid<e?r=t+1:n=t-1}}function b(e,o,i=!1){const s=e.data[o];if(!s)return;const a=f(s),l=a.image,c=o%t*r,d=(o/t|0)*n,u=s-a.firstGrid,m=l.width/r,g=u%m*r,p=(u/m|0)*n;i&&h.clearRect(c,d,r,n),h.drawImage(l,g,p,r,n,c,d,r,n)}return e.tilesets&&y.addTilesets(e.tilesets),e.layers&&y.addLayers(e.layers),y},X=async()=>{const{sx:e,sy:t}=(({col:e,row:t})=>({sx:(e-1)*f+f/2,sy:(t-1)*b+b/2}))({col:5,row:6}),o=W({tileWidth:f,tileHeight:b,width:28,height:26,sx:e,sy:t}),r=((e,t,o,r,n)=>{const i=[];let s=0;for(let a=0;a<o+2*n;a++)for(let l=0;l<t+2*r;l++)a<n||a>=n+o||l<r||l>=r+t?i.push(0):i.push(e[s++]);return i})(v,20,20,4,3),n=await(()=>{const e=document.createElement("canvas");e.width=8*f,e.height=8*b;const t=e.getContext("2d");M({ctx:t,row:1,col:1,deg:0}),M({ctx:t,row:1,col:2,deg:90}),M({ctx:t,row:2,col:1,deg:270}),M({ctx:t,row:2,col:2,deg:180}),P({ctx:t,row:1,col:3,deg:0}),P({ctx:t,row:2,col:3,deg:90}),S({ctx:t,row:1,col:4,deg:0}),S({ctx:t,row:1,col:5,deg:90}),S({ctx:t,row:1,col:6,deg:180}),S({ctx:t,row:2,col:5,deg:270}),L({ctx:t,row:2,col:4}),E({ctx:t,row:3,col:1,deg:0}),E({ctx:t,row:3,col:2,deg:90}),E({ctx:t,row:3,col:3,deg:180}),E({ctx:t,row:3,col:4,deg:270}),M({ctx:t,row:4,col:1,deg:0,broken:!0}),M({ctx:t,row:4,col:2,deg:90,broken:!0}),M({ctx:t,row:5,col:1,deg:270,broken:!0}),M({ctx:t,row:5,col:2,deg:180,broken:!0}),P({ctx:t,row:4,col:3,deg:0,broken:!0}),P({ctx:t,row:5,col:3,deg:90,broken:!0}),S({ctx:t,row:4,col:4,deg:0,broken:!0}),S({ctx:t,row:4,col:5,deg:90,broken:!0}),S({ctx:t,row:4,col:6,deg:180,broken:!0}),S({ctx:t,row:5,col:5,deg:270,broken:!0}),L({ctx:t,row:5,col:4,broken:!0}),E({ctx:t,row:6,col:1,deg:0,broken:!0}),E({ctx:t,row:6,col:2,deg:90,broken:!0}),E({ctx:t,row:6,col:3,deg:180,broken:!0}),E({ctx:t,row:6,col:4,deg:270,broken:!0}),O({ctx:t,row:2,col:6});const o=new Image;return o.src=e.toDataURL("image/png"),new Promise(e=>setTimeout(()=>e(o),100))})();return o.addTilesets({image:n}),o.addLayers([{name:"main",data:r},{name:"debug",data:new Array(r.length).fill(0)}]),o};let Y=null;var D=(e,t)=>{const o=kontra.sprite({x:y/2,y:x/2,collisionRadius:30,map:e,infected:!1,gameOver:!1,direction:"N",nextDirection:null,dropBomb:!1,update(){({nextDirection:this.nextDirection,direction:this.direction,dropBomb:this.dropBomb}=R(this,t))},render(){B(this)},infect(e,o){h(e,this)&&(this.infected=!0,this.gameOver||(o.show("player infected<br>game over"),t.publish(0)))}});return t.subscribe(0,()=>o.gameOver=!0),o},B=e=>{const{context:t,x:o,y:a,direction:c,infected:d}=e;t.save(),t.translate(o,a),t.rotate((e=>{switch(e){case r:return l(0);case n:return l(90);case i:return l(180);case s:return l(270);default:return null}})(c)),t.lineWidth=3,t.strokeStyle=d?"#cd3926":"#75a042",t.fillStyle=d?"#7a2431":"#365b1d",t.beginPath(),t.moveTo(-15,25),t.lineTo(0,-25),t.lineTo(15,25),t.closePath(),t.fill(),t.stroke(),t.restore()},R=(e,t)=>{let{nextDirection:o,direction:l,dropBomb:c}=e;const{map:d,x:h,y:m,gameOver:g}=e;return g||({nextDirection:o,dropBomb:c}=(e=>{let{nextDirection:t,dropBomb:o}=e;return kontra.keys.pressed("right")&&(t=n),kontra.keys.pressed("left")&&(t=s),kontra.keys.pressed("up")&&(t=r),kontra.keys.pressed("down")&&(t=i),kontra.keys.pressed("space")&&(o=!0),{nextDirection:t,dropBomb:o}})(e)),(({x:e,y:t})=>(e-f/2)%f==0&&(t-b/2)%b==0)({x:d.sx,y:d.sy})?(o&&a(d,{x:h,y:m},o)?(l=o,o=null):l=u(d,{x:h,y:m},l),c&&(t.publish(1,(({sx:e,sy:t,tileWidth:o,tileHeight:r})=>({col:Math.floor(e/o)+1,row:Math.floor(t/r)+1}))(d)),c=!1),{direction:l,nextDirection:o,dropBomb:c}):{direction:l,nextDirection:o,dropBomb:c}};var A=({map:e,row:t,col:o})=>{const{x:r,y:n}=d(e,{row:t,col:o});return kontra.sprite({x:r,y:n,collisionRadius:30,infected:!1,map:e,mapX:(o-1)*f,mapY:(t-1)*b,status:0,update(){({x:this.x,y:this.y}=d(this.map,{x:this.mapX,y:this.mapY}))},render(){G(this)},infect(){this.status=2}})};const I={0:{fg:"#52638a",bg:"#2b3653"},1:{fg:"#75a042",bg:"#365b1d"},2:{fg:"#cd3926",bg:"#7a2431"}};var G=e=>{const{context:t,x:o,y:r,status:n}=e,{fg:i,bg:s}=I[n];t.save(),t.translate(o,r),t.lineWidth=3,t.strokeStyle=i,t.fillStyle=s,t.beginPath(),t.moveTo(-40,40),t.lineTo(-40,20),t.arc(-20,20,20,l(180),l(270)),t.moveTo(-20,0),t.lineTo(20,0),t.arc(20,20,20,l(270),l(0)),t.lineTo(40,40),t.lineTo(-40,40),t.moveTo(-23,20),t.lineTo(-23,40),t.moveTo(23,20),t.lineTo(23,40),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-15,25,l(0),l(360)),t.fill(),t.stroke(),t.restore()},C=e=>{const{x:t,y:o}=d(e,{row:4,col:5});return kontra.sprite({x:t,y:o,collisionRadius:30,map:e,mapX:4*f,mapY:3*b,direction:"W",update(){({x:this.x,y:this.y,mapX:this.mapX,mapY:this.mapY,direction:this.direction}=_(this))},render(){H(this)}})};const j=Array(20).fill().map(()=>Array(20).fill(0));var _=e=>{let{direction:t,x:o,y:l}=e;const{map:h}=e,{mapX:p,mapY:T}=(({mapX:e,mapY:t,direction:o})=>{switch(o){case r:return{mapX:e,mapY:t-2.5};case n:return{mapX:e+2.5,mapY:t};case i:return{mapX:e,mapY:t+2.5};case s:return{mapX:e-2.5,mapY:t};default:return{mapX:e,mapY:t}}})(e);if((({mapX:e,mapY:t})=>e%f==0&&t%b==0)({mapX:p,mapY:T})){const e=h.tileAtLayer("main",{x:o,y:l}),d=p/f+1,y=T/b+1;if(j[y-1][d-1]=j[y-1][d-1]+1,(e=>g.includes(e))(e)){const{allowed:u}=m[e],g=(({viable:e,visits:t,row:o,col:a})=>{let l=Number.MAX_SAFE_INTEGER;return e.map(e=>{let c;switch(e){case r:c=t[o-2][a-1];break;case n:c=t[o-1][a];break;case i:c=t[o][a-1];break;case s:c=t[o-1][a-2]}return l=c<l?c:l,{dir:e,vis:c}}).filter(({vis:e})=>e===l).map(({dir:e})=>e)})({viable:u.filter(e=>e!==(e=>{switch(e){case r:return i;case n:return s;case i:return r;case s:return s;default:return null}})(t)&&a(h,{x:o,y:l},e)),visits:j,row:y,col:d});t=g[c(0,g.length-1)]}else t=u(h,{x:o,y:l},t)}return({x:o,y:l}=d(h,{x:p,y:T})),{direction:t,mapY:T,mapX:p,x:o,y:l}},H=e=>{const{context:t,x:o,y:r}=e;t.save(),t.translate(o,r),t.lineWidth=3,t.strokeStyle="#cd3926",t.fillStyle="#7a2431",t.beginPath(),t.moveTo(c(-5,5),c(-5,-25)),t.lineTo(c(5,50),c(-5,-50)),t.lineTo(c(5,25),c(-5,5)),t.lineTo(c(5,50),c(5,50)),t.lineTo(c(-5,5),c(5,25)),t.lineTo(c(-5,-50),c(5,50)),t.lineTo(c(-5,-25),c(-5,5)),t.lineTo(c(-5,-50),c(-5,-50)),t.closePath(),t.fill(),t.stroke(),t.restore()},N=(e,{row:t,col:o})=>{const{x:r,y:n}=d(e,{row:t,col:o});return kontra.sprite({x:r,y:n,collisionRadius:30,fuseLength:100,status:z,shrapnel:[],explosionDuration:0,map:e,mapX:(o-1)*f,mapY:(t-1)*b,row:t,col:o,update(){({status:this.status,fuseLength:this.fuseLength,explosionDuration:this.explosionDuration,x:this.x,y:this.y}=q(this))},render(){$(this)}})};const z=0;var $=e=>{const{status:t,shrapnel:o}=e;switch(t){case z:J(e);break;case 1:o.forEach(e=>e.render())}},J=e=>{const{context:t,x:o,y:r,fuseLength:n}=e;t.save(),t.translate(o,r),t.rotate(l(-45)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(23,-10),t.lineTo(40,-10),t.lineTo(40,10),t.lineTo(23,10),t.arc(0,0,25,l(19),l(341)),t.fill(),t.stroke();const i=n/100*90;t.beginPath(),t.moveTo(40,0),t.arc(40,25,25,l(270),l(270+i)),t.stroke();const s=25*Math.cos(l(i-90))+40,a=25*Math.sin(l(i-90))+25;t.fillStyle="#cd3926";for(let e=0;e<10;e++){const e=Math.cos(l(c(0,360)))*c(0,15)+s,o=Math.sin(l(c(0,360)))*c(0,15)+a;t.fillRect(e-1,o-1,3,3)}t.restore()},q=e=>{let{status:t,fuseLength:o,explosionDuration:r,x:n,y:i}=e;const{shrapnel:s,map:a,mapX:l,mapY:c,row:h,col:u}=e;switch(({x:n,y:i}=d(a,{x:l,y:c})),t){case z:if((o-=1)<0){t=1;for(let e=0;e<50;e++)s.push(F({x:n,y:i}));const e=a.tileAtLayer("main",{row:h+3-1,col:u+4-1});a.changeTile("main",{row:h+3,col:u+4},e+24)}break;case 1:s.forEach(e=>e.update()),200===++r&&(t=2)}return{status:t,fuseLength:o,explosionDuration:r,x:n,y:i}},F=({x:e,y:t})=>{const o=c(0,360),r=c(5,15);return kontra.sprite({x:e,y:t,dx:Math.cos(l(o))*r,dy:Math.sin(l(o))*r,rotation:c(0,360),rotationDir:[c(-10,-1),c(1,10)][c(0,1)],update(){this.advance(),this.rotation+=this.rotationDir},render(){(e=>{const{context:t,x:o,y:r,rotation:n}=e;t.save(),t.translate(o,r),t.rotate(l(n)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(0,-10),t.lineTo(10,5),t.lineTo(-10,5),t.closePath(),t.fill(),t.stroke(),t.restore()})(this)}})};(async()=>{const e=new class{constructor(){this.subscribers=[]}subscribe(e,t){this.subscribers.push({message:e,callback:t})}publish(e,t){this.subscribers.forEach(({message:o,callback:r})=>o===e&&r(t))}};(()=>{const e=document.createElement("canvas");e.width=y,e.height=x,e.style.cssText="\n        border: 4px solid #52638a;\n    ",document.getElementById("wrapper").appendChild(e)})(),kontra.init();const t=await X(),o=D(t,e),r=C(t),n=new class{constructor(e,t){this.map=e,this.pubsub=t,this.bombs=[],this.pubsub.subscribe(1,e=>this.dropBomb(e))}dropBomb(e){this.bombs.push(N(this.map,e))}update(){this.bombs=this.bombs.filter(e=>(e.update(),2!==e.status))}render(){this.bombs.forEach(e=>e.render())}}(t,e),i=new class{constructor(e,t){this.map=e,this.pubsub=t,this.users=[],this.gameOver=!1;for(let t=1;t<=26;t++)for(let o=1;o<=28;o++){const r=e.tileAtLayer("main",{row:t,col:o});r>=17&&r<=20&&this.users.push(A({map:e,row:t-3+1,col:o-4+1}))}this.pubsub.subscribe(0,()=>this.gameOver=!0)}update(){this.users.forEach(e=>e.update())}render(){this.users.forEach(e=>e.render())}infect(e,t){const{users:o,pubsub:r,gameOver:n}=this,i=((e,t)=>{const o=[];for(let r=0;r<e.length;r++){const n=e[r];for(let e=0;e<t.length;e++){const r=t[e];h(n,r)&&o.push([n,r])}}return o})(o,e).filter(([e])=>2!==e.status);if(0!==i.length&&(i.forEach(([e])=>e.infect()),!n))return(e=>e.every(e=>2===e.state))(o)?(t.show("all users infected<br>game over"),void r.publish(0)):void t.flash("user infected!")}}(t,e),s=(()=>{const e=document.createElement("div");return e.style.cssText="\nbackground-color: rgba(0,0,0,0);\nfont-size: 3em;\nfont-weight: bold;\nalign-items: center;\njustify-content: center;\ndisplay: flex;\ncolor: rgba(255,255,255,0);\nposition: absolute;\ntop: 0;\nleft:0;\nwidth: 100vw;\nheight: 100vh;\ntext-align: center;\npointer-events: none;\ntransition: background-color 3s ease-out, color 3s ease-out;\ntext-transform: uppercase;\nfont-family: monospace;\n    ",document.getElementById("wrapper").appendChild(e),{show(t){clearTimeout(Y),e.style.transition="3s",e.innerHTML=`<div>${t}</div>`,e.style.backgroundColor="rgba(0,0,0,0.5)",e.style.color="rgba(255,255,255,1)"},flash(t){clearTimeout(Y),e.style.transition="0.5s",e.innerHTML=`<div>${t}</div>`,e.style.color="rgba(255,255,255,1)",Y=setTimeout(()=>{e.style.color="rgba(255,255,255,0)"},500)}}})();w({map:t,player:o,virus:r,users:i,messageBox:s,bombs:n}).start()})()}]);
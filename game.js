!function(e){var t={};function r(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,r),s.l=!0,s.exports}r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(o,s,function(t){return e[t]}.bind(null,s));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);const o="N",s="E",n="S",a="W";var i=(e,{x:t,y:r},o)=>{const s=e.tileAtLayer("main",{x:t,y:r});if(!b(s)||!p[s].allowed.includes(o))return!1;const n=g(e,{x:t,y:r},o);return b(n)},l=e=>e*Math.PI/180,c=(e,t)=>{const r=Math.min(e,t),o=Math.max(e,t);return Math.floor(Math.random()*(o-r+1))+r},d=(e,{row:t,col:r,x:o,y:s})=>{const{tileWidth:n,tileHeight:a,sx:i,sy:l}=e;return{x:(void 0!==o?o:(r-1)*n)-i+f/2+n/2,y:(void 0!==s?s:(t-1)*a)-l+y/2+a/2}},h=(e,t)=>{const r=e.x-t.x,o=e.y-t.y;return Math.sqrt(r*r+o*o)<e.collisionRadius+t.collisionRadius},u=(e,{x:t,y:r},o)=>{const s=e.tileAtLayer("main",{x:t,y:r});if(!b(s))throw new Error("dropped");const n=p[s].change[o]||o;if(i(e,{x:t,y:r},n))return n;const a=p[s].allowed.filter(o=>i(e,{x:t,y:r},o));switch(a.length){case 0:throw new Error("locked in");case 1:return a[0];default:return a[c(0,a.length-1)]}},p={1:{allowed:[n,s],change:{[o]:s,[a]:n}},2:{allowed:[a,n],change:{[o]:a,[s]:n}},3:{allowed:[o,n],change:{}},4:{allowed:[a,o,s],change:{[n]:o}},5:{allowed:[o,s,n],change:{[a]:s}},6:{allowed:[a,s,n],change:{[o]:n}},9:{allowed:[o,s],change:{[n]:s,[a]:o}},10:{allowed:[a,o],change:{[s]:o,[n]:a}},11:{allowed:[a,s],change:{}},12:{allowed:[o,s,n,a],change:{}},13:{allowed:[o,n,a],change:{[s]:a}},14:{allowed:[o,n],change:{}},17:{allowed:[n],change:{[o]:n}},18:{allowed:[a],change:{[s]:a}},19:{allowed:[o],change:{[n]:o}},20:{allowed:[s],change:{[a]:s}},38:{allowed:[o,n],change:{}}};const m=[];for(const[e,{allowed:t}]of Object.entries(p))t.length>2&&m.push(Number(e));var g=(e,{x:t,y:r},i)=>e.tileAtLayer("main",{x:i===s?t+x:i===a?t-x:t,y:i===o?r-w:i===n?r+w:r}),b=e=>e<25||e>30&&e<33||e>37&&e<41||e>44;const f=800,y=600,x=100,w=100;var v=new class{constructor(){this.subscribers=[]}subscribe(e,t){this.subscribers.push({message:e,callback:t})}publish(e,t){this.subscribers.forEach(({message:r,callback:o})=>r===e&&o(t))}};const k=1,T=6,M=7;var S=({map:e,player:t,virus:r,users:i,bombs:l})=>{let c=!0;return v.subscribe(2,()=>c=!1),kontra.gameLoop({update(){r.update(),t.update(),t.infect(r),c&&((e,t)=>{switch(t){case o:e.sy-=5;break;case s:e.sx+=5;break;case n:e.sy+=5;break;case a:e.sx-=5}})(e,t.direction),i.update(),i.infect([r]),l.update()},render(){e.render(),i.render(),l.render(),t.render(),r.render()}})},P=[0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,20,4,11,2,1,4,2,0,0,5,11,6,11,13,0,1,11,12,2,0,0,1,11,10,9,11,13,0,0,3,0,3,0,5,11,13,0,3,3,0,0,3,1,11,6,11,10,0,1,4,2,9,11,13,0,9,11,10,3,0,0,3,3,0,3,0,0,0,3,1,13,0,0,3,0,0,0,0,5,18,0,3,3,0,14,0,1,11,10,3,9,11,6,4,11,6,2,0,3,0,0,3,3,0,3,0,3,0,0,3,0,0,3,0,0,3,3,0,3,0,0,9,13,0,5,11,10,0,0,3,1,11,10,0,0,3,3,0,3,0,0,0,3,0,3,0,0,0,1,4,10,0,0,0,0,3,5,11,4,18,0,1,13,0,5,11,2,0,3,0,1,11,11,11,11,12,10,0,0,0,0,3,3,0,3,0,5,11,13,0,9,11,2,0,0,3,0,0,1,18,0,9,10,0,5,11,10,0,9,11,11,11,12,11,6,10,0,0,3,0,0,0,0,0,3,1,11,2,1,11,11,11,10,0,3,0,1,11,4,18,20,6,6,11,10,3,0,3,3,0,0,0,1,2,9,11,12,11,2,0,0,3,3,0,0,3,0,3,3,1,11,2,3,3,0,0,3,0,3,0,0,5,4,2,0,5,11,10,3,3,0,5,12,4,11,11,13,0,5,18,0,3,0,5,11,12,11,6,10,9,6,10,3,0,0,0,9,11,10,0,20,4,11,13,0,3,0,9,11,11,13,0,9,11,6,11,6,6,11,18,0,0,0,3,0,3,0,0,0,0,5,11,11,2,3,0,3,3,0,0,0,0,0,19,0,19,0,0,0,0,19,0,0,19,9,11,10,19,0,0];function D(e,t){return[Math.cos(l(e))*t+50,Math.sin(l(e))*t+50]}var E=({ctx:e,row:t,col:r,deg:o,broken:s=!1})=>{e.save(),e.translate((r-1)*x+x/2,(t-1)*w+w/2),e.rotate(l(o)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),s?(e.moveTo(20,50),e.arc(50,50,30,l(180),l(190)),e.moveTo(...D(190,30)),e.lineTo(10,45),e.lineTo(10,35),e.lineTo(-10,40),e.lineTo(...D(190,70)),e.arc(50,50,70,l(190),l(180),!0),e.moveTo(50,20),e.arc(50,50,30,l(270),l(260),!0),e.moveTo(...D(260,30)),e.lineTo(40,10),e.lineTo(45,0),e.lineTo(35,0),e.lineTo(...D(260,70)),e.arc(50,50,70,l(260),l(270))):(e.moveTo(20,50),e.arc(50,50,30,l(180),l(270)),e.moveTo(-20,50),e.arc(50,50,70,l(180),l(270))),e.stroke(),e.restore()},W=(e,t)=>t.forEach(([t,r,o])=>e[t?"lineTo":"moveTo"](r,o)),C=({ctx:e,row:t,col:r,deg:o,broken:s=!1})=>{e.save(),e.translate((r-1)*x+x/2,(t-1)*w+w/2),e.rotate(l(o)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),W(e,s?[[0,-20,50],[1,-20,30],[1,-10,40],[1,0,25],[1,10,35],[1,20,30],[1,20,50],[0,-20,-50],[1,-20,-40],[1,-10,-25],[1,0,-35],[1,10,-30],[1,20,-40],[1,20,-50]]:[[0,-20,-50],[1,-20,50],[0,20,-50],[1,20,50]]),e.stroke(),e.restore()},L=({ctx:e,row:t,col:r,deg:o,broken:s=!1})=>{e.save(),e.translate((r-1)*x+x/2,(t-1)*w+w/2),e.rotate(l(o)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),W(e,s?[[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,50,20]]),e.stroke(),e.restore()},O=({ctx:e,row:t,col:r,broken:o=!1})=>{e.save(),e.translate((r-1)*x+x/2,(t-1)*w+w/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),W(e,o?[[0,-20,50],[1,-20,45],[1,-10,40],[1,0,45],[1,10,35],[1,20,40],[1,20,50],[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,-20,20],[1,-20,50],[0,50,20],[1,20,20],[1,20,50]]),e.stroke(),e.restore()},A=({ctx:e,row:t,col:r,broken:o})=>{e.save(),e.translate((r-1)*x+x/2,(t-1)*w+w/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),W(e,[[0,30,-48],[1,48,-30],[1,48,30],[1,30,48],[1,-30,48],[1,-48,30],[1,-48,-30],[1,-30,-48],[1,30,-48]]),e.stroke(),o&&(e.lineWidth=2,W(e,[[0,10,-48],[1,0,-40],[0,24,-48],[1,20,-30],[0,48,-27],[1,20,-20],[0,-10,-30],[1,10,-30],[1,30,-10],[1,20,0],[1,10,0],[0,48,7],[1,30,10],[0,20,0],[1,30,10],[1,10,20],[0,30,48],[1,30,30],[1,10,30],[0,20,20],[1,20,30],[0,-10,48],[1,-10,20],[1,0,10],[0,-20,0],[1,-20,20],[1,-10,30],[0,-30,48],[1,-20,40],[1,-20,30],[0,-30,30],[1,-20,40],[0,-48,20],[1,-30,20],[0,-40,20],[1,-40,10],[0,-48,0],[1,-30,0],[1,-20,-10],[0,-40,0],[1,-30,10],[0,-48,-17],[1,-40,-30],[1,-30,-20],[0,-30,-48],[1,-10,-20],[1,-10,-10],[0,-20,-30],[1,-20,-20],[1,-30,-10]]),e.stroke()),e.restore()},Y=({ctx:e,row:t,col:r,deg:o,broken:s=!1})=>{e.save(),e.translate((r-1)*x+x/2,(t-1)*w+w/2),e.rotate(l(o)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),W(e,s?[[0,-20,50],[1,-20,40],[1,-10,45],[1,0,35],[1,10,45],[1,20,40],[1,20,50]]:[[0,-20,50],[1,-20,0],[1,20,0],[1,20,50]]),e.stroke(),e.restore()},X=(e={})=>{if(!e.width||!e.height)throw Error("You must provide width and height properties");const t=e.width,r=e.height,o=e.tileWidth||32,s=e.tileHeight||32,n=t*o,a=r*s,i=e.context||kontra.context,l=i.canvas.width,c=i.canvas.height,d=document.createElement("canvas"),h=d.getContext("2d"),u=Math.max(0,n-l),p=Math.max(0,a-c);let m,g;const b=[],f={width:t,height:r,tileWidth:o,tileHeight:s,mapWidth:n,mapHeight:a,context:i,x:e.x||0,y:e.y||0,tilesets:[],layers:{},addTilesets:function(e){[].concat(e).forEach(e=>{const t=e.image;let r,n,a,i;if(`${t}`===t){let e=1/0;for(;e>=0;){const o=(e=t.lastIndexOf("/",e))<0?t:t.substr(e);if(kontra.assets.images[o]){r=kontra.assets.images[o];break}e--}}else r=t;n=e.firstGrid;const l=(r.width/o|0||1)*(r.height/s|0||1);n||(f.tilesets.length>0?(i=((a=f.tilesets[f.tilesets.length-1]).image.width/o|0)*(a.image.height/s|0),n=a.firstGrid+i):n=1),f.tilesets.push({firstGrid:n,lastGrid:n+l-1,image:r}),f.tilesets.sort((e,t)=>e.firstGrid-t.firstGrid)})},addLayers:function(e){[].concat(e).forEach(e=>{let r,o,s,n;if(e.render=void 0===e.render||e.render,Array.isArray(e.data[0])){r=[];for(let n=0;o=e.data[n];n++)for(s=0;s<t;s++)r.push(o[s]||0)}else r=e.data;f.layers[e.name]={data:r,zIndex:e.zIndex||0,render:e.render};for(const t in e.properties)if(e.properties.hasOwnProperty(t)){n=e.properties[t];try{n=JSON.parse(n)}catch(e){}f.layers[e.name][t]=n}f.layers[e.name].render&&(b.push(e.name),b.sort((e,t)=>f.layers[e].zIndex-f.layers[t].zIndex))}),function(){for(let e,t=0;e=f.layers[b[t]];t++)for(let t=0,r=e.data.length;t<r;t++)w(e,t)}()},changeTile(e,{row:r,col:o},s){const n=((e,t,r)=>(e-1)*r+t-1)(r,o,t),a=f.layers[e];a.data[n]=s,w(a,n,!0)},layerCollidesWith:function(e,t){const r=f.getRow(t.y),o=f.getCol(t.x),s=f.getRow(t.y+t.height),n=f.getCol(t.x+t.width);let a;for(let t=r;t<=s;t++)for(let r=o;r<=n;r++)if(a=y({row:t,col:r}),f.layers[e].data[a])return!0;return!1},tileAtLayer(e,t){const r=y(t);if(r>=0)return f.layers[e].data[r]},render(){f.context.drawImage(d,f.sx,f.sy,l,c,f.x,f.y,l,c)},renderLayer:function(e){const n=f.layers[e];let a=f.getRow();const i=f.getCol();let d=y({row:a,col:i});const h=i*o-f.sx,u=a*s-f.sy,p=Math.min(Math.ceil(l/o)+1,t),m=p*Math.min(Math.ceil(c/s)+1,r);let g,b,w,v,k,T,M,S,P,D=0;for(;D<m;)(w=n.data[d])&&(k=(v=x(w)).image,g=h+D%p*o,b=u+(D/p|0)*s,S=(T=w-v.firstGrid)%(M=k.width/o)*o,P=(T/M|0)*s,f.context.drawImage(k,S,P,o,s,g,b,o,s)),++D%p==0?d=i+ ++a*t:d++},getRow:e=>(e=e||0,(f.sy+e)/s|0),getCol:e=>(e=e||0,(f.sx+e)/o|0),get sx(){return m},get sy(){return g},set sx(e){m=Math.min(Math.max(0,e),u)},set sy(e){g=Math.min(Math.max(0,e),p)},_layerOrder:b};f.sx=e.sx||0,f.sy=e.sy||0,d.width=n,d.height=a;for(const t in e.properties)if(e.properties.hasOwnProperty(t)){let r=e.properties[t];try{r=JSON.parse(r)}catch(e){}f[t]=f[t]||r}function y(e){let o,s;return void 0!==e.x&&void 0!==e.y?(o=f.getRow(e.y),s=f.getCol(e.x)):(o=e.row,s=e.col),o<0||s<0||o>=r||s>=t?-1:s+o*t}function x(e){let t,r,o=0,s=f.tilesets.length-1;for(;o<=s;){if(t=(o+s)/2|0,e>=(r=f.tilesets[t]).firstGrid&&e<=r.lastGrid)return r;r.lastGrid<e?o=t+1:s=t-1}}function w(e,r,n=!1){const a=e.data[r];if(!a)return;const i=x(a),l=i.image,c=r%t*o,d=(r/t|0)*s,u=a-i.firstGrid,p=l.width/o,m=u%p*o,g=(u/p|0)*s;n&&h.clearRect(c,d,o,s),h.drawImage(l,m,g,o,s,c,d,o,s)}return e.tilesets&&f.addTilesets(e.tilesets),e.layers&&f.addLayers(e.layers),f},R=async()=>{const{sx:e,sy:t}=(({col:e,row:t})=>({sx:(e-1)*x+x/2,sy:(t-1)*w+w/2}))({col:5,row:6}),r=X({tileWidth:x,tileHeight:w,width:28,height:26,sx:e,sy:t}),o=((e,t,r,o,s)=>{const n=[];let a=0;for(let i=0;i<r+2*s;i++)for(let l=0;l<t+2*o;l++)i<s||i>=s+r||l<o||l>=o+t?n.push(0):n.push(e[a++]);return n})(P,20,20,4,3),s=await(()=>{const e=document.createElement("canvas");e.width=8*x,e.height=8*w;const t=e.getContext("2d");E({ctx:t,row:1,col:1,deg:0}),E({ctx:t,row:1,col:2,deg:90}),E({ctx:t,row:2,col:1,deg:270}),E({ctx:t,row:2,col:2,deg:180}),C({ctx:t,row:1,col:3,deg:0}),C({ctx:t,row:2,col:3,deg:90}),L({ctx:t,row:1,col:4,deg:0}),L({ctx:t,row:1,col:5,deg:90}),L({ctx:t,row:1,col:6,deg:180}),L({ctx:t,row:2,col:5,deg:270}),O({ctx:t,row:2,col:4}),Y({ctx:t,row:3,col:1,deg:0}),Y({ctx:t,row:3,col:2,deg:90}),Y({ctx:t,row:3,col:3,deg:180}),Y({ctx:t,row:3,col:4,deg:270}),A({ctx:t,row:2,col:6}),E({ctx:t,row:4,col:1,deg:0,broken:!0}),E({ctx:t,row:4,col:2,deg:90,broken:!0}),E({ctx:t,row:5,col:1,deg:270,broken:!0}),E({ctx:t,row:5,col:2,deg:180,broken:!0}),C({ctx:t,row:4,col:3,deg:0,broken:!0}),C({ctx:t,row:5,col:3,deg:90,broken:!0}),L({ctx:t,row:4,col:4,deg:0,broken:!0}),L({ctx:t,row:4,col:5,deg:90,broken:!0}),L({ctx:t,row:4,col:6,deg:180,broken:!0}),L({ctx:t,row:5,col:5,deg:270,broken:!0}),O({ctx:t,row:5,col:4,broken:!0}),Y({ctx:t,row:6,col:1,deg:0,broken:!0}),Y({ctx:t,row:6,col:2,deg:90,broken:!0}),Y({ctx:t,row:6,col:3,deg:180,broken:!0}),Y({ctx:t,row:6,col:4,deg:270,broken:!0}),A({ctx:t,row:5,col:6,broken:!0});const r=new Image;return r.src=e.toDataURL("image/png"),new Promise(e=>setTimeout(()=>e(r),100))})();return r.addTilesets({image:s}),r.addLayers([{name:"main",data:o},{name:"debug",data:new Array(o.length).fill(0)}]),r};var B=new class{constructor(){this.timeoutHandler=null,this.div=document.createElement("div"),this.div.style.cssText="\nbackground-color: rgba(0,0,0,0);\nfont-size: 3em;\nfont-weight: bold;\nalign-items: center;\njustify-content: center;\ndisplay: flex;\ncolor: rgba(255,255,255,0);\nposition: absolute;\ntop: 0;\nleft:0;\nwidth: 100vw;\nheight: 100vh;\ntext-align: center;\npointer-events: none;\ntransition: background-color 3s ease-out, color 3s ease-out;\ntext-transform: uppercase;\nfont-family: monospace;\n    ",document.getElementById("wrapper").appendChild(this.div)}show(e){clearTimeout(this.timeoutHandler),this.div.style.transition="3s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.backgroundColor="rgba(0,0,0,0.5)",this.div.style.color="rgba(255,255,255,1)"}flash(e){clearTimeout(this.timeoutHandler),this.div.style.transition="0.5s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.color="rgba(255,255,255,1)",this.timeoutHandler=setTimeout(()=>this.div.style.color="rgba(255,255,255,0)",500)}},I=e=>{const t=kontra.sprite({x:f/2,y:y/2,collisionRadius:30,map:e,infected:!1,gameOver:!1,direction:"N",nextDirection:null,dropBomb:!1,scale:1,dropping:!1,bombCoolingDown:!1,update(){({nextDirection:this.nextDirection,direction:this.direction,dropBomb:this.dropBomb,scale:this.scale,bombCoolingDown:this.bombCoolingDown}=_(this,v,B))},render(){G(this)},infect(e){h(e,this)&&(this.infected=!0,this.gameOver||(B.show("player infected<br>game over"),v.publish(0)))}});return v.subscribe(0,()=>t.gameOver=!0),v.subscribe(2,()=>t.dropping=!0),t},G=e=>{const{context:t,x:r,y:i,direction:c,infected:d,scale:h}=e;t.save(),t.translate(r,i),t.scale(h,h),t.rotate((e=>{switch(e){case o:return l(0);case s:return l(90);case n:return l(180);case a:return l(270);default:return null}})(c)),t.lineWidth=3,t.strokeStyle=d?"#cd3926":"#75a042",t.fillStyle=d?"#7a2431":"#365b1d",t.beginPath(),t.moveTo(-15,25),t.lineTo(0,-25),t.lineTo(15,25),t.closePath(),t.fill(),t.stroke(),t.restore()},_=e=>{let{nextDirection:t,direction:r,dropBomb:l,scale:c,bombCoolingDown:d}=e;const{dropping:h}=e;if(h)return c>0?c-=.01:(B.show("You fell into the abyss<br>Game over"),v.publish(0)),{direction:r,nextDirection:t,dropBomb:l,scale:c,bombCoolingDown:d};const{map:p,x:m,y:g,gameOver:b}=e;if(b||(({nextDirection:t,dropBomb:l}=(e=>{let{nextDirection:t,dropBomb:r}=e;return kontra.keys.pressed("right")&&(t=s),kontra.keys.pressed("left")&&(t=a),kontra.keys.pressed("up")&&(t=o),kontra.keys.pressed("down")&&(t=n),kontra.keys.pressed("space")&&(r=!0),{nextDirection:t,dropBomb:r}})(e)),d&&(l=!1)),!(({x:e,y:t})=>(e-x/2)%x==0&&(t-w/2)%w==0)({x:p.sx,y:p.sy}))return{direction:r,nextDirection:t,dropBomb:l,scale:c,bombCoolingDown:d};if(t&&i(p,{x:m,y:g},t))r=t,t=null;else try{r=u(p,{x:m,y:g},r)}catch({message:e}){"dropped"===e&&v.publish(2)}return l&&(v.publish(k,(({sx:e,sy:t,tileWidth:r,tileHeight:o})=>({col:Math.floor(e/r)+1,row:Math.floor(t/o)+1}))(p)),l=!1,d=!0,setTimeout(()=>{e.bombCoolingDown=!1},100)),{direction:r,nextDirection:t,dropBomb:l,scale:c,bombCoolingDown:d}};var H=({map:e,row:t,col:r})=>{const{x:o,y:s}=d(e,{row:t,col:r});return kontra.sprite({x:o,y:s,collisionRadius:30,infected:!1,map:e,mapX:(r-1)*x,mapY:(t-1)*w,status:0,update(){({x:this.x,y:this.y}=d(this.map,{x:this.mapX,y:this.mapY}))},render(){N(this)},infect(){this.status=2,v.publish(M)}})};const j={0:{fg:"#52638a",bg:"#2b3653"},1:{fg:"#75a042",bg:"#365b1d"},2:{fg:"#cd3926",bg:"#7a2431"}};var N=e=>{const{context:t,x:r,y:o,status:s}=e,{fg:n,bg:a}=j[s];t.save(),t.translate(r,o),t.lineWidth=3,t.strokeStyle=n,t.fillStyle=a,t.beginPath(),t.moveTo(-40,40),t.lineTo(-40,20),t.arc(-20,20,20,l(180),l(270)),t.moveTo(-20,0),t.lineTo(20,0),t.arc(20,20,20,l(270),l(0)),t.lineTo(40,40),t.lineTo(-40,40),t.moveTo(-23,20),t.lineTo(-23,40),t.moveTo(23,20),t.lineTo(23,40),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-15,25,l(0),l(360)),t.fill(),t.stroke(),t.restore()},q=e=>{const{x:t,y:r}=d(e,{row:4,col:5}),o=new K,s=kontra.sprite({x:t,y:r,collisionRadius:30,map:e,mapX:4*x,mapY:3*w,direction:"W",blips:o,update(){({x:this.x,y:this.y,mapX:this.mapX,mapY:this.mapY,direction:this.direction}=U(this)),this.blips.update()},render(){J(this),this.blips.render()}});return o.start(s),s};const z=Array(20).fill().map(()=>Array(20).fill(0));var U=e=>{let{direction:t,x:r,y:l}=e;const{map:h}=e,{mapX:g,mapY:b}=(({mapX:e,mapY:t,direction:r})=>{switch(r){case o:return{mapX:e,mapY:t-2.5};case s:return{mapX:e+2.5,mapY:t};case n:return{mapX:e,mapY:t+2.5};case a:return{mapX:e-2.5,mapY:t};default:return{mapX:e,mapY:t}}})(e);if((({mapX:e,mapY:t})=>e%x==0&&t%w==0)({mapX:g,mapY:b})){const e=h.tileAtLayer("main",{x:r,y:l}),d=g/x+1,f=b/w+1;if(z[f-1][d-1]=z[f-1][d-1]+1,(e=>m.includes(e))(e)){const{allowed:u}=p[e],m=(({viable:e,visits:t,row:r,col:i})=>{let l=Number.MAX_SAFE_INTEGER;return e.map(e=>{let c;switch(e){case o:c=t[r-2][i-1];break;case s:c=t[r-1][i];break;case n:c=t[r][i-1];break;case a:c=t[r-1][i-2]}return l=c<l?c:l,{dir:e,vis:c}}).filter(({vis:e})=>e===l).map(({dir:e})=>e)})({viable:u.filter(e=>e!==(e=>{switch(e){case o:return n;case s:return a;case n:return o;case a:return a;default:return null}})(t)&&i(h,{x:r,y:l},e)),visits:z,row:f,col:d});t=m[c(0,m.length-1)]}else t=u(h,{x:r,y:l},t)}return({x:r,y:l}=d(h,{x:g,y:b})),{direction:t,mapY:b,mapX:g,x:r,y:l}},J=e=>{const{context:t,x:r,y:o}=e;t.save(),t.translate(r,o),t.lineWidth=3,t.strokeStyle="#cd3926",t.fillStyle="#7a2431",t.beginPath(),t.moveTo(c(-5,5),c(-5,-25)),t.lineTo(c(5,50),c(-5,-50)),t.lineTo(c(5,25),c(-5,5)),t.lineTo(c(5,50),c(5,50)),t.lineTo(c(-5,5),c(5,25)),t.lineTo(c(-5,-50),c(5,50)),t.lineTo(c(-5,-25),c(-5,5)),t.lineTo(c(-5,-50),c(-5,-50)),t.closePath(),t.fill(),t.stroke(),t.restore()},$=({x:e,y:t})=>kontra.sprite({x:e,y:t,ttl:180,radius:w,update(){this.radius+=10,this.ttl--},render(){F(this)}}),F=e=>{const{context:t,x:r,y:o,radius:s}=e;t.save(),t.translate(r,o),t.lineWidth=1,t.strokeStyle="#cd3926",t.beginPath(),t.arc(0,0,s,l(0),l(360)),t.closePath(),t.stroke(),t.restore()},K=class{constructor(){this.blips=[]}start(e){setInterval(()=>{this.blips.push($({x:e.x,y:e.y}))},1e3)}update(){this.blips.forEach(e=>e.update()),this.blips=this.blips.filter(e=>e.ttl>0)}render(){this.blips.forEach(e=>e.render())}},Q=(e,{row:t,col:r})=>{const{x:o,y:s}=d(e,{row:t,col:r});return kontra.sprite({x:o,y:s,collisionRadius:30,fuseLength:100,status:V,shrapnel:[],explosionDuration:0,map:e,mapX:(r-1)*x,mapY:(t-1)*w,row:t,col:r,update(){({status:this.status,fuseLength:this.fuseLength,explosionDuration:this.explosionDuration,x:this.x,y:this.y}=te(this))},render(){Z(this)}})};const V=0;var Z=e=>{const{status:t,shrapnel:r}=e;switch(t){case V:ee(e);break;case 1:r.forEach(e=>e.render())}},ee=e=>{const{context:t,x:r,y:o,fuseLength:s}=e;t.save(),t.translate(r,o),t.rotate(l(-45)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(23,-10),t.lineTo(40,-10),t.lineTo(40,10),t.lineTo(23,10),t.arc(0,0,25,l(19),l(341)),t.fill(),t.stroke();const n=s/100*90;t.beginPath(),t.moveTo(40,0),t.arc(40,25,25,l(270),l(270+n)),t.stroke();const a=25*Math.cos(l(n-90))+40,i=25*Math.sin(l(n-90))+25;t.fillStyle="#cd3926";for(let e=0;e<10;e++){const e=Math.cos(l(c(0,360)))*c(0,15)+a,r=Math.sin(l(c(0,360)))*c(0,15)+i;t.fillRect(e-1,r-1,3,3)}t.restore()},te=e=>{let{status:t,fuseLength:r,explosionDuration:o,x:s,y:n}=e;const{shrapnel:a,map:i,mapX:l,mapY:c,row:h,col:u}=e;switch(({x:s,y:n}=d(i,{x:l,y:c})),t){case V:if((r-=1)<0){t=1,v.publish(T);for(let e=0;e<50;e++)a.push(re({x:s,y:n}));const e=i.tileAtLayer("main",{row:h+3-1,col:u+4-1});i.changeTile("main",{row:h+3,col:u+4},e+24)}break;case 1:a.forEach(e=>e.update()),200===++o&&(t=2)}return{status:t,fuseLength:r,explosionDuration:o,x:s,y:n}},re=({x:e,y:t})=>{const r=c(0,360),o=c(5,15);return kontra.sprite({x:e,y:t,dx:Math.cos(l(r))*o,dy:Math.sin(l(r))*o,rotation:c(0,360),rotationDir:[c(-10,-1),c(1,10)][c(0,1)],update(){this.advance(),this.rotation+=this.rotationDir},render(){(e=>{const{context:t,x:r,y:o,rotation:s}=e;t.save(),t.translate(r,o),t.rotate(l(s)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(0,-10),t.lineTo(10,5),t.lineTo(-10,5),t.closePath(),t.fill(),t.stroke(),t.restore()})(this)}})};var oe=new function(){var e,t,r,o,s,n,a,i,l,c,d,h;this._params=new function(){this.setSettings=function(e){for(var t=0;t<24;t++)this[String.fromCharCode(97+t)]=e[t]||0;this.c<.01&&(this.c=.01);var r=this.b+this.c+this.e;if(r<.18){var o=.18/r;this.b*=o,this.c*=o,this.e*=o}}},this.reset=function(){var e=this._params;o=100/(e.f*e.f+.001),s=100/(e.g*e.g+.001),n=1-e.h*e.h*e.h*.01,a=-e.i*e.i*e.i*1e-6,e.a||(d=.5-e.n/2,h=5e-5*-e.o),i=e.l>0?1-e.l*e.l*.9:1+e.l*e.l*10,l=0,c=1==e.m?0:(1-e.m)*(1-e.m)*2e4+32},this.totalReset=function(){this.reset();var o=this._params;return e=o.b*o.b*1e5,t=o.c*o.c*1e5,r=o.e*o.e*1e5+10,e+t+r|0},this.synthWave=function(u,p){var m=this._params,g=1!=m.s||m.v,b=m.v*m.v*.1,f=1+3e-4*m.w,y=m.s*m.s*m.s*.1,x=1+1e-4*m.t,w=1!=m.s,v=m.x*m.x,k=m.g,T=m.q||m.r,M=m.r*m.r*m.r*.2,S=m.q*m.q*(m.q<0?-1020:1020),P=m.p?32+((1-m.p)*(1-m.p)*2e4|0):0,D=m.d,E=m.j/2,W=m.k*m.k*.01,C=m.a,L=e,O=1/e,A=1/t,Y=1/r,X=5/(1+m.u*m.u*20)*(.01+y);X>.8&&(X=.8),X=1-X;for(var R,B,I,G,_,H,j=!1,N=0,q=0,z=0,U=0,J=0,$=0,F=0,K=0,Q=0,V=0,Z=new Array(1024),ee=new Array(32),te=Z.length;te--;)Z[te]=0;for(te=ee.length;te--;)ee[te]=2*Math.random()-1;for(te=0;te<p;te++){if(j)return te;if(P&&++Q>=P&&(Q=0,this.reset()),c&&++l>=c&&(c=0,o*=i),(o*=n+=a)>s&&(o=s,k>0&&(j=!0)),B=o,E>0&&(V+=W,B*=1+Math.sin(V)*E),(B|=0)<8&&(B=8),C||((d+=h)<0?d=0:d>.5&&(d=.5)),++q>L)switch(q=0,++N){case 1:L=t;break;case 2:L=r}switch(N){case 0:z=q*O;break;case 1:z=1+2*(1-q*A)*D;break;case 2:z=1-q*Y;break;case 3:z=0,j=!0}T&&((I=0|(S+=M))<0?I=-I:I>1023&&(I=1023)),g&&f&&((b*=f)<1e-5?b=1e-5:b>.1&&(b=.1)),H=0;for(var re=8;re--;){if(++F>=B&&(F%=B,3==C))for(var oe=ee.length;oe--;)ee[oe]=2*Math.random()-1;switch(C){case 0:_=F/B<d?.5:-.5;break;case 1:_=1-F/B*2;break;case 2:_=(_=(G=(G=F/B)>.5?6.28318531*(G-1):6.28318531*G)<0?1.27323954*G+.405284735*G*G:1.27323954*G-.405284735*G*G)<0?.225*(_*-_-_)+_:.225*(_*_-_)+_;break;case 3:_=ee[Math.abs(32*F/B|0)]}g&&(R=$,(y*=x)<0?y=0:y>.1&&(y=.1),w?(J+=(_-$)*y,J*=X):($=_,J=0),U+=($+=J)-R,_=U*=1-b),T&&(Z[K%1024]=_,_+=Z[(K-I+1024)%1024],K++),H+=_}H*=.125*z*v,u[te]=H>=1?32767:H<=-1?-32768:32767*H|0}return p}},se=function(e){oe._params.setSettings(e);var t=oe.totalReset(),r=new Uint8Array(4*((t+1)/2|0)+44),o=2*oe.synthWave(new Uint16Array(r.buffer,44),t),s=new Uint32Array(r.buffer,0,44);s[0]=1179011410,s[1]=o+36,s[2]=1163280727,s[3]=544501094,s[4]=16,s[5]=65537,s[6]=44100,s[7]=88200,s[8]=1048578,s[9]=1635017060,s[10]=o,o+=44;for(var n=0,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i="data:audio/wav;base64,";n<o;n+=3){var l=r[n]<<16|r[n+1]<<8|r[n+2];i+=a[l>>18]+a[l>>12&63]+a[l>>6&63]+a[63&l]}return n-=o,i.slice(0,i.length-n)+"==".slice(0,n)};function ne(){this.sounds={}}ne.prototype.add=function(e,t,r){this.sounds[e]=[],r.forEach(function(r,o){this.sounds[e].push({tick:0,count:t,pool:[]});for(var s=0;s<t;s++){var n=new Audio;n.src=se(r),this.sounds[e][o].pool.push(n)}},this)},ne.prototype.play=function(e){var t=this.sounds[e],r=t.length>1?t[Math.floor(Math.random()*t.length)]:t[0];r.pool[r.tick].play(),r.tick<r.count-1?r.tick++:r.tick=0};var ae=new ne;ae.add("powerup",10,[[2,,.2916,,.2587,.9356,.3909,-.2493,,,,,,.3583,.1617,,,,1,,,.1217,,.5]]),ae.add("damage",3,[[3,,.0138,,.2701,.4935,,-.6881,,,,,,,,,,,1,,,,,.25],[0,,.0639,,.2425,.7582,,-.6217,,,,,,.4039,,,,,1,,,,,.25],[3,,.0948,,.2116,.7188,,-.6372,,,,,,,,,,,1,,,.2236,,.25],[3,,.1606,.5988,.2957,.1157,,-.3921,,,,,,,,,.3225,-.2522,1,,,,,.25],[3,,.1726,.2496,.2116,.0623,,-.2096,,,,,,,,,.2665,-.1459,1,,,,,.25],[3,,.1645,.7236,.3402,.0317,,,,,,,,,,,,,1,,,,,.25]]),(async()=>{(()=>{const e=document.createElement("canvas");e.width=f,e.height=y,e.style.cssText="\n        border: 4px solid #52638a;\n    ",document.getElementById("wrapper").appendChild(e)})(),kontra.init();const e=await R(),t=I(e),r=q(e),o=new class{constructor(e){this.map=e,this.bombs=[],v.subscribe(k,e=>this.dropBomb(e))}dropBomb(e){this.bombs.length>0&&this.bombs.find(({col:t,row:r})=>t===e.col&&r===e.row)||this.bombs.push(Q(this.map,e))}update(){this.bombs=this.bombs.filter(e=>(e.update(),2!==e.status))}render(){this.bombs.forEach(e=>e.render())}}(e),s=new class{constructor(e){this.map=e,this.users=[],this.gameOver=!1;for(let t=1;t<=26;t++)for(let r=1;r<=28;r++){const o=e.tileAtLayer("main",{row:t,col:r});o>=17&&o<=20&&this.users.push(H({map:e,row:t-3+1,col:r-4+1}))}v.subscribe(0,()=>this.gameOver=!0)}update(){this.users.forEach(e=>e.update())}render(){this.users.forEach(e=>e.render())}infect(e){const{users:t,gameOver:r}=this,o=((e,t)=>{const r=[];for(let o=0;o<e.length;o++){const s=e[o];for(let e=0;e<t.length;e++){const o=t[e];h(s,o)&&r.push([s,o])}}return r})(t,e).filter(([e])=>2!==e.status);if(0!==o.length&&(o.forEach(([e])=>e.infect()),!r))return(e=>e.every(e=>2===e.state))(t)?(B.show("all users infected<br>game over"),void v.publish(0)):void B.flash("user infected!")}}(e),n=S({map:e,player:t,virus:r,users:s,bombs:o});v.subscribe(k,()=>ae.play("powerup")),v.subscribe(T,()=>ae.play("damage")),v.subscribe(M,()=>ae.play("damage")),n.start()})()}]);
//# sourceMappingURL=game.js.map
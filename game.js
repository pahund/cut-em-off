!function(){"use strict";const e="N",t="E",o="S",s="W";var r=e=>e*Math.PI/180,n=(e,t)=>{const o=Math.min(e,t),s=Math.max(e,t);return Math.floor(Math.random()*(s-o+1))+o},i=(e,t)=>{const o=[];for(let s=0;s<e.length;s++){const r=e[s];for(let e=0;e<t.length;e++){const s=t[e];a(r,s)&&o.push([r,s])}}return o},a=(e,t)=>{const o=e.x-t.x,s=e.y-t.y;return Math.sqrt(o*o+s*s)<e.collisionRadius+t.collisionRadius},l=e=>e>0&&e<25||e>30&&e<33||e>37&&e<41||e>44,c=(e,{x:t,y:o},s)=>{const r=e.tileAtLayer("main",{x:t,y:o});if(!l(r)||!d[r].allowed.includes(s))return!1;const n=p(e,{x:t,y:o},s);return l(n)},h=(e,{x:t,y:o},s)=>{const r=e.tileAtLayer("main",{x:t,y:o});if(!l(r))throw new Error("dropped");const i=d[r].change[s]||s;if(c(e,{x:t,y:o},i))return i;const a=d[r].allowed.filter(s=>c(e,{x:t,y:o},s));switch(a.length){case 0:throw new Error("locked in");case 1:return a[0];default:return a[n(0,a.length-1)]}},d={1:{allowed:[o,t],change:{[e]:t,[s]:o}},2:{allowed:[s,o],change:{[e]:s,[t]:o}},3:{allowed:[e,o],change:{}},4:{allowed:[s,e,t],change:{[o]:e}},5:{allowed:[e,t,o],change:{[s]:t}},6:{allowed:[s,t,o],change:{[e]:o}},9:{allowed:[e,t],change:{[o]:t,[s]:e}},10:{allowed:[s,e],change:{[t]:e,[o]:s}},11:{allowed:[s,t],change:{}},12:{allowed:[e,t,o,s],change:{}},13:{allowed:[e,o,s],change:{[t]:s}},17:{allowed:[o],change:{[e]:o}},18:{allowed:[s],change:{[t]:s}},19:{allowed:[e],change:{[o]:e}},20:{allowed:[t],change:{[s]:t}},14:{allowed:[e,o],change:{}},38:{allowed:[e,o],change:{}}};const u=[];for(const[e,{allowed:t}]of Object.entries(d))t.length>2&&u.push(Number(e));var p=(r,{x:n,y:i},a)=>r.tileAtLayer("main",{x:a===t?n+m:a===s?n-m:n,y:a===e?i-b:a===o?i+b:i});const f=800,g=600,m=100,b=100,w=1e3;var x=new class{constructor(){this.subscribers=[]}subscribe(e,t){this.subscribers.push({message:e,callback:t})}publish(e,t){this.subscribers.forEach(({message:o,callback:s})=>o===e&&s(t))}};const y=0,k=1,v=6,T=7,M=2;var S=({map:r,player:n,virus:i,users:a,bombs:l})=>{let c=!0;return x.subscribe(M,()=>c=!1),kontra.gameLoop({update(){i.update(),n.update(),n.infect(i),c&&((r,n)=>{switch(n){case e:r.sy-=5;break;case t:r.sx+=5;break;case o:r.sy+=5;break;case s:r.sx-=5}})(r,n.direction),a.update(),a.infect(i),l.update()},render(){r.render(),a.render(),l.render(),n.render(),i.render()}})},A=[0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,0,17,0,0,20,4,11,2,1,4,2,0,0,5,11,6,11,13,0,1,11,12,2,0,0,1,11,10,9,11,13,0,0,3,0,3,0,5,11,13,0,3,3,0,0,3,1,11,6,11,10,0,1,4,2,9,11,13,0,9,11,10,3,0,0,3,3,0,3,0,0,0,3,1,13,0,0,3,0,0,0,0,5,18,0,3,3,0,14,0,1,11,10,3,9,11,6,4,11,6,2,0,3,0,0,3,3,0,3,0,3,0,0,3,0,0,3,0,0,3,3,0,3,0,0,9,13,0,5,11,10,0,0,3,1,11,10,0,0,3,3,0,3,0,0,0,3,0,3,0,0,0,1,4,10,0,0,0,0,3,5,11,4,18,0,1,13,0,5,11,2,0,3,0,1,11,11,11,11,12,10,0,0,0,0,3,3,0,3,0,5,11,13,0,9,11,2,0,0,3,0,0,1,18,0,9,10,0,5,11,10,0,9,11,11,11,12,11,6,10,0,0,3,0,0,0,0,0,3,1,11,2,1,11,11,11,10,0,3,0,1,11,4,18,20,6,6,11,10,3,0,3,3,0,0,0,1,2,9,11,12,11,2,0,0,3,3,0,0,3,0,3,3,1,11,2,3,3,0,0,3,0,3,0,0,5,4,2,0,5,11,10,3,3,0,5,12,4,11,11,13,0,5,18,0,3,0,5,11,12,11,6,10,9,6,10,3,0,0,0,9,11,10,0,20,4,11,13,0,3,0,9,11,11,13,0,9,11,6,11,6,6,11,18,0,0,0,3,0,3,0,0,0,0,5,11,11,2,3,0,3,3,0,0,0,0,0,19,0,19,0,0,0,0,19,0,0,19,9,11,10,19,0,0];function D(e,t){return[Math.cos(r(e))*t+50,Math.sin(r(e))*t+50]}var X=({ctx:e,row:t,col:o,deg:s,broken:n=!1})=>{e.save(),e.translate((o-1)*m+m/2,(t-1)*b+b/2),e.rotate(r(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),n?(e.moveTo(20,50),e.arc(50,50,30,r(180),r(190)),e.moveTo(...D(190,30)),e.lineTo(10,45),e.lineTo(10,35),e.lineTo(-10,40),e.lineTo(...D(190,70)),e.arc(50,50,70,r(190),r(180),!0),e.moveTo(50,20),e.arc(50,50,30,r(270),r(260),!0),e.moveTo(...D(260,30)),e.lineTo(40,10),e.lineTo(45,0),e.lineTo(35,0),e.lineTo(...D(260,70)),e.arc(50,50,70,r(260),r(270))):(e.moveTo(20,50),e.arc(50,50,30,r(180),r(270)),e.moveTo(-20,50),e.arc(50,50,70,r(180),r(270))),e.stroke(),e.restore()},Y=(e,t)=>t.forEach(([t,o,s])=>e[t?"lineTo":"moveTo"](o,s)),C=({ctx:e,row:t,col:o,deg:s,broken:n=!1})=>{e.save(),e.translate((o-1)*m+m/2,(t-1)*b+b/2),e.rotate(r(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),Y(e,n?[[0,-20,50],[1,-20,30],[1,-10,40],[1,0,25],[1,10,35],[1,20,30],[1,20,50],[0,-20,-50],[1,-20,-40],[1,-10,-25],[1,0,-35],[1,10,-30],[1,20,-40],[1,20,-50]]:[[0,-20,-50],[1,-20,50],[0,20,-50],[1,20,50]]),e.stroke(),e.restore()},P=({ctx:e,row:t,col:o,deg:s,broken:n=!1})=>{e.save(),e.translate((o-1)*m+m/2,(t-1)*b+b/2),e.rotate(r(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),Y(e,n?[[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,50,20]]),e.stroke(),e.restore()},E=({ctx:e,row:t,col:o,broken:s=!1})=>{e.save(),e.translate((o-1)*m+m/2,(t-1)*b+b/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),Y(e,s?[[0,-20,50],[1,-20,45],[1,-10,40],[1,0,45],[1,10,35],[1,20,40],[1,20,50],[0,50,20],[1,40,20],[1,45,10],[1,40,-10],[1,45,-20],[1,50,-20],[0,20,-50],[1,20,-35],[1,10,-40],[1,0,-30],[1,-10,-40],[1,-20,-35],[1,-20,-50],[0,-50,-20],[1,-40,-20],[1,-35,-10],[1,-45,0],[1,-30,10],[1,-35,20],[1,-50,20]]:[[0,-20,-50],[1,-20,-20],[1,-50,-20],[0,20,-50],[1,20,-20],[1,50,-20],[0,-50,20],[1,-20,20],[1,-20,50],[0,50,20],[1,20,20],[1,20,50]]),e.stroke(),e.restore()},R=({ctx:e,row:t,col:o,broken:s})=>{e.save(),e.translate((o-1)*m+m/2,(t-1)*b+b/2),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),Y(e,[[0,30,-48],[1,48,-30],[1,48,30],[1,30,48],[1,-30,48],[1,-48,30],[1,-48,-30],[1,-30,-48],[1,30,-48]]),e.stroke(),s&&(e.lineWidth=2,Y(e,[[0,10,-48],[1,0,-40],[0,24,-48],[1,20,-30],[0,48,-27],[1,20,-20],[0,-10,-30],[1,10,-30],[1,30,-10],[1,20,0],[1,10,0],[0,48,7],[1,30,10],[0,20,0],[1,30,10],[1,10,20],[0,30,48],[1,30,30],[1,10,30],[0,20,20],[1,20,30],[0,-10,48],[1,-10,20],[1,0,10],[0,-20,0],[1,-20,20],[1,-10,30],[0,-30,48],[1,-20,40],[1,-20,30],[0,-30,30],[1,-20,40],[0,-48,20],[1,-30,20],[0,-40,20],[1,-40,10],[0,-48,0],[1,-30,0],[1,-20,-10],[0,-40,0],[1,-30,10],[0,-48,-17],[1,-40,-30],[1,-30,-20],[0,-30,-48],[1,-10,-20],[1,-10,-10],[0,-20,-30],[1,-20,-20],[1,-30,-10]]),e.stroke()),e.restore()},L=({ctx:e,row:t,col:o,deg:s,broken:n=!1})=>{e.save(),e.translate((o-1)*m+m/2,(t-1)*b+b/2),e.rotate(r(s)),e.lineWidth=3,e.strokeStyle="#52638a",e.beginPath(),Y(e,n?[[0,-20,50],[1,-20,40],[1,-10,45],[1,0,35],[1,10,45],[1,20,40],[1,20,50]]:[[0,-20,50],[1,-20,0],[1,20,0],[1,20,50]]),e.stroke(),e.restore()},W=(e={})=>{const t=e.width,o=e.height,s=e.tileWidth||32,r=e.tileHeight||32,n=t*s,i=o*r,a=e.context||kontra.context,l=a.canvas.width,c=a.canvas.height,h=document.createElement("canvas"),d=h.getContext("2d"),u=Math.max(0,n-l),p=Math.max(0,i-c);let f,g;const m=[],b={width:t,height:o,tileWidth:s,tileHeight:r,mapWidth:n,mapHeight:i,context:a,x:e.x||0,y:e.y||0,tilesets:[],layers:{},addTilesets:function(e){[].concat(e).forEach(e=>{const t=e.image;let o,n,i,a;if(`${t}`===t){let e=1/0;for(;e>=0;){const s=(e=t.lastIndexOf("/",e))<0?t:t.substr(e);if(kontra.assets.images[s]){o=kontra.assets.images[s];break}e--}}else o=t;n=e.firstGrid;const l=(o.width/s|0||1)*(o.height/r|0||1);n||(b.tilesets.length>0?(a=((i=b.tilesets[b.tilesets.length-1]).image.width/s|0)*(i.image.height/r|0),n=i.firstGrid+a):n=1),b.tilesets.push({firstGrid:n,lastGrid:n+l-1,image:o}),b.tilesets.sort((e,t)=>e.firstGrid-t.firstGrid)})},addLayers:function(e){[].concat(e).forEach(e=>{let o,s,r,n;if(e.render=void 0===e.render||e.render,Array.isArray(e.data[0])){o=[];for(let n=0;s=e.data[n];n++)for(r=0;r<t;r++)o.push(s[r]||0)}else o=e.data;b.layers[e.name]={data:o,zIndex:e.zIndex||0,render:e.render};for(const t in e.properties)if(e.properties.hasOwnProperty(t)){n=e.properties[t];try{n=JSON.parse(n)}catch(e){}b.layers[e.name][t]=n}b.layers[e.name].render&&(m.push(e.name),m.sort((e,t)=>b.layers[e].zIndex-b.layers[t].zIndex))}),function(){for(let e,t=0;e=b.layers[m[t]];t++)for(let t=0,o=e.data.length;t<o;t++)y(e,t)}()},changeTile(e,t,o){const s=w(t),r=b.layers[e];r.data[s]=o,y(r,s,!0)},tileAtLayer(e,t){const o=w(t);if(o>=0)return b.layers[e].data[o]},render(){b.context.drawImage(h,b.sx,b.sy,l,c,b.x,b.y,l,c)},renderLayer:function(e){const n=b.layers[e];let i=b.getRow();const a=b.getCol();let h=w({row:i,col:a});const d=a*s-b.sx,u=i*r-b.sy,p=Math.min(Math.ceil(l/s)+1,t),f=p*Math.min(Math.ceil(c/r)+1,o);let g,m,y,k,v,T,M,S,A,D=0;for(;D<f;)(y=n.data[h])&&(v=(k=x(y)).image,g=d+D%p*s,m=u+(D/p|0)*r,S=(T=y-k.firstGrid)%(M=v.width/s)*s,A=(T/M|0)*r,b.context.drawImage(v,S,A,s,r,g,m,s,r)),++D%p==0?h=a+ ++i*t:h++},getRowAndCol({x:e,y:t}){return{row:this.getRow(t),col:this.getCol(e)}},getXAndY:({row:e,col:t,mapX:o,mapY:n})=>({x:(t?t*s:o)-b.sx+s/2,y:(e?e*r:n)-b.sy+r/2}),getRow:(e=0)=>(b.sy+e)/r|0,getCol:(e=0)=>(b.sx+e)/s|0,get sx(){return f},get sy(){return g},set sx(e){f=Math.min(Math.max(0,e),u)},set sy(e){g=Math.min(Math.max(0,e),p)}};b.sx=e.sx||0,b.sy=e.sy||0,h.width=n,h.height=i;for(const t in e.properties)if(e.properties.hasOwnProperty(t)){let o=e.properties[t];try{o=JSON.parse(o)}catch(e){}b[t]=b[t]||o}function w(e){let s,r;return void 0!==e.x&&void 0!==e.y?(s=b.getRow(e.y),r=b.getCol(e.x)):(s=e.row,r=e.col),s<0||r<0||s>=o||r>=t?-1:r+s*t}function x(e){let t,o,s=0,r=b.tilesets.length-1;for(;s<=r;){if(t=(s+r)/2|0,e>=(o=b.tilesets[t]).firstGrid&&e<=o.lastGrid)return o;o.lastGrid<e?s=t+1:r=t-1}}function y(e,o,n=!1){const i=e.data[o];if(!i)return;const a=x(i),l=a.image,c=o%t*s,h=(o/t|0)*r,u=i-a.firstGrid,p=l.width/s,f=u%p*s,g=(u/p|0)*r;n&&d.clearRect(c,h,s,r),d.drawImage(l,f,g,s,r,c,h,s,r)}return e.tilesets&&b.addTilesets(e.tilesets),e.layers&&b.addLayers(e.layers),b},B=async()=>{const{sx:e,sy:t}=(({col:e,row:t})=>({sx:e*m-f/2+m/2,sy:t*b-g/2+b/2}))({col:8,row:9}),o=W({tileWidth:m,tileHeight:b,width:28,height:28,sx:e,sy:t}),s=((e,t,o,s)=>{const r=[];let n=0;for(let i=0;i<o+2*s;i++)for(let a=0;a<t+2*s;a++)i<s||i>=s+o||a<s||a>=s+t?r.push(0):r.push(e[n++]);return r})(A,20,20,4),r=await(()=>{const e=document.createElement("canvas");e.width=8*m,e.height=8*b;const t=e.getContext("2d");X({ctx:t,row:1,col:1,deg:0}),X({ctx:t,row:1,col:2,deg:90}),X({ctx:t,row:2,col:1,deg:270}),X({ctx:t,row:2,col:2,deg:180}),C({ctx:t,row:1,col:3,deg:0}),C({ctx:t,row:2,col:3,deg:90}),P({ctx:t,row:1,col:4,deg:0}),P({ctx:t,row:1,col:5,deg:90}),P({ctx:t,row:1,col:6,deg:180}),P({ctx:t,row:2,col:5,deg:270}),E({ctx:t,row:2,col:4}),L({ctx:t,row:3,col:1,deg:0}),L({ctx:t,row:3,col:2,deg:90}),L({ctx:t,row:3,col:3,deg:180}),L({ctx:t,row:3,col:4,deg:270}),R({ctx:t,row:2,col:6}),X({ctx:t,row:4,col:1,deg:0,broken:!0}),X({ctx:t,row:4,col:2,deg:90,broken:!0}),X({ctx:t,row:5,col:1,deg:270,broken:!0}),X({ctx:t,row:5,col:2,deg:180,broken:!0}),C({ctx:t,row:4,col:3,deg:0,broken:!0}),C({ctx:t,row:5,col:3,deg:90,broken:!0}),P({ctx:t,row:4,col:4,deg:0,broken:!0}),P({ctx:t,row:4,col:5,deg:90,broken:!0}),P({ctx:t,row:4,col:6,deg:180,broken:!0}),P({ctx:t,row:5,col:5,deg:270,broken:!0}),E({ctx:t,row:5,col:4,broken:!0}),L({ctx:t,row:6,col:1,deg:0,broken:!0}),L({ctx:t,row:6,col:2,deg:90,broken:!0}),L({ctx:t,row:6,col:3,deg:180,broken:!0}),L({ctx:t,row:6,col:4,deg:270,broken:!0}),R({ctx:t,row:5,col:6,broken:!0});const o=new Image;return o.src=e.toDataURL("image/png"),new Promise(e=>setTimeout(()=>e(o),100))})();return o.addTilesets({image:r}),o.addLayers([{name:"main",data:s}]),o};var O=new class{constructor(){this.timeoutHandler=null,this.div=document.createElement("div"),this.div.style.cssText="\nbackground-color: rgba(0,0,0,0);\nfont-size: 3em;\nfont-weight: bold;\nalign-items: center;\njustify-content: center;\ndisplay: flex;\ncolor: rgba(255,255,255,0);\nposition: absolute;\ntop: 0;\nleft:0;\nwidth: 100vw;\nheight: 100vh;\ntext-align: center;\npointer-events: none;\ntransition: background-color 3s ease-out, color 3s ease-out;\ntext-transform: uppercase;\nfont-family: monospace;\n    ",document.getElementById("wrapper").appendChild(this.div)}show(e){clearTimeout(this.timeoutHandler),this.div.style.transition="3s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.backgroundColor="rgba(0,0,0,0.5)",this.div.style.color="rgba(255,255,255,1)"}flash(e){clearTimeout(this.timeoutHandler),this.div.style.transition="0.5s",this.div.innerHTML=`<div>${e}</div>`,this.div.style.color="rgba(255,255,255,1)",this.timeoutHandler=setTimeout(()=>this.div.style.color="rgba(255,255,255,0)",500)}},I=e=>{const t={context:kontra.context,x:f/2,y:g/2,collisionRadius:30,map:e,infected:!1,gameOver:!1,direction:"N",nextDirection:null,dropBomb:!1,scale:1,dropping:!1,bombCoolingDown:!1,update(){({nextDirection:this.nextDirection,direction:this.direction,dropBomb:this.dropBomb,scale:this.scale,bombCoolingDown:this.bombCoolingDown}=H(this,x,O))},render(){G(this)},infect(e){a(e,this)&&(this.infected=!0,this.gameOver||(O.show("player infected<br>game over"),x.publish(y)))}};return x.subscribe(y,()=>t.gameOver=!0),x.subscribe(M,()=>t.dropping=!0),t},G=n=>{const{context:i,x:a,y:l,direction:c,infected:h,scale:d}=n;i.save(),i.translate(a,l),i.scale(d,d),i.rotate((n=>{switch(n){case e:return r(0);case t:return r(90);case o:return r(180);case s:return r(270);default:return null}})(c)),i.lineWidth=3,i.strokeStyle=h?"#cd3926":"#75a042",i.fillStyle=h?"#7a2431":"#365b1d",i.beginPath(),i.moveTo(-15,25),i.lineTo(0,-25),i.lineTo(15,25),i.closePath(),i.fill(),i.stroke(),i.restore()},H=r=>{let{nextDirection:n,direction:i,dropBomb:a,scale:l,bombCoolingDown:d}=r;const{dropping:u,map:p,gameOver:f,x:g,y:w}=r;if(u)return l>0?l-=.01:(O.show("You fell into the abyss<br>Game over"),x.publish(y)),{direction:i,nextDirection:n,dropBomb:a,scale:l,bombCoolingDown:d};if(f||(({nextDirection:n,dropBomb:a}=(r=>{let{nextDirection:n,dropBomb:i}=r;return kontra.keys.pressed("right")&&(n=t),kontra.keys.pressed("left")&&(n=s),kontra.keys.pressed("up")&&(n=e),kontra.keys.pressed("down")&&(n=o),kontra.keys.pressed("space")&&(i=!0),{nextDirection:n,dropBomb:i}})(r)),d&&(a=!1)),!(({x:e,y:t})=>(e-m/2)%m==0&&(t-b/2)%b==0)({x:p.sx,y:p.sy}))return{direction:i,nextDirection:n,dropBomb:a,scale:l,bombCoolingDown:d};if(n&&c(p,{x:g,y:w},n))i=n,n=null;else try{i=h(p,{x:g,y:w},i)}catch({message:e}){"dropped"===e&&x.publish(M)}return a&&(x.publish(k,p.getRowAndCol({x:g,y:w})),a=!1,d=!0,setTimeout(()=>{r.bombCoolingDown=!1},100)),{direction:i,nextDirection:n,dropBomb:a,scale:l,bombCoolingDown:d}},N=(e,t)=>{const o=[];let s=t;for(;void 0!==s;)o.push(s),s=e.get(s);return o.reverse(),o},$=(e,t)=>{let o=t.shift();const s=[];let r,n,i;for(;t.length;){if(r=t.shift(),!(n=z(e,o,r)))return null;if(i=N(n,r),!t.length)return s.concat(i);s.push.apply(s,i.slice(0,-1)),o=r}return null},z=(e,t,o)=>{const s=new Map([[t,0]]),r=new Map([[0,[t]]]),n=new Map;function i(e,t){let o=r.get(e);o||(o=[],r.set(e,o)),o.push(t)}for(;r.size>0;){const t=Array.from(r.keys()).sort((e,t)=>e-t)[0],o=r.get(t),a=o.shift(),l=e.get(a)||new Map;0===o.length&&r.delete(t);for(const[e,o]of l){const r=o+t,l=s.get(e);(void 0===l||l>r)&&(s.set(e,r),i(r,e),n.set(e,a))}}return void 0===s.get(o)?null:n},_=({width:r,layers:n},i)=>{const{graph:a,allowed:l}=j(n[i].data,r);for(const[r,n]of a){const i=l.get(r),{row:c,col:h}=r;let d;for(const r of i)switch(r){case e:(d=q(a,{row:c-1,col:h}))&&n.set(d,1);break;case t:(d=q(a,{row:c,col:h+1}))&&n.set(d,1);break;case o:(d=q(a,{row:c+1,col:h}))&&n.set(d,1);break;case s:(d=q(a,{row:c,col:h-1}))&&n.set(d,1)}}return a},q=(e,{row:t,col:o})=>{for(const[s]of e)if(t===s.row&&o===s.col)return s;return null},j=(e,t)=>{const o=new Map,s=new Map;let r=0,n=0,i=0;for(const a of e){if(l(a)){const e={row:r,col:n};s.set(e,d[a].allowed),o.set(e,new Map)}++i%t==0?(r++,n=0):n++}return{graph:o,allowed:s}};var F=new class{constructor(e=null){this.graph=e}setDataFromMap(e,t){this.graph=_(e,t)}getNodeByCoords(e){return q(this.graph,e)}findShortestPath(...e){return $(this.graph,e)}isReachable(e,t){return null!==this.findShortestPathByCoords(e,t)}findShortestPathByCoords(...e){return this.findShortestPath(...e.map(e=>this.getNodeByCoords(e)))}};var U=({map:e,row:t,col:o})=>{const{x:s,y:r}=e.getXAndY({row:t,col:o});return{context:kontra.context,x:s,y:r,collisionRadius:30,infected:!1,map:e,mapX:o*m,mapY:t*b,row:t,col:o,status:J,update(){({x:this.x,y:this.y}=e.getXAndY({mapX:this.mapX,mapY:this.mapY}))},render(){Z(this)},infect(){this.status=Q,x.publish(T)}}};const J=0,K=1,Q=2,V={[J]:{fg:"#52638a",bg:"#2b3653"},[K]:{fg:"#75a042",bg:"#365b1d"},[Q]:{fg:"#cd3926",bg:"#7a2431"}};var Z=e=>{const{context:t,x:o,y:s,status:n}=e,{fg:i,bg:a}=V[n];t.save(),t.translate(o,s),t.lineWidth=3,t.strokeStyle=i,t.fillStyle=a,t.beginPath(),t.moveTo(-40,40),t.lineTo(-40,20),t.arc(-20,20,20,r(180),r(270)),t.moveTo(-20,0),t.lineTo(20,0),t.arc(20,20,20,r(270),r(0)),t.lineTo(40,40),t.lineTo(-40,40),t.moveTo(-23,20),t.lineTo(-23,40),t.moveTo(23,20),t.lineTo(23,40),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-15,25,r(0),r(360)),t.fill(),t.stroke(),t.restore()},ee=e=>{const{x:t,y:o}=e.getXAndY({row:7,col:8}),s=new class{constructor(){this.blips=[]}start(e){setInterval(()=>{this.blips.push(re({x:e.x,y:e.y}))},w)}update(){this.blips.forEach(e=>e.update()),this.blips=this.blips.filter(e=>e.ttl>0)}render(){this.blips.forEach(e=>e.render())}},r={context:kontra.context,x:t,y:o,collisionRadius:30,map:e,mapX:8*m,mapY:7*b,direction:"W",blips:s,update(){({x:this.x,y:this.y,mapX:this.mapX,mapY:this.mapY,direction:this.direction}=oe(this)),this.blips.update()},render(){se(this),this.blips.render()}};return s.start(r),r};let te=null;var oe=r=>{let{direction:i}=r;const{map:a}=r,{mapX:l,mapY:p}=(({mapX:r,mapY:n,direction:i})=>{switch(i){case e:return{mapX:r,mapY:n-2.5};case t:return{mapX:r+2.5,mapY:n};case o:return{mapX:r,mapY:n+2.5};case s:return{mapX:r-2.5,mapY:n};default:return{mapX:r,mapY:n}}})(r),{x:f,y:g}=a.getXAndY({mapX:l,mapY:p});if(te||(te=Array(a.height).fill().map(()=>Array(a.width).fill(0))),(({mapX:e,mapY:t})=>e%m==0&&t%b==0)({mapX:l,mapY:p})){const r=a.tileAtLayer("main",{x:f,y:g}),{col:l,row:p}=a.getRowAndCol({x:f,y:g});if(te[p][l]++,(e=>u.includes(e))(r)){const{allowed:h}=d[r],u=(({viable:r,visits:n,row:i,col:a})=>{let l=Number.MAX_SAFE_INTEGER;return r.map(r=>{let c;switch(r){case e:c=n[i-1][a];break;case t:c=n[i][a+1];break;case o:c=n[i+1][a];break;case s:c=n[i][a-1]}return l=c<l?c:l,{dir:r,vis:c}}).filter(({vis:e})=>e===l).map(({dir:e})=>e)})({viable:h.filter(r=>r!==(r=>{switch(r){case e:return o;case t:return s;case o:return e;case s:return s;default:return null}})(i)&&c(a,{x:f,y:g},r)),visits:te,row:p,col:l});i=u[n(0,u.length-1)]}else i=h(a,{x:f,y:g},i)}return{direction:i,mapY:p,mapX:l,x:f,y:g}},se=e=>{const{context:t,x:o,y:s}=e;t.save(),t.translate(o,s),t.lineWidth=3,t.strokeStyle="#cd3926",t.fillStyle="#7a2431",t.beginPath(),t.moveTo(n(-5,5),n(-5,-25)),t.lineTo(n(5,50),n(-5,-50)),t.lineTo(n(5,25),n(-5,5)),t.lineTo(n(5,50),n(5,50)),t.lineTo(n(-5,5),n(5,25)),t.lineTo(n(-5,-50),n(5,50)),t.lineTo(n(-5,-25),n(-5,5)),t.lineTo(n(-5,-50),n(-5,-50)),t.closePath(),t.fill(),t.stroke(),t.restore()},re=({x:e,y:t})=>({context:kontra.context,x:e,y:t,ttl:180,radius:b,update(){this.radius+=10,this.ttl--},render(){ne(this)}}),ne=e=>{const{context:t,x:o,y:s,radius:n}=e;t.save(),t.translate(o,s),t.lineWidth=1,t.strokeStyle="#cd3926",t.beginPath(),t.arc(0,0,n,r(0),r(360)),t.closePath(),t.stroke(),t.restore()};var ie=(e,{row:t,col:o})=>{const{x:s,y:r}=e.getXAndY({row:t,col:o});return{context:kontra.context,x:s,y:r,collisionRadius:30,fuseLength:100,status:ae,shrapnel:[],explosionDuration:0,map:e,mapX:o*m,mapY:t*b,row:t,col:o,update(){({status:this.status,fuseLength:this.fuseLength,explosionDuration:this.explosionDuration,x:this.x,y:this.y}=de(this))},render(){ce(this)}}};const ae=0,le=2;var ce=e=>{const{status:t,shrapnel:o}=e;switch(t){case ae:he(e);break;case 1:o.forEach(e=>e.render())}},he=e=>{const{context:t,x:o,y:s,fuseLength:i}=e;t.save(),t.translate(o,s),t.rotate(r(-45)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(23,-10),t.lineTo(40,-10),t.lineTo(40,10),t.lineTo(23,10),t.arc(0,0,25,r(19),r(341)),t.fill(),t.stroke();const a=i/100*90;t.beginPath(),t.moveTo(40,0),t.arc(40,25,25,r(270),r(270+a)),t.stroke();const l=25*Math.cos(r(a-90))+40,c=25*Math.sin(r(a-90))+25;t.fillStyle="#cd3926";for(let e=0;e<10;e++){const e=Math.cos(r(n(0,360)))*n(0,15)+l,o=Math.sin(r(n(0,360)))*n(0,15)+c;t.fillRect(e-1,o-1,3,3)}t.restore()},de=e=>{let{status:t,fuseLength:o,explosionDuration:s,x:r,y:n}=e;const{shrapnel:i,map:a,mapX:l,mapY:c,row:h,col:d}=e;switch(({x:r,y:n}=a.getXAndY({mapX:l,mapY:c})),t){case ae:if((o-=1)<0){t=1,x.publish(v);for(let e=0;e<50;e++)i.push(ue({x:r,y:n}));const e=a.tileAtLayer("main",{row:h,col:d});a.changeTile("main",{row:h,col:d},e+24),x.publish(3,a),x.publish(4)}break;case 1:i.forEach(e=>e.update()),200===++s&&(t=le)}return{status:t,fuseLength:o,explosionDuration:s,x:r,y:n}},ue=({x:e,y:t})=>{const o=n(0,360),s=n(5,15);return{context:kontra.context,x:e,y:t,dx:Math.cos(r(o))*s,dy:Math.sin(r(o))*s,rotation:n(0,360),rotationDir:[n(-10,-1),n(1,10)][n(0,1)],update(){this.x+=this.dx,this.y+=this.dy,this.rotation+=this.rotationDir},render(){(e=>{const{context:t,x:o,y:s,rotation:n}=e;t.save(),t.translate(o,s),t.rotate(r(n)),t.lineWidth=3,t.strokeStyle="#52638a",t.fillStyle="#2b3653",t.beginPath(),t.moveTo(0,-10),t.lineTo(10,5),t.lineTo(-10,5),t.closePath(),t.fill(),t.stroke(),t.restore()})(this)}}};const pe=new function(){let e,t,o,s,r,n,i,a,l,c,h,d;this._params=new function(){this.setSettings=function(e){for(let t=0;t<24;t++)this[String.fromCharCode(97+t)]=e[t]||0;this.c<.01&&(this.c=.01);const t=this.b+this.c+this.e;if(t<.18){const e=.18/t;this.b*=e,this.c*=e,this.e*=e}}},this.reset=function(){const e=this._params;s=100/(e.f*e.f+.001),r=100/(e.g*e.g+.001),n=1-e.h*e.h*e.h*.01,i=-e.i*e.i*e.i*1e-6,e.a||(h=.5-e.n/2,d=5e-5*-e.o),a=e.l>0?1-e.l*e.l*.9:1+e.l*e.l*10,l=0,c=1==e.m?0:(1-e.m)*(1-e.m)*2e4+32},this.totalReset=function(){this.reset();const s=this._params;return e=s.b*s.b*1e5,t=s.c*s.c*1e5,o=s.e*s.e*1e5+10,e+t+o|0},this.synthWave=function(u,p){const f=this._params,g=1!=f.s||f.v;let m=f.v*f.v*.1;const b=1+3e-4*f.w;let w=f.s*f.s*f.s*.1;const x=1+1e-4*f.t,y=1!=f.s,k=f.x*f.x,v=f.g,T=f.q||f.r,M=f.r*f.r*f.r*.2;let S=f.q*f.q*(f.q<0?-1020:1020);const A=f.p?32+((1-f.p)*(1-f.p)*2e4|0):0,D=f.d,X=f.j/2,Y=f.k*f.k*.01,C=f.a;let P=e;const E=1/e,R=1/t,L=1/o;let W=5/(1+f.u*f.u*20)*(.01+w);W>.8&&(W=.8),W=1-W;let B,O,I,G,H=!1,N=0,$=0,z=0,_=0,q=0,j=0,F=0,U=0,J=0;var K,Q;let V=0;const Z=new Array(1024),ee=new Array(32);for(var te=Z.length;te--;)Z[te]=0;for(te=ee.length;te--;)ee[te]=2*Math.random()-1;for(te=0;te<p;te++){if(H)return te;if(A&&++J>=A&&(J=0,this.reset()),c&&++l>=c&&(c=0,s*=a),(s*=n+=i)>r&&(s=r,v>0&&(H=!0)),O=s,X>0&&(V+=Y,O*=1+Math.sin(V)*X),(O|=0)<8&&(O=8),C||((h+=d)<0?h=0:h>.5&&(h=.5)),++$>P)switch($=0,++N){case 1:P=t;break;case 2:P=o}switch(N){case 0:z=$*E;break;case 1:z=1+2*(1-$*R)*D;break;case 2:z=1-$*L;break;case 3:z=0,H=!0}T&&((I=0|(S+=M))<0?I=-I:I>1023&&(I=1023)),g&&b&&((m*=b)<1e-5?m=1e-5:m>.1&&(m=.1)),Q=0;for(let e=8;e--;){if(++F>=O&&(F%=O,3==C))for(let e=ee.length;e--;)ee[e]=2*Math.random()-1;switch(C){case 0:K=F/O<h?.5:-.5;break;case 1:K=1-F/O*2;break;case 2:K=(K=(G=(G=F/O)>.5?6.28318531*(G-1):6.28318531*G)<0?1.27323954*G+.405284735*G*G:1.27323954*G-.405284735*G*G)<0?.225*(K*-K-K)+K:.225*(K*K-K)+K;break;case 3:K=ee[Math.abs(32*F/O|0)]}g&&(B=j,(w*=x)<0?w=0:w>.1&&(w=.1),y?(q+=(K-j)*w,q*=W):(j=K,q=0),_+=(j+=q)-B,K=_*=1-m),T&&(Z[U%1024]=K,K+=Z[(U-I+1024)%1024],U++),Q+=K}Q*=.125*z*k,u[te]=Q>=1?32767:Q<=-1?-32768:32767*Q|0}return p}};function fe(e){pe._params.setSettings(e);const t=pe.totalReset(),o=new Uint8Array(4*((t+1)/2|0)+44);let s=2*pe.synthWave(new Uint16Array(o.buffer,44),t);const r=new Uint32Array(o.buffer,0,44);r[0]=1179011410,r[1]=s+36,r[2]=1163280727,r[3]=544501094,r[4]=16,r[5]=65537,r[6]=44100,r[7]=88200,r[8]=1048578,r[9]=1635017060,r[10]=s,s+=44;let n=0;const i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";let a="data:audio/wav;base64,";for(;n<s;n+=3){const e=o[n]<<16|o[n+1]<<8|o[n+2];a+=i[e>>18]+i[e>>12&63]+i[e>>6&63]+i[63&e]}return n-=s,a.slice(0,a.length-n)+"==".slice(0,n)}function ge(){var e;this.sounds={},(e=this).add("infected",3,[[2,,.2916,,.2587,.9356,.3909,-.2493,,,,,,.3583,.1617,,,,1,,,.1217,,.5]]),e.add("drop-bomb",3,[[0,,.0641,.5296,.1228,.4195,,,,,,.3029,.6261,,,,,,1,,,,,.5]]),e.add("drop-ship",1,[[0,,.57,,.1398,.61,,-.26,.1,,,.02,,.3325,,,,,.9793,,,,,.5]]),e.add("explode",3,[[3,,.1606,.5988,.2957,.1157,,-.3921,,,,,,,,,.3225,-.2522,1,,,,,.25]])}ge.prototype.add=function(e,t,o){this.sounds[e]=[],o.forEach(function(o,s){this.sounds[e].push({tick:0,count:t,pool:[]});for(let r=0;r<t;r++){const t=new Audio;t.src=fe(o),this.sounds[e][s].pool.push(t)}},this)},ge.prototype.play=function(e){const t=this.sounds[e],o=t.length>1?t[Math.floor(Math.random()*t.length)]:t[0];o.pool[o.tick].play(),o.tick<o.count-1?o.tick++:o.tick=0};const me=new ge;(async()=>{(()=>{const e=document.createElement("canvas");e.width=f,e.height=g,e.style.cssText="\n        border: 4px solid #52638a;\n    ",document.getElementById("wrapper").appendChild(e)})(),kontra.init();const e=await B();(e=>{F.setDataFromMap(e,"main"),x.subscribe(3,e=>F.setDataFromMap(e,"main"))})(e);const t=I(e),o=ee(e),s=new class{constructor(e){this.map=e,this.bombs=[],x.subscribe(k,e=>this.dropBomb(e))}dropBomb(e){this.bombs.length>0&&this.bombs.find(({col:t,row:o})=>t===e.col&&o===e.row)||this.bombs.push(ie(this.map,e))}update(){this.bombs=this.bombs.filter(e=>(e.update(),e.status!==le))}render(){this.bombs.forEach(e=>e.render())}}(e),r=new class{constructor(e){this.map=e,this.users=[],this.gameOver=!1;for(let t=0;t<e.height;t++)for(let o=0;o<e.width;o++){const s=e.tileAtLayer("main",{row:t,col:o});s>=17&&s<=20&&this.users.push(U({map:e,row:t,col:o}))}x.subscribe(y,()=>this.gameOver=!0)}updateOnlineStatus(...e){const t=e.map(e=>({...e,...this.map.getRowAndCol({x:e.x,y:e.y})}));let o=0;for(const e of this.users.filter(({status:e})=>e===J))for(const s of t)F.isReachable(e,s)||(o++,e.status=K);if(o>0){const{online:e,offline:t,infected:o}=this.getStats();0===e?(O.show(`level completed<br>offline users: ${t}<br>infected users: ${o}`),x.publish(y)):O.flash(`${t} users went offline<br>good job!`)}}getStats(){return this.users.reduce((e,{status:t})=>({online:e.online+(t===J?1:0),offline:e.offline+(t===K?1:0),infected:e.infected+(t===Q?1:0)}),{online:0,offline:0,infected:0})}update(){this.users.forEach(e=>e.update())}render(){this.users.forEach(e=>e.render())}infect(...e){const{users:t,gameOver:o}=this,s=i(t,e).filter(([e])=>e.status!==Q);if(0===s.length)return;if(s.forEach(([e])=>e.infect()),o)return;const{online:r,offline:n,infected:a}=this.getStats();if(0===r)return O.show(`level completed<br>offline users: ${n}<br>infected users: ${a}`),void x.publish(y);O.flash("user infected!")}}(e);x.subscribe(4,()=>r.updateOnlineStatus(o));const n=S({map:e,player:t,virus:o,users:r,bombs:s});x.subscribe(k,()=>me.play("drop-bomb")),x.subscribe(k,()=>console.log("drop bomb")),x.subscribe(v,()=>me.play("explode")),x.subscribe(T,()=>me.play("infected")),x.subscribe(M,()=>me.play("drop-ship")),n.start()})()}();
//# sourceMappingURL=game.js.map